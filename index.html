<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https: wss:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://accounts.google.com https://accounts.youtube.com https://apis.google.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://accounts.google.com; style-src-elem 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://accounts.google.com; font-src 'self' https://cdnjs.cloudflare.com https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' https: wss: ws: https://accounts.google.com https://www.googleapis.com; worker-src 'self' blob:; object-src 'none'; media-src 'self' data: blob:; frame-src 'self' https://accounts.google.com https://accounts.youtube.com https://content.googleapis.com; frame-ancestors 'self';">">
    <title data-i18n="app.title">MIC Browser Ultimate - The Future of Web Automation</title>
    <!-- Preload Font Awesome to prevent layout shift -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"></noscript>
    
    <!-- Crash Analytics Dashboard Styles -->
    <link rel="stylesheet" href="CrashAnalyticsDashboard.css">
    
    <!-- TEMPORARILY DISABLED: <script src="emergency-error-fix.js"></script> -->
    <script src="PageAnalyzer.js"></script>
    <script src="client-i18n.js"></script>
    <script src="chrome-signin-helper.js"></script>
    <style>
        :root {
            /* Theme-aware color properties (will be updated by ThemeManager) */
            --theme-background: #0a0a0a;
            --theme-surface: #1a1a2e;
            --theme-primary: #667eea;
            --theme-text: #e0e0e0;
            --theme-secondary: #a0a0a0;
            --theme-accent: #3b82f6;
            --theme-success: #10b981;
            --theme-warning: #f59e0b;
            --theme-danger: #ef4444;

            /* Legacy variables (for backwards compatibility) */
            --primary-gradient: linear-gradient(135deg, var(--theme-primary) 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, var(--theme-success) 0%, #06b6d4 100%);
            --warning-gradient: linear-gradient(135deg, var(--theme-warning) 0%, #d97706 100%);
            --danger-gradient: linear-gradient(135deg, var(--theme-danger) 0%, #dc2626 100%);
            --dark-bg: var(--theme-background);
            --dark-surface: var(--theme-surface);
            --dark-elevated: #16213e;
            --dark-border: #2a2a3e;
            --text-primary: var(--theme-text);
            --text-secondary: var(--theme-secondary);
            --accent-blue: var(--theme-accent);
            --accent-green: var(--theme-success);
            --accent-purple: #8b5cf6;
            --accent-orange: var(--theme-warning);

            /* Theme-specific variations */
            --surface-hover: color-mix(in srgb, var(--theme-surface) 80%, var(--theme-primary) 20%);
            --border-color: color-mix(in srgb, var(--theme-surface) 60%, var(--theme-text) 40%);
            --text-muted: color-mix(in srgb, var(--theme-text) 60%, var(--theme-surface) 40%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Prevent layout shift from Font Awesome icons */
        .fas, .far, .fab {
            display: inline-block;
            width: 1em;
            text-align: center;
        }

        /* Ensure icons don't cause layout shift before loading */
        .fas:before, .far:before, .fab:before {
            content: '';
            width: 1em;
            height: 1em;
            display: inline-block;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', Arial, sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Prevent layout shift during page load */
            contain: layout style;
        }

        /* System Status Bar */
        .system-status-bar {
            height: 24px;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            font-size: 11px;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--dark-border);
        }

        .status-left {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .status-dot.warning {
            background: var(--accent-orange);
        }

        .status-dot.error {
            background: #ef4444;
        }

        /* Enhanced Browser Header */
        .browser-header {
            background: var(--primary-gradient);
            border-bottom: 1px solid var(--dark-border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            /* Prevent layout shift by ensuring consistent dimensions */
            min-height: 120px;
            contain: layout style;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            /* Prevent layout shift */
            min-height: 60px;
            contain: layout;
        }

        .nav-section {
            display: flex;
            gap: 6px;
        }

        .nav-btn, .ai-btn {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .nav-btn:hover:not(:disabled), .ai-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ai-btn {
            background: var(--success-gradient);
            position: relative;
            overflow: hidden;
        }

        .ai-btn.active {
            animation: aiPulse 2s infinite;
        }

        @keyframes aiPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(74,222,128,0.4); }
            50% { box-shadow: 0 0 0 15px rgba(74,222,128,0); }
        }

        /* Deep Link Styles */
        .deeplink-settings {
            margin-bottom: 25px;
        }

        .deeplink-status {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            color: white;
        }

        .protocol-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .protocol-indicator {
            font-size: 20px;
        }

        .deeplink-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }

        .deeplink-testing {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .url-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .url-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }

        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .test-result {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }

        .test-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .deeplink-history {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .history-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .history-list {
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            background: white;
            border-radius: 5px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .history-item.failed {
            border-left-color: #dc3545;
        }

        .history-url {
            font-family: monospace;
            font-size: 12px;
            color: #495057;
            margin-bottom: 5px;
        }

        .history-time {
            font-size: 11px;
            color: #6c757d;
            float: right;
        }

        .history-action {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 3px;
        }

        .history-status {
            font-size: 11px;
            font-weight: bold;
        }

        .history-item.success .history-status {
            color: #28a745;
        }

        .history-item.failed .history-status {
            color: #dc3545;
        }

        .deeplink-security {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
        }

        .security-rules {
            margin-top: 15px;
        }

        .rule-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .rule-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }

        .rules-list {
            background: white;
            border-radius: 5px;
            padding: 15px;
            min-height: 50px;
        }

        .no-data {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            margin: 20px 0;
        }

        .info-text {
            color: #856404;
            font-size: 14px;
            margin: 0;
        }

        .deeplink-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .config-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .config-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .url-length-setting {
            margin-top: 15px;
        }

        .url-length-setting label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }

        .url-length-setting input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .url-container {
            flex: 1;
            position: relative;
            max-width: 800px;
            margin: 0 20px;
        }

        .url-bar {
            width: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px 50px 10px 16px;
            border-radius: 24px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .url-bar:focus {
            outline: none;
            border-color: rgba(255,255,255,0.4);
            background: rgba(0,0,0,0.5);
            box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
        }

        .url-indicators {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ssl-indicator, .ai-indicator, .sync-indicator {
            font-size: 14px;
        }

        .ssl-indicator {
            color: var(--accent-green);
        }

        .ai-indicator {
            color: var(--accent-purple);
            cursor: pointer;
        }

        .sync-indicator {
            color: var(--accent-blue);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            /* Prevent layout shift */
            align-items: center;
            min-height: 36px;
        }

        .action-btn {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .action-btn.primary {
            background: var(--success-gradient);
        }

        .action-btn.voice {
            background: var(--accent-purple);
        }

        .action-btn.transfer {
            background: var(--accent-purple);
        }
        
        .action-btn.analytics {
            background: var(--accent-orange);
        }

        /* Enhanced Tab System */
        /* Enhanced Tab Container */
        .tab-container {
            background: rgba(0,0,0,0.2);
            padding: 4px 8px 0;
            overflow-x: auto;
            scrollbar-width: none;
            display: flex;
            position: relative;
            border-bottom: 1px solid var(--dark-border);
            /* Prevent layout shift during tab operations */
            min-height: 48px;
            max-height: 48px;
            align-items: flex-start;
        }

        .tab-container::-webkit-scrollbar {
            display: none;
        }

        .tabs-wrapper {
            display: flex;
            gap: 2px;
            min-width: max-content;
            position: relative;
        }

        .tab {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-bottom: none;
            color: var(--text-secondary);
            padding: 12px 16px;
            border-radius: 12px 12px 0 0;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 140px;
            max-width: 280px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-blue);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .tab.active {
            background: var(--dark-surface);
            border-color: var(--accent-blue);
            color: white;
            box-shadow: 0 4px 20px rgba(59,130,246,0.2);
            z-index: 10;
        }

        .tab.active::before {
            transform: scaleX(1);
        }

        .tab:hover:not(.active) {
            background: rgba(255,255,255,0.08);
            transform: translateY(-2px);
            border-color: rgba(255,255,255,0.2);
        }

        .tab.dragging {
            opacity: 0.6;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .tab.pinned {
            min-width: 48px;
            max-width: 48px;
            padding: 12px;
        }

        .tab.pinned .tab-title {
            display: none;
        }

        .tab.pinned .tab-close {
            display: none;
        }

        .tab-favicon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            border-radius: 3px;
            transition: transform 0.2s ease;
        }

        .tab.loading .tab-favicon {
            animation: spin 1s linear infinite;
        }

        .tab-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
            font-weight: 500;
            transition: opacity 0.2s ease;
        }

        .tab-indicators {
            display: flex;
            gap: 4px;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .tab:hover .tab-indicators,
        .tab.active .tab-indicators {
            opacity: 1;
        }

        .tab-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .tab-indicator.loading {
            background: var(--accent-orange);
            animation: pulse 1.5s infinite;
        }

        .tab-indicator.secure {
            background: var(--accent-green);
        }

        .tab-indicator.ai-active {
            background: var(--accent-purple);
        }

        .tab-indicator.audio {
            background: var(--accent-blue);
            animation: audioWave 1s ease-in-out infinite alternate;
        }

        .tab-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-secondary);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            opacity: 0;
        }

        .tab:hover .tab-close,
        .tab.active .tab-close {
            opacity: 1;
        }

        .tab-close:hover {
            background: rgba(255,0,0,0.3);
            color: white;
            transform: scale(1.1);
        }

        .new-tab {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            margin-left: 8px;
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            /* Prevent layout shift by ensuring consistent sizing */
            min-width: 32px;
            min-height: 32px;
            box-sizing: border-box;
        }

        .new-tab:hover {
            background: rgba(255,255,255,0.2);
            color: white;
            transform: scale(1.1);
        }

        /* Tab Animations */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes audioWave {
            0% { transform: scale(1); }
            100% { transform: scale(1.3); }
        }

        /* Tab Context Menu */
        .tab-context-menu {
            position: absolute;
            background: var(--dark-elevated);
            border: 1px solid var(--dark-border);
            border-radius: 8px;
            padding: 4px 0;
            min-width: 180px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
        }

        .tab-context-menu.show {
            display: block;
        }

        .tab-context-item {
            padding: 8px 16px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 13px;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-context-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .tab-context-item.disabled {
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .tab-context-item.disabled:hover {
            background: none;
        }

        /* Main Layout */
        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            /* Prevent layout shift by setting explicit dimensions */
            min-height: 0;
            contain: layout style;
        }

        /* Enhanced Sidebar */
        .sidebar {
            width: 460px;
            background: var(--dark-surface);
            border-right: 1px solid var(--dark-border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-400px);
        }

        .sidebar-header {
            background: var(--primary-gradient);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .ai-avatar {
            width: 60px;
            height: 60px;
            background: var(--success-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            animation: aiFloat 3s ease-in-out infinite;
            position: relative;
            overflow: hidden;
        }

        @keyframes aiFloat {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-5px) scale(1.05); }
        }

        .ai-avatar::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent);
            pointer-events: none;
        }

        .ai-info h2 {
            color: white;
            font-size: 24px;
            margin-bottom: 4px;
        }

        .ai-status {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-capabilities {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .capability-badge {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            background: rgba(0,0,0,0.2);
            padding: 0;
            display: flex;
            border-bottom: 1px solid var(--dark-border);
        }

        .nav-tab {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 16px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-tab.active {
            color: white;
            background: rgba(255,255,255,0.08);
            border-bottom-color: var(--accent-blue);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.05);
            color: var(--text-primary);
        }

        .nav-tab i {
            font-size: 16px;
        }

        /* Sidebar Content */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .sidebar-panel {
            display: none;
            padding: 20px;
            height: 100%;
        }

        .sidebar-panel.active {
            display: block;
        }

        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: messageSlideIn 0.4s ease;
            max-width: 90%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--primary-gradient);
        }

        .message.assistant .message-avatar {
            background: var(--success-gradient);
        }

        .message-content {
            background: rgba(255,255,255,0.08);
            padding: 14px 18px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.6;
            position: relative;
        }

        .message.user .message-content {
            background: var(--primary-gradient);
            color: white;
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .message-action {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message-action:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Chat Input */
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid var(--dark-border);
            background: rgba(0,0,0,0.2);
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: rgba(255,255,255,0.05);
            border-radius: 24px;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .chat-input-container:focus-within {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
        }

        .chat-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            max-height: 120px;
            min-height: 24px;
        }

        .chat-input:focus {
            outline: none;
        }

        .chat-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chat-action-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .chat-action-btn:hover {
            background: rgba(255,255,255,0.2);
            color: white;
            transform: scale(1.1);
        }

        .chat-send {
            background: var(--primary-gradient);
            color: white;
        }

        .chat-send:hover {
            box-shadow: 0 4px 15px rgba(102,126,234,0.4);
        }

        /* Workflow Panel */
        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .workflow-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .workflow-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .workflow-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-gradient);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }

        .workflow-title {
            color: white;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .workflow-description {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .workflow-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .workflow-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .workflow-status.active {
            color: var(--accent-green);
        }

        /* Analytics Panel */
        .analytics-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-3px);
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            background: var(--accent-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 18px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-change {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .metric-change.positive {
            color: var(--accent-green);
        }

        .metric-change.negative {
            color: #ef4444;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--dark-bg);
        }

        .webview-container {
            flex: 1;
            position: relative;
            background: white;
        }

        .webview {
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }

        .webview.active {
            display: block;
        }

        /* Demo Content */
        .demo-showcase {
            padding: 60px 40px;
            height: 100%;
            overflow-y: auto;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .showcase-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .showcase-title {
            font-size: 4em;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            font-weight: 800;
        }

        .showcase-subtitle {
            font-size: 1.4em;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .feature-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 40px;
            margin-bottom: 80px;
        }

        .feature-demo {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-demo:hover {
            transform: translateY(-10px);
            box-shadow: 0 30px 80px rgba(0,0,0,0.15);
        }

        .feature-demo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .feature-icon-large {
            width: 80px;
            height: 80px;
            background: var(--primary-gradient);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(102,126,234,0.3);
        }

        .feature-demo h3 {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 16px;
            font-weight: 700;
        }

        .feature-demo p {
            color: #666;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .demo-button {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .demo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102,126,234,0.4);
        }

        /* Floating Elements */
        .floating-assistant {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            background: var(--success-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(74,222,128,0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            animation: floatingPulse 3s ease-in-out infinite;
        }

        @keyframes floatingPulse {
            0%, 100% { 
                transform: scale(1); 
                box-shadow: 0 10px 30px rgba(74,222,128,0.4);
            }
            50% { 
                transform: scale(1.1); 
                box-shadow: 0 15px 40px rgba(74,222,128,0.6);
            }
        }

        .floating-assistant:hover {
            transform: scale(1.15);
            box-shadow: 0 20px 50px rgba(74,222,128,0.8);
        }

        /* Notifications */
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .notification {
            background: var(--primary-gradient);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 320px;
            max-width: 420px;
            animation: notificationSlide 0.4s ease;
            pointer-events: all;
            backdrop-filter: blur(20px);
        }

        @keyframes notificationSlide {
            from {
                transform: translateX(450px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            background: var(--success-gradient);
        }

        .notification.warning {
            background: var(--warning-gradient);
        }

        .notification.error {
            background: var(--danger-gradient);
        }

        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 13px;
            opacity: 0.9;
            line-height: 1.4;
        }

        .notification-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loading-content {
            background: var(--dark-surface);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .loading-progress {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .sidebar {
                width: 360px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 1000;
                width: 100%;
            }
            
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            .nav-controls {
                flex-wrap: wrap;
            }
            
            .action-buttons {
                order: 3;
                width: 100%;
                margin-top: 8px;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        *:focus-visible {
            outline: 2px solid var(--accent-blue);
            outline-offset: 2px;
        }

        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Document Scanner Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1e1e2e 0%, #2a2a3e 100%);
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
        }

        .document-scanner {
            width: 800px;
            max-width: 90vw;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
        }

        .modal-header h3 {
            margin: 0;
            color: white;
            font-size: 1.3em;
            font-weight: 600;
        }

        .modal-header h3 i {
            margin-right: 10px;
            color: #fbbf24;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .scanner-content {
            padding: 25px;
        }

        .upload-area {
            margin-bottom: 25px;
        }

        .upload-zone {
            border: 2px dashed #6366f1;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(99, 102, 241, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 48px;
            color: #6366f1;
            margin-bottom: 15px;
            display: block;
        }

        .upload-zone h4 {
            margin: 0 0 10px 0;
            color: white;
            font-size: 1.2em;
        }

        .upload-zone p {
            margin: 0;
            color: #a0a0a0;
        }

        .upload-link {
            color: #6366f1;
            cursor: pointer;
            text-decoration: underline;
        }

        .upload-link:hover {
            color: #8b5cf6;
        }

        .supported-formats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .supported-formats small {
            color: #666;
        }

        .scanner-options {
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .options-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .option-tab {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            font-weight: 500;
        }

        .option-tab:hover {
            color: #e0e0e0;
            background: rgba(255, 255, 255, 0.05);
        }

        .option-tab.active {
            color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
            border-bottom: 2px solid #6366f1;
        }

        .option-panel {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .option-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .option-group label {
            color: #e0e0e0;
            font-weight: 500;
            font-size: 0.9em;
        }

        .option-group select {
            background: #2a2a3e;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 0.9em;
        }

        .option-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .option-group input[type="checkbox"] {
            margin-right: 8px;
            accent-color: #6366f1;
        }

        .option-group input[type="range"] {
            background: #2a2a3e;
            height: 6px;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .option-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #6366f1;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .range-value {
            font-size: 0.8em;
            color: #6366f1;
            font-weight: 600;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 0.85em;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .checkbox-group label:hover {
            color: #6366f1;
        }

        /* Enhanced Results Section */
        .results-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px 6px 0 0;
            margin-bottom: 0;
        }

        .result-tab {
            flex: 1;
            padding: 10px 16px;
            background: none;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85em;
            font-weight: 500;
        }

        .result-tab:hover {
            color: #e0e0e0;
            background: rgba(255, 255, 255, 0.05);
        }

        .result-tab.active {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .result-panel {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 0 0 6px 6px;
            padding: 15px;
            min-height: 200px;
        }

        .formatted-text {
            font-family: 'Georgia', serif;
            line-height: 1.6;
            color: #e0e0e0;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analysis-item label {
            font-size: 0.85em;
            color: #a0a0a0;
            font-weight: 500;
        }

        .analysis-item span {
            font-size: 0.9em;
            color: #e0e0e0;
            font-weight: 600;
        }

        .confidence-distribution h5 {
            margin: 0 0 15px 0;
            color: #e0e0e0;
            font-size: 1em;
        }

        .confidence-bars {
            display: flex;
            gap: 4px;
            height: 60px;
            align-items: end;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 4px;
        }

        .confidence-bar {
            flex: 1;
            background: linear-gradient(to top, #ef4444, #f59e0b, #10b981);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .results-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quick-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .stat {
            font-size: 0.85em;
            color: #a0a0a0;
        }

        .confidence-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .confidence-badge.high {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .confidence-badge.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .confidence-badge.low {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .quality-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
            background: rgba(99, 102, 241, 0.2);
            color: #6366f1;
        }

        .scan-progress {
            margin-bottom: 25px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            color: #a0a0a0;
            text-align: center;
            font-size: 0.9em;
        }

        .scan-results {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .results-header h4 {
            margin: 0;
            color: white;
            font-size: 1.1em;
        }

        .results-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .btn-secondary i {
            font-size: 0.9em;
        }

        #extractedText {
            width: 100%;
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 15px;
            color: white;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            resize: vertical;
            min-height: 200px;
        }

        #extractedText:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .confidence-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 0.85em;
            color: #a0a0a0;
        }

        @media (max-width: 768px) {
            .document-scanner {
                width: 95vw;
                margin: 10px;
            }
            
            .scanner-options {
                grid-template-columns: 1fr;
            }
            
            .results-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .results-actions {
                justify-content: center;
            }
        }

        /* Cross-Tab Data Transfer Styles */
        .cross-tab-transfer {
            width: 900px;
            max-width: 95vw;
            max-height: 90vh;
        }

        .transfer-content {
            padding: 25px;
            height: 600px;
            overflow-y: auto;
        }

        .transfer-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
        }

        .transfer-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .transfer-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .transfer-tab.active {
            color: #6366f1;
            border-bottom-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .transfer-panel {
            display: none;
        }

        .transfer-panel.active {
            display: block;
        }

        .tab-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .tab-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .tab-group label {
            color: #a0a0a0;
            font-size: 0.9em;
            font-weight: 500;
        }

        .tab-group select {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 10px;
            color: white;
            font-size: 0.9em;
        }

        .tab-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .data-selection {
            margin-bottom: 25px;
        }

        .data-selection h4 {
            color: white;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .data-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .data-types label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e0e0e0;
            font-size: 0.9em;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .data-types label:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .data-types input[type="checkbox"] {
            accent-color: #6366f1;
        }

        .transfer-options {
            margin-bottom: 25px;
        }

        .transfer-options h4 {
            color: white;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .option-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .option-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e0e0e0;
            font-size: 0.9em;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .option-group label:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .transfer-preview {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .transfer-preview h4 {
            color: white;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .preview-content {
            background: #0a0a0a;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 0.85em;
            color: #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
        }

        .transfer-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .active-transfers, .tab-status, .metrics-display {
            margin-bottom: 25px;
        }

        .active-transfers h4, .tab-status h4, .metrics-display h4 {
            color: white;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .transfers-list, .tabs-list {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            min-height: 100px;
        }

        .no-transfers, .no-history {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metric-label {
            color: #a0a0a0;
            font-size: 0.9em;
        }

        .metric-value {
            color: #6366f1;
            font-weight: 600;
            font-size: 1.1em;
        }

        .settings-group {
            margin-bottom: 25px;
        }

        .settings-group h4 {
            color: white;
            margin-bottom: 15px;
            font-size: 1em;
        }

        /* Theme Preview Styles */
        .theme-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .theme-preview-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .theme-preview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .theme-preview-card.active {
            border-color: var(--theme-accent);
            background: rgba(59, 130, 246, 0.1);
        }

        .theme-preview-colors {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .theme-color-sample {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .theme-preview-name {
            font-size: 0.85em;
            color: var(--theme-text);
            font-weight: 500;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .setting-item label {
            color: #e0e0e0;
            font-size: 0.9em;
            flex: 1;
        }

        .setting-item input {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 6px 10px;
            color: white;
            font-size: 0.9em;
            width: 80px;
        }

        .setting-item input:focus {
            outline: none;
            border-color: #6366f1;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e0e0e0;
            font-size: 0.9em;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .checkbox-group label:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .settings-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        /* Language Settings Specific Styles */
        .language-info {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-item strong {
            color: var(--theme-text);
            font-weight: 500;
        }

        .status-complete {
            color: var(--theme-success);
            font-weight: 500;
        }

        .status-partial {
            color: var(--theme-warning);
            font-weight: 500;
        }

        .status-missing {
            color: var(--theme-danger);
            font-weight: 500;
        }

        /* Notification Category Controls */
        .category-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-controls .toggle-switch {
            margin-right: 5px;
        }

        .category-controls .control-label {
            font-size: 0.8em;
            color: #a0a0a0;
            margin-left: 5px;
        }

        .setting-subsection {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-subsection h5 {
            margin: 0 0 15px 0;
            color: var(--theme-accent);
            font-size: 0.95em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-status .status-item,
        .monitoring-info .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .notification-status .status-item:last-child,
        .monitoring-info .info-item:last-child {
            border-bottom: none;
        }

        .notification-actions,
        .monitoring-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .notification-actions .action-btn,
        .monitoring-actions .action-btn {
            padding: 10px 15px;
            font-size: 0.85em;
            white-space: nowrap;
        }

        /* Update Status Styles */
        .status-up-to-date {
            color: var(--theme-success);
            font-weight: 500;
        }

        .status-update-available {
            color: var(--theme-warning);
            font-weight: 500;
        }

        .status-downloading {
            color: var(--theme-accent);
            font-weight: 500;
        }

        .status-error {
            color: var(--theme-danger);
            font-weight: 500;
        }

        /* Update Progress Styles */
        .update-progress {
            margin: 15px 0;
        }

        .progress-bar {
            background: var(--theme-surface);
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .progress-fill {
            background: var(--theme-accent);
            height: 100%;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: var(--theme-secondary);
            text-align: center;
        }

        .update-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .language-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .language-status {
            margin-top: 15px;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9em;
            border-left: 4px solid;
        }

        .language-status.loading {
            background: rgba(59, 130, 246, 0.1);
            border-left-color: var(--theme-accent);
            color: var(--theme-accent);
        }

        .language-status.success {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: var(--theme-success);
            color: var(--theme-success);
        }

        .language-status.error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: var(--theme-danger);
            color: var(--theme-danger);
        }

        .setting-description {
            display: block;
            color: var(--theme-secondary);
            font-size: 0.85em;
            margin-top: 5px;
            font-style: italic;
        }

        .history-filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            color: #a0a0a0;
            font-size: 0.9em;
        }

        .filter-group select {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 6px 10px;
            color: white;
            font-size: 0.9em;
        }

        .history-list {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .transfer-progress {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-info span {
            color: #e0e0e0;
            font-size: 0.9em;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            height: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-details {
            color: #a0a0a0;
            font-size: 0.85em;
        }

        @media (max-width: 768px) {
            .cross-tab-transfer {
                width: 95vw;
                margin: 10px;
            }
            
            .tab-selection {
                grid-template-columns: 1fr;
            }
            
            .data-types, .option-group {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .history-filters {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Command System Styles */
        .command-result {
            position: fixed;
            top: 80px;
            right: 20px;
            min-width: 300px;
            max-width: 500px;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9em;
            z-index: 10001;
            display: none;
            animation: slideInRight 0.3s ease-out;
        }

        .command-result.success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9), rgba(22, 163, 74, 0.9));
            color: white;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .command-result.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.9), rgba(220, 38, 38, 0.9));
            color: white;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .command-result.info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.9));
            color: white;
            border-color: rgba(59, 130, 246, 0.3);
        }

        .command-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0 0 8px 8px;
            border-top: none;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .command-suggestion {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .command-suggestion:hover,
        .command-suggestion.selected {
            background: rgba(99, 102, 241, 0.2);
        }

        .command-suggestion:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-weight: 600;
            color: #6366f1;
            font-size: 0.9em;
        }

        .suggestion-description {
            color: #a0a0a0;
            font-size: 0.8em;
            margin-top: 2px;
        }

        .suggestion-usage {
            color: #666;
            font-size: 0.75em;
            font-family: 'Consolas', monospace;
            margin-top: 2px;
        }

        .url-container.command-mode .url-bar {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .command-indicator {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #6366f1;
            font-size: 0.8em;
            font-weight: 600;
            display: none;
        }

        .url-container.command-mode .command-indicator {
            display: block;
        }

        .url-container.command-mode .url-bar {
            padding-left: 35px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Update Modal Styles */
        .update-modal {
            width: 600px;
            max-width: 90vw;
        }

        .update-content {
            padding: 25px;
        }

        .update-info {
            margin-bottom: 25px;
        }

        .version-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'JetBrains Mono', monospace;
        }

        .current-version, .new-version {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .current-version {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .new-version {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .version-badge i {
            color: #9ca3af;
            font-size: 1.2em;
        }

        .update-description h4 {
            color: #e5e7eb;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .release-notes {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 15px;
            border-left: 4px solid #6366f1;
            color: #d1d5db;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        .release-notes p {
            margin: 0 0 10px 0;
        }

        .release-notes ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .release-notes li {
            margin-bottom: 5px;
        }

        .update-progress {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-text {
            color: #e5e7eb;
            font-weight: 500;
        }

        .progress-percentage {
            color: #22d3ee;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #22d3ee 0%, #06b6d4 100%);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #9ca3af;
            font-family: 'JetBrains Mono', monospace;
        }

        .update-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .update-actions .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .update-actions .btn-secondary {
            background: rgba(75, 85, 99, 0.8);
            color: #d1d5db;
            border: 1px solid rgba(156, 163, 175, 0.3);
        }

        .update-actions .btn-secondary:hover {
            background: rgba(75, 85, 99, 1);
            transform: translateY(-1px);
        }

        .update-actions .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .update-actions .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .update-actions .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .update-actions .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
        }

        /* Command palette styles */
        .command-palette {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            max-width: 90vw;
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            z-index: 10002;
            display: none;
        }

        .command-palette-header {
            padding: 20px 25px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .command-palette-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-size: 1.1em;
            padding: 10px 0;
        }

        .command-palette-input::placeholder {
            color: #666;
        }

        .command-palette-results {
            max-height: 400px;
            overflow-y: auto;
        }

        .command-category {
            padding: 15px 25px 5px;
            color: #a0a0a0;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* System Tray Styles */
        .system-tray-panel {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .tray-setting-group {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .tray-setting-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            display: block;
        }
        
        .tray-checkbox {
            margin-right: 8px;
        }
        
        .tray-statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .tray-stat-item {
            background: #f0f7ff;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #b3d9ff;
        }
        
        .tray-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0066cc;
        }
        
        .tray-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .tray-quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .tray-quick-button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .tray-quick-button:hover {
            background: #0056b3;
        }
        
        .tray-notification-test {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- System Status Bar -->
    <div class="system-status-bar">
        <div class="status-left">
            <div class="status-indicator">
                <span class="status-dot" id="systemStatus"></span>
                <span id="systemStatusText" data-i18n="app.loading">System Ready</span>
            </div>
            <div class="status-indicator">
                <i class="fas fa-brain"></i>
                <span id="aiStatus" data-i18n="chat.title">AI Active</span>
            </div>
            <div class="status-indicator">
                <i class="fas fa-shield-alt"></i>
                <span id="securityStatus" data-i18n="security.secureConnection">Secure</span>
            </div>
        </div>
        <div class="status-right">
            <div class="status-indicator">
                <i class="fas fa-memory"></i>
                <span id="memoryUsage">Memory: 245MB</span>
            </div>
            <div class="status-indicator">
                <i class="fas fa-sync-alt"></i>
                <span id="syncStatus" data-i18n="crossTab.transferComplete">Synced</span>
            </div>
            <div class="status-indicator">
                <i class="fas fa-clock"></i>
                <span id="systemTime"></span>
            </div>
        </div>
    </div>

    <!-- Enhanced Browser Header -->
    <header class="browser-header">
        <nav class="nav-controls">
            <!-- Navigation Section -->
            <div class="nav-section">
                <button class="nav-btn" id="backButton" onclick="micBrowser.goBackActiveTab()" data-i18n-title="navigation.back" data-i18n-aria="navigation.back" title="Go Back" aria-label="Go back">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <button class="nav-btn" id="forwardButton" onclick="micBrowser.goForwardActiveTab()" data-i18n-title="navigation.forward" data-i18n-aria="navigation.forward" title="Go Forward" aria-label="Go forward">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <button class="nav-btn" id="refreshButton" onclick="micBrowser.refreshActiveTab()" data-i18n-title="navigation.reload" data-i18n-aria="navigation.reload" title="Reload" aria-label="Reload page">
                    <i class="fas fa-redo"></i>
                </button>
                <button class="nav-btn" onclick="goHome()" data-i18n-title="navigation.home" data-i18n-aria="navigation.home" title="Home" aria-label="Go to home">
                    <i class="fas fa-home"></i>
                </button>
            </div>

            <!-- URL Container -->
            <div class="url-container" id="urlContainer">
                <div class="command-indicator">CMD</div>
                <input type="text" class="url-bar" id="urlInput" 
                       data-i18n-placeholder="navigation.addressBar" 
                       placeholder="Enter URL, search, or command (try: /help)..." 
                       value=""
                       onkeypress="if(event.key==='Enter') safeNavigateFromUrlBar()">
                <div class="url-indicators">
                    <span class="ssl-indicator" title="Secure Connection">
                        <i class="fas fa-lock"></i>
                    </span>
                    <span class="ai-indicator" title="AI Analysis Active" onclick="toggleAIAnalysis()">
                        <i class="fas fa-brain"></i>
                    </span>
                    <span class="sync-indicator" title="Synced Across Devices">
                        <i class="fas fa-cloud"></i>
                    </span>
                </div>
                <div class="command-suggestions" id="commandSuggestions" style="display: none;"></div>
            </div>

            <!-- AI Assistant Button -->
            <button class="ai-btn active" onclick="toggleAssistant()" title="MIC AI Assistant" aria-label="Toggle AI Assistant">
                <i class="fas fa-robot"></i>
            </button>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn primary" onclick="quickScan()" title="Quick Document Scan">
                    <i class="fas fa-camera"></i>
                    <span>Scan</span>
                </button>
                <button class="action-btn transfer" onclick="openCrossTabTransfer()" title="Cross-Tab Data Transfer">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Transfer</span>
                </button>
                <button class="action-btn" onclick="runExternalLinkTest()" title="Test External Link Handling" style="background: #ff6b35;">
                    <i class="fas fa-external-link-alt"></i>
                    <span>Link Test</span>
                </button>
                <button class="action-btn" onclick="testQuickExternalLinks()" title="Quick External Link Test" style="background: #28a745;">
                    <i class="fas fa-bolt"></i>
                    <span>Quick Test</span>
                </button>
                <button class="action-btn voice" onclick="startVoiceCommand()" title="Voice Command">
                    <i class="fas fa-microphone"></i>
                    <span>Voice</span>
                </button>
                <button class="action-btn analytics" onclick="showAnalytics()" title="Analytics Dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Analytics</span>
                </button>
            </div>
        </nav>

        <!-- Enhanced Tab Container -->
        <div class="tab-container" id="tabContainer">
            <div class="tabs-wrapper" id="tabsWrapper">
                <!-- Tabs will be dynamically created by TabManager -->
            </div>
            <button class="new-tab" title="New Tab" aria-label="New tab">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Enhanced AI Sidebar -->
        <aside class="sidebar" id="aiSidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ai-info">
                    <h2>MIC Ultimate</h2>
                    <div class="ai-status">
                        <span class="status-dot"></span>
                        <span>Active & Learning</span>
                    </div>
                    <div class="ai-capabilities">
                        <span class="capability-badge">Claude AI</span>
                        <span class="capability-badge">OCR</span>
                        <span class="capability-badge">Voice</span>
                        <span class="capability-badge">Analytics</span>
                    </div>
                </div>
            </div>

            <!-- Sidebar Navigation -->
            <div class="sidebar-nav">
                <button class="nav-tab active" onclick="switchSidebarTab('chat')" data-tab="chat">
                    <i class="fas fa-comments"></i>
                    <span>Chat</span>
                </button>
                <button class="nav-tab" onclick="switchSidebarTab('workflows')" data-tab="workflows">
                    <i class="fas fa-project-diagram"></i>
                    <span>Workflows</span>
                </button>
                <button class="nav-tab" onclick="switchSidebarTab('analytics')" data-tab="analytics">
                    <i class="fas fa-chart-pie"></i>
                    <span>Analytics</span>
                </button>
                <button class="nav-tab" onclick="switchSidebarTab('settings')" data-tab="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </button>
            </div>

            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Chat Panel -->
                <div class="sidebar-panel active" id="chatPanel">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="message assistant">
                                <div class="message-avatar">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="message-content">
                                    <p>Hello! I'm MIC, your ultimate AI browsing assistant. I can help you with:</p>
                                    <ul>
                                        <li>  Intelligent automation & workflows</li>
                                        <li> Document scanning & OCR</li>
                                        <li> Data transfer between applications</li>
                                        <li> Analytics & insights</li>
                                        <li> Voice commands</li>
                                        <li> Security & compliance</li>
                                    </ul>
                                    <p>What would you like to accomplish today?</p>
                                    <div class="message-actions">
                                        <button class="message-action" onclick="quickAction('scan')">Scan Document</button>
                                        <button class="message-action" onclick="quickAction('analyze')">Analyze Page</button>
                                        <button class="message-action" onclick="quickAction('automate')">Create Workflow</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <div class="chat-input-container">
                                <textarea class="chat-input" id="chatInput" 
                                         placeholder="Ask MIC anything or describe what you want to automate..."
                                         rows="1"></textarea>
                                <div class="chat-actions">
                                    <button class="chat-action-btn" onclick="attachFile()" title="Attach File">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <button class="chat-action-btn" onclick="toggleVoice()" title="Voice Input">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                    <button class="chat-action-btn" onclick="showSuggestions()" title="Smart Suggestions">
                                        <i class="fas fa-lightbulb"></i>
                                    </button>
                                    <button class="chat-action-btn chat-send" onclick="sendMessage()" title="Send Message">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workflows Panel -->
                <div class="sidebar-panel" id="workflowsPanel">
                    <h3 style="color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-project-diagram"></i>
                        Active Workflows
                    </h3>
                    <div class="workflow-grid">
                        <div class="workflow-card" onclick="executeWorkflow('data-transfer')">
                            <div class="workflow-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="workflow-title">Smart Data Transfer</div>
                            <div class="workflow-description">Automatically transfer data between CRM and Finance Portal with AI field mapping.</div>
                            <div class="workflow-stats">
                                <span class="workflow-status active">
                                    <span class="status-dot"></span>
                                    Active
                                </span>
                                <span>95% Success Rate</span>
                            </div>
                        </div>
                        
                        <div class="workflow-card" onclick="executeWorkflow('document-processing')">
                            <div class="workflow-icon">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="workflow-title">Document Processing</div>
                            <div class="workflow-description">OCR scan, AI extraction, and automatic form population for any document type.</div>
                            <div class="workflow-stats">
                                <span class="workflow-status active">
                                    <span class="status-dot"></span>
                                    Active
                                </span>
                                <span>127 Documents</span>
                            </div>
                        </div>
                        
                        <div class="workflow-card" onclick="executeWorkflow('predictive-automation')">
                            <div class="workflow-icon">
                                <i class="fas fa-brain"></i>
                            </div>
                            <div class="workflow-title">Predictive Actions</div>
                            <div class="workflow-description">AI predicts your next actions and automates repetitive tasks before you ask.</div>
                            <div class="workflow-stats">
                                <span class="workflow-status active">
                                    <span class="status-dot"></span>
                                    Learning
                                </span>
                                <span>87% Accuracy</span>
                            </div>
                        </div>

                        <div class="workflow-card" onclick="createNewWorkflow()">
                            <div class="workflow-icon">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div class="workflow-title">Create New Workflow</div>
                            <div class="workflow-description">Record a new automation or use AI to generate workflows from natural language.</div>
                            <div class="workflow-stats">
                                <span style="color: var(--accent-blue);">
                                    <i class="fas fa-wand-magic-sparkles"></i>
                                    AI Powered
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Panel -->
                <div class="sidebar-panel" id="analyticsPanel">
                    <h3 style="color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chart-line"></i>
                        Performance Analytics
                    </h3>
                    
                    <div class="analytics-overview">
                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--accent-blue);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="metric-value">4.2h</div>
                            <div class="metric-label">Time Saved Today</div>
                            <div class="metric-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +23% vs Yesterday
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--accent-green);">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="metric-value">47</div>
                            <div class="metric-label">Tasks Automated</div>
                            <div class="metric-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +12 this week
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--accent-purple);">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="metric-value">97%</div>
                            <div class="metric-label">Accuracy Rate</div>
                            <div class="metric-change positive">
                                <i class="fas fa-arrow-up"></i>
                                +2% improvement
                            </div>
                        </div>

                        <div class="metric-card">
                            <div class="metric-icon" style="background: var(--accent-orange);">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="metric-value">$1,247</div>
                            <div class="metric-label">Value Generated</div>
                            <div class="metric-change positive">
                                <i class="fas fa-arrow-up"></i>
                                This month
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h4 style="color: white; margin-bottom: 15px;">Recent Activity</h4>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                                <div style="width: 8px; height: 8px; background: var(--accent-green); border-radius: 50%;"></div>
                                <div style="flex: 1; font-size: 14px;">
                                    <div style="color: white;">Customer data transfer completed</div>
                                    <div style="color: var(--text-secondary); font-size: 12px;">2 minutes ago</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                                <div style="width: 8px; height: 8px; background: var(--accent-blue); border-radius: 50%;"></div>
                                <div style="flex: 1; font-size: 14px;">
                                    <div style="color: white;">Invoice OCR processed</div>
                                    <div style="color: var(--text-secondary); font-size: 12px;">5 minutes ago</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                                <div style="width: 8px; height: 8px; background: var(--accent-purple); border-radius: 50%;"></div>
                                <div style="flex: 1; font-size: 14px;">
                                    <div style="color: white;">Workflow optimization suggested</div>
                                    <div style="color: var(--text-secondary); font-size: 12px;">12 minutes ago</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Settings Panel -->
                <div class="sidebar-panel" id="settingsPanel">
                    <div class="settings-header">
                        <h3><i class="fas fa-cog"></i> Settings & Preferences</h3>
                        <div class="settings-actions">
                            <button class="settings-btn" onclick="micBrowser.settings.exportSettings()" title="Export Settings">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="settings-btn" onclick="document.getElementById('importSettings').click()" title="Import Settings">
                                <i class="fas fa-upload"></i>
                            </button>
                            <button class="settings-btn" onclick="micBrowser.settings.resetToDefaults()" title="Reset to Defaults">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="settings-btn" onclick="window.pluginManagerUI.show()" title="Plugin Manager">
                                <i class="fas fa-plug"></i>
                            </button>
                            <input type="file" id="importSettings" accept=".json" style="display: none;" onchange="micBrowser.handleImportSettings(this)">
                        </div>
                    </div>

                    <div class="settings-tabs">
                        <button class="settings-tab active" data-tab="ai" onclick="safeCallMicBrowser('switchSettingsTab', 'ai')">
                            <i class="fas fa-brain"></i> AI
                        </button>
                        <button class="settings-tab" data-tab="browser" onclick="safeCallMicBrowser('switchSettingsTab', 'browser')">
                            <i class="fas fa-globe"></i> Browser
                        </button>
                        <button class="settings-tab" data-tab="privacy" onclick="safeCallMicBrowser('switchSettingsTab', 'privacy')">
                            <i class="fas fa-shield-alt"></i> Privacy
                        </button>
                        <button class="settings-tab" data-tab="appearance" onclick="safeCallMicBrowser('switchSettingsTab', 'appearance')">
                            <i class="fas fa-palette"></i> Theme
                        </button>
                        <button class="settings-tab" data-tab="language" onclick="safeCallMicBrowser('switchSettingsTab', 'language')">
                            <i class="fas fa-globe-americas"></i> <span data-i18n="settings.categories.language">Language</span>
                        </button>
                        <button class="settings-tab" data-tab="updates" onclick="safeCallMicBrowser('switchSettingsTab', 'updates')">
                            <i class="fas fa-sync-alt"></i> Updates
                        </button>
                        <button class="settings-tab" data-tab="monitoring" onclick="safeCallMicBrowser('switchSettingsTab', 'monitoring')">
                            <i class="fas fa-chart-line"></i> Monitoring
                        </button>
                        <button class="settings-tab" data-tab="deeplink" onclick="safeCallMicBrowser('switchSettingsTab', 'deeplink')">
                            <i class="fas fa-link"></i> Deep Links
                        </button>
                        <button class="settings-tab" data-tab="systemtray" onclick="safeCallMicBrowser('switchSettingsTab', 'systemtray')">
                            <i class="fas fa-window-minimize"></i> System Tray
                        </button>
                        <button class="settings-tab" data-tab="advanced" onclick="safeCallMicBrowser('switchSettingsTab', 'advanced')">
                            <i class="fas fa-cogs"></i> Advanced
                        </button>
                    </div>

                    <div class="settings-content">
                        <!-- AI Settings -->
                        <div class="settings-group active" id="settings-ai">
                            <div class="setting-section">
                                <h4><i class="fas fa-robot"></i> Assistant Behavior</h4>
                                <div class="setting-item">
                                    <label>Predictive Mode</label>
                                    <div class="toggle-switch active" data-setting="ai.predictiveMode">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Auto-Learning</label>
                                    <div class="toggle-switch active" data-setting="ai.autoLearning">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Proactive Assistance</label>
                                    <div class="toggle-switch active" data-setting="ai.proactiveAssistance">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Context Memory</label>
                                    <div class="toggle-switch active" data-setting="ai.contextMemory">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-microphone"></i> Voice Commands</h4>
                                <div class="setting-item">
                                    <label>Enable Voice Commands</label>
                                    <div class="toggle-switch active" data-setting="ai.voiceCommands">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Voice Language</label>
                                    <select data-setting="voice.language" class="setting-select">
                                        <option value="en-US">English (US)</option>
                                        <option value="en-GB">English (UK)</option>
                                        <option value="es-ES">Spanish</option>
                                        <option value="fr-FR">French</option>
                                        <option value="de-DE">German</option>
                                        <option value="it-IT">Italian</option>
                                        <option value="pt-BR">Portuguese</option>
                                        <option value="zh-CN">Chinese</option>
                                        <option value="ja-JP">Japanese</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Wake Word</label>
                                    <input type="text" data-setting="voice.wakWord" class="setting-input" placeholder="Hey MIC">
                                </div>
                                <div class="setting-item">
                                    <label>Voice Sensitivity</label>
                                    <select data-setting="voice.sensitivity" class="setting-select">
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-tachometer-alt"></i> Performance</h4>
                                <div class="setting-item range-setting">
                                    <label>AI Response Speed</label>
                                    <div class="range-container">
                                        <input type="range" min="0" max="2" value="1" data-setting="ai.responseSpeed" class="setting-range">
                                        <div class="range-labels">
                                            <span>Accurate</span>
                                            <span>Balanced</span>
                                            <span>Fast</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Browser Settings -->
                        <div class="settings-group" id="settings-browser">
                            <div class="setting-section">
                                <h4><i class="fas fa-tabs"></i> Tab Management</h4>
                                <div class="setting-item">
                                    <label>New Tab Behavior</label>
                                    <select data-setting="browser.newTabBehavior" class="setting-select">
                                        <option value="homepage">Homepage</option>
                                        <option value="blank">Blank Page</option>
                                        <option value="previous">Previous Session</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Show Tab Previews</label>
                                    <div class="toggle-switch active" data-setting="browser.showTabPreviews">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Enable Drag Reorder</label>
                                    <div class="toggle-switch active" data-setting="browser.enableDragReorder">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Close Tabs on Exit</label>
                                    <div class="toggle-switch active" data-setting="browser.closeTabsOnExit">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-search"></i> Search & Navigation</h4>
                                <div class="setting-item">
                                    <label>Default Search Engine</label>
                                    <select data-setting="browser.defaultSearchEngine" class="setting-select">
                                        <option value="google">Google</option>
                                        <option value="bing">Bing</option>
                                        <option value="duckduckgo">DuckDuckGo</option>
                                        <option value="yahoo">Yahoo</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Homepage URL</label>
                                    <input type="url" data-setting="browser.homepage" class="setting-input" placeholder="about:blank">
                                </div>
                            </div>
                        </div>

                        <!-- Privacy Settings -->
                        <div class="settings-group" id="settings-privacy">
                            <div class="setting-section">
                                <h4><i class="fas fa-lock"></i> Security</h4>
                                <div class="setting-item">
                                    <label>End-to-End Encryption</label>
                                    <div class="toggle-switch active" data-setting="security.encryption">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Audit Logging</label>
                                    <div class="toggle-switch active" data-setting="security.auditLogging">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Biometric Authentication</label>
                                    <div class="toggle-switch" data-setting="security.biometricAuth">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Auto Updates</label>
                                    <div class="toggle-switch active" data-setting="security.autoUpdates">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-user-secret"></i> Privacy</h4>
                                <div class="setting-item">
                                    <label>Cookie Policy</label>
                                    <select data-setting="security.cookiePolicy" class="setting-select">
                                        <option value="allow">Allow All</option>
                                        <option value="strict">Strict</option>
                                        <option value="block">Block All</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Tracking Protection</label>
                                    <div class="toggle-switch active" data-setting="security.trackingProtection">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Appearance Settings -->
                        <div class="settings-group" id="settings-appearance">
                            <div class="setting-section">
                                <h4><i class="fas fa-paint-brush"></i> Theme</h4>
                                <div class="setting-item">
                                    <label>Color Theme</label>
                                    <select id="themeSelector" data-setting="appearance.theme" class="setting-select" onchange="handleThemeChange(this.value)">
                                        <option value="dark">Dark</option>
                                        <option value="light">Light</option>
                                        <option value="blue">Blue Dark</option>
                                        <option value="purple">Purple Dark</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <label>Theme Preview</label>
                                    <div class="theme-preview-grid" id="themePreviewGrid">
                                        <!-- Theme previews will be populated by JavaScript -->
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Font Size</label>
                                    <select data-setting="appearance.fontSize" class="setting-select">
                                        <option value="small">Small</option>
                                        <option value="medium">Medium</option>
                                        <option value="large">Large</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Sidebar Position</label>
                                    <select data-setting="appearance.sidebarPosition" class="setting-select">
                                        <option value="right">Right</option>
                                        <option value="left">Left</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Compact Mode</label>
                                    <div class="toggle-switch" data-setting="appearance.compactMode">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-magic"></i> Visual Effects</h4>
                                <div class="setting-item">
                                    <label>Animations</label>
                                    <div class="toggle-switch active" data-setting="appearance.animations">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item range-setting">
                                    <label>Transparency Level</label>
                                    <div class="range-container">
                                        <input type="range" min="0" max="0.3" step="0.1" value="0.1" data-setting="appearance.transparency" class="setting-range">
                                        <div class="range-value">10%</div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-bell"></i> Notifications</h4>
                                <div class="setting-item">
                                    <label>Enable Notifications</label>
                                    <div class="toggle-switch active" data-setting="notifications.enabled">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Notification Position</label>
                                    <select data-setting="notifications.position" class="setting-select">
                                        <option value="top-right">Top Right</option>
                                        <option value="top-left">Top Left</option>
                                        <option value="bottom-right">Bottom Right</option>
                                        <option value="bottom-left">Bottom Left</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Notification Sound</label>
                                    <div class="toggle-switch active" data-setting="notifications.sound">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Language Settings -->
                        <div class="settings-group" id="settings-language">
                            <div class="setting-section">
                                <h4><i class="fas fa-language"></i> <span data-i18n="settings.language.interfaceLanguage">Interface Language</span></h4>
                                <div class="setting-item">
                                    <label data-i18n="settings.language.interfaceLanguage">Interface Language</label>
                                    <select id="languageSelect" data-setting="app.language" class="setting-select" onchange="handleLanguageChange(this)">
                                        <option value="en">English</option>
                                        <option value="es">Espaol</option>
                                        <option value="fr">Franais</option>
                                        <option value="de">Deutsch</option>
                                        <option value="ja"></option>
                                        <option value="zh-CN"></option>
                                    </select>
                                    <small class="setting-description">Choose your preferred language for the interface</small>
                                </div>
                                <div class="setting-item">
                                    <label data-i18n="settings.language.dateFormat">Date Format</label>
                                    <select data-setting="localization.dateFormat" class="setting-select">
                                        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                        <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                        <option value="DD.MM.YYYY">DD.MM.YYYY</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label data-i18n="settings.language.timeFormat">Time Format</label>
                                    <select data-setting="localization.timeFormat" class="setting-select">
                                        <option value="12h">12 Hour (AM/PM)</option>
                                        <option value="24h">24 Hour</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label data-i18n="settings.language.numberFormat">Number Format</label>
                                    <select data-setting="localization.numberFormat" class="setting-select">
                                        <option value="en-US">1,234.56 (US)</option>
                                        <option value="de-DE">1.234,56 (German)</option>
                                        <option value="fr-FR">1 234,56 (French)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-info-circle"></i> Language Information</h4>
                                <div class="language-info" id="languageInfo">
                                    <div class="info-item">
                                        <strong>Current Language:</strong> 
                                        <span id="currentLanguageName">English</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Text Direction:</strong> 
                                        <span id="textDirection">Left to Right</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Translation Status:</strong> 
                                        <span id="translationStatus" class="status-complete">Complete</span>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-download"></i> Language Management</h4>
                                <div class="language-actions">
                                    <button class="action-btn secondary" onclick="refreshLanguages()" title="Refresh available languages">
                                        <i class="fas fa-sync-alt"></i> <span data-i18n="app.refresh">Refresh Languages</span>
                                    </button>
                                    <button class="action-btn secondary" onclick="validateTranslations()" title="Check translation completeness">
                                        <i class="fas fa-check-circle"></i> Validate Translations
                                    </button>
                                </div>
                                <div class="language-status" id="languageStatus" style="display: none;">
                                    <div class="status-message"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Updates Settings -->
                        <div class="settings-group" id="settings-updates">
                            <div class="setting-section">
                                <h4><i class="fas fa-sync-alt"></i> Auto-Update Settings</h4>
                                <div class="setting-item">
                                    <label>Automatically download updates</label>
                                    <div class="toggle-switch active" data-setting="updates.autoDownload" id="autoDownloadToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Updates will be downloaded in the background when available</small>
                                </div>
                                <div class="setting-item">
                                    <label>Install updates on quit</label>
                                    <div class="toggle-switch" data-setting="updates.autoInstall" id="autoInstallToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Updates will be installed when you close the application</small>
                                </div>
                                <div class="setting-item">
                                    <label>Check for updates on startup</label>
                                    <div class="toggle-switch active" data-setting="updates.checkOnStartup" id="checkStartupToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Automatically check for updates when the application starts</small>
                                </div>
                                <div class="setting-item">
                                    <label>Show update notifications</label>
                                    <div class="toggle-switch active" data-setting="updates.notifyUser" id="notifyUserToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Display notifications when updates are available</small>
                                </div>
                                <div class="setting-item">
                                    <label>Silent updates</label>
                                    <div class="toggle-switch" data-setting="updates.silentUpdates" id="silentUpdatesToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Download and install updates silently without user interaction</small>
                                </div>
                                <div class="setting-item">
                                    <label>Include pre-release versions</label>
                                    <div class="toggle-switch" data-setting="updates.allowPrerelease" id="prereleaseToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Check for beta and pre-release versions in addition to stable releases</small>
                                </div>
                                <div class="setting-item">
                                    <label>Check interval</label>
                                    <select data-setting="updates.checkInterval" class="setting-select" id="checkIntervalSelect">
                                        <option value="3600000">1 hour</option>
                                        <option value="7200000">2 hours</option>
                                        <option value="14400000">4 hours</option>
                                        <option value="28800000">8 hours</option>
                                        <option value="86400000">24 hours</option>
                                    </select>
                                    <small class="setting-description">How often to check for updates automatically</small>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-info-circle"></i> Update Information</h4>
                                <div class="update-info" id="updateInfo">
                                    <div class="info-item">
                                        <strong>Current Version:</strong> 
                                        <span id="currentVersion">Loading...</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Last Check:</strong> 
                                        <span id="lastUpdateCheck">Never</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Update Status:</strong> 
                                        <span id="updateStatus" class="status-up-to-date">Up to date</span>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-download"></i> Update Management</h4>
                                <div class="update-actions">
                                    <button class="action-btn primary" onclick="checkForUpdatesManually()" title="Check for updates now">
                                        <i class="fas fa-search"></i> Check for Updates
                                    </button>
                                    <button class="action-btn secondary" onclick="showUpdateHistory()" title="View update history">
                                        <i class="fas fa-history"></i> Update History
                                    </button>
                                    <button class="action-btn secondary" onclick="restartToUpdate()" title="Restart to apply pending updates" style="display: none;" id="restartButton">
                                        <i class="fas fa-redo"></i> Restart & Install
                                    </button>
                                </div>
                                <div class="update-progress" id="updateProgressContainer" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="settingsUpdateProgress"></div>
                                    </div>
                                    <div class="progress-text" id="settingsUpdateProgressText">0%</div>
                                </div>
                            </div>
                        </div>

                        <!-- Monitoring Settings -->
                        <div class="settings-group" id="settings-monitoring">
                            <div class="setting-section">
                                <h4><i class="fas fa-bug"></i> Crash Reporting</h4>
                                <div class="setting-item">
                                    <label>Enable crash reporting</label>
                                    <div class="toggle-switch" data-setting="monitoring.crashReporting.enabled" id="crashReportingToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Automatically report crashes to help improve the application</small>
                                </div>
                                <div class="setting-item">
                                    <label>Include user data in reports</label>
                                    <div class="toggle-switch" data-setting="monitoring.crashReporting.includeUserData" id="includeUserDataToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Include user data in crash reports (URLs, user actions). Disable for enhanced privacy.</small>
                                </div>
                                <div class="setting-item">
                                    <label>Include system information</label>
                                    <div class="toggle-switch active" data-setting="monitoring.crashReporting.includeSystemInfo" id="includeSystemInfoToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Include system information (OS, CPU, memory) in crash reports</small>
                                </div>
                                <div class="setting-item">
                                    <label>Include performance data</label>
                                    <div class="toggle-switch active" data-setting="monitoring.crashReporting.includePerformanceData" id="includePerformanceDataToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Include performance metrics in crash reports</small>
                                </div>
                                <div class="setting-item">
                                    <label>Local storage retention</label>
                                    <select data-setting="monitoring.crashReporting.retentionDays" class="setting-select" id="retentionDaysSelect">
                                        <option value="7">7 days</option>
                                        <option value="14">14 days</option>
                                        <option value="30">30 days</option>
                                        <option value="90">90 days</option>
                                        <option value="365">1 year</option>
                                    </select>
                                    <small class="setting-description">How long to keep crash reports locally</small>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-chart-bar"></i> Performance Monitoring</h4>
                                <div class="setting-item">
                                    <label>Monitor memory usage</label>
                                    <div class="toggle-switch active" data-setting="monitoring.performance.memoryMonitoring" id="memoryMonitoringToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Track memory usage for performance optimization</small>
                                </div>
                                <div class="setting-item">
                                    <label>Monitor CPU usage</label>
                                    <div class="toggle-switch active" data-setting="monitoring.performance.cpuMonitoring" id="cpuMonitoringToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Track CPU usage for performance optimization</small>
                                </div>
                                <div class="setting-item">
                                    <label>Track page load times</label>
                                    <div class="toggle-switch active" data-setting="monitoring.performance.pageLoadTimes" id="pageLoadTimesToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Monitor page loading performance</small>
                                </div>
                                <div class="setting-item">
                                    <label>Performance alerts</label>
                                    <div class="toggle-switch" data-setting="monitoring.performance.alerts" id="performanceAlertsToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Show alerts when performance issues are detected</small>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-bell"></i> Native Notifications</h4>
                                <div class="setting-item">
                                    <label>Enable native notifications</label>
                                    <div class="toggle-switch active" data-setting="notifications.enabled" id="notificationsEnabledToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Show system notifications for app events</small>
                                </div>
                                
                                <div class="setting-item">
                                    <label>Sound enabled</label>
                                    <div class="toggle-switch active" data-setting="notifications.soundEnabled" id="notificationsSoundToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Play sounds with notifications</small>
                                </div>
                                
                                <div class="setting-item">
                                    <label>Badge notifications</label>
                                    <div class="toggle-switch active" data-setting="notifications.badgeEnabled" id="notificationsBadgeToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Show badge count on app icon (macOS)</small>
                                </div>
                                
                                <div class="setting-item">
                                    <label>Privacy mode</label>
                                    <div class="toggle-switch" data-setting="notifications.privacyMode" id="notificationsPrivacyToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <small class="setting-description">Hide sensitive content in notifications</small>
                                </div>
                                
                                <div class="setting-item">
                                    <label>Auto-close duration</label>
                                    <select data-setting="notifications.duration" class="setting-select" id="notificationsDurationSelect">
                                        <option value="0">Never</option>
                                        <option value="3000">3 seconds</option>
                                        <option value="5000" selected>5 seconds</option>
                                        <option value="10000">10 seconds</option>
                                        <option value="15000">15 seconds</option>
                                        <option value="30000">30 seconds</option>
                                    </select>
                                    <small class="setting-description">How long notifications stay visible</small>
                                </div>
                                
                                <div class="setting-item">
                                    <label>Maximum concurrent notifications</label>
                                    <select data-setting="notifications.maxConcurrent" class="setting-select" id="notificationsMaxConcurrentSelect">
                                        <option value="1">1</option>
                                        <option value="3">3</option>
                                        <option value="5" selected>5</option>
                                        <option value="10">10</option>
                                        <option value="0">Unlimited</option>
                                    </select>
                                    <small class="setting-description">Maximum number of notifications shown at once</small>
                                </div>

                                <div class="setting-subsection">
                                    <h5><i class="fas fa-list"></i> Notification Categories</h5>
                                    
                                    <div class="setting-item">
                                        <label>System notifications</label>
                                        <div class="category-controls">
                                            <div class="toggle-switch active" data-setting="notifications.categories.system.enabled" id="notificationsSystemToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <div class="toggle-switch active" data-setting="notifications.categories.system.sound" id="notificationsSystemSoundToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <span class="control-label">Sound</span>
                                        </div>
                                        <small class="setting-description">App startup, shutdown, and system events</small>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <label>Security alerts</label>
                                        <div class="category-controls">
                                            <div class="toggle-switch active" data-setting="notifications.categories.security.enabled" id="notificationsSecurityToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <div class="toggle-switch active" data-setting="notifications.categories.security.sound" id="notificationsSecuritySoundToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <span class="control-label">Sound</span>
                                        </div>
                                        <small class="setting-description">Security warnings and threats detected</small>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <label>Update notifications</label>
                                        <div class="category-controls">
                                            <div class="toggle-switch active" data-setting="notifications.categories.updates.enabled" id="notificationsUpdatesToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <div class="toggle-switch" data-setting="notifications.categories.updates.sound" id="notificationsUpdatesSoundToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <span class="control-label">Sound</span>
                                        </div>
                                        <small class="setting-description">App updates and version changes</small>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <label>Chat messages</label>
                                        <div class="category-controls">
                                            <div class="toggle-switch active" data-setting="notifications.categories.chat.enabled" id="notificationsChatToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <div class="toggle-switch active" data-setting="notifications.categories.chat.sound" id="notificationsChatSoundToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <span class="control-label">Sound</span>
                                        </div>
                                        <small class="setting-description">New chat messages and AI responses</small>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <label>Download notifications</label>
                                        <div class="category-controls">
                                            <div class="toggle-switch active" data-setting="notifications.categories.downloads.enabled" id="notificationsDownloadsToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <div class="toggle-switch" data-setting="notifications.categories.downloads.sound" id="notificationsDownloadsSoundToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <span class="control-label">Sound</span>
                                        </div>
                                        <small class="setting-description">File downloads and transfer completion</small>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <label>Error notifications</label>
                                        <div class="category-controls">
                                            <div class="toggle-switch active" data-setting="notifications.categories.errors.enabled" id="notificationsErrorsToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <div class="toggle-switch active" data-setting="notifications.categories.errors.sound" id="notificationsErrorsSoundToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <span class="control-label">Sound</span>
                                        </div>
                                        <small class="setting-description">Application errors and crashes</small>
                                    </div>
                                    
                                    <div class="setting-item">
                                        <label>Success notifications</label>
                                        <div class="category-controls">
                                            <div class="toggle-switch active" data-setting="notifications.categories.achievements.enabled" id="notificationsAchievementsToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <div class="toggle-switch" data-setting="notifications.categories.achievements.sound" id="notificationsAchievementsSoundToggle">
                                                <div class="toggle-slider"></div>
                                            </div>
                                            <span class="control-label">Sound</span>
                                        </div>
                                        <small class="setting-description">Task completion and achievements</small>
                                    </div>
                                </div>
                                
                                <div class="setting-subsection">
                                    <h5><i class="fas fa-info-circle"></i> Notification Status</h5>
                                    <div class="notification-status" id="notificationStatus">
                                        <div class="status-item">
                                            <strong>System Support:</strong> 
                                            <span id="notificationSupport">Checking...</span>
                                        </div>
                                        <div class="status-item">
                                            <strong>Active Notifications:</strong> 
                                            <span id="activeNotificationCount">0</span>
                                        </div>
                                        <div class="status-item">
                                            <strong>Unread Count:</strong> 
                                            <span id="unreadNotificationCount">0</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-subsection">
                                    <h5><i class="fas fa-tools"></i> Notification Management</h5>
                                    <div class="notification-actions">
                                        <button class="action-btn primary" onclick="testNotification()" title="Test notification system">
                                            <i class="fas fa-bell"></i> Test Notification
                                        </button>
                                        <button class="action-btn secondary" onclick="showNotificationHistory()" title="View notification history">
                                            <i class="fas fa-history"></i> View History
                                        </button>
                                        <button class="action-btn secondary" onclick="clearNotificationHistory()" title="Clear notification history">
                                            <i class="fas fa-trash"></i> Clear History
                                        </button>
                                        <button class="action-btn warning" onclick="closeAllNotifications()" title="Close all active notifications">
                                            <i class="fas fa-times-circle"></i> Close All
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-info-circle"></i> Monitoring Information</h4>
                                <div class="monitoring-info" id="monitoringInfo">
                                    <div class="info-item">
                                        <strong>Crash Reports:</strong> 
                                        <span id="totalCrashReports">Loading...</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Last Report:</strong> 
                                        <span id="lastCrashReport">None</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Storage Used:</strong> 
                                        <span id="monitoringStorageUsed">Loading...</span>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-tools"></i> Monitoring Management</h4>
                                <div class="monitoring-actions">
                                    <button class="action-btn primary" onclick="showCrashAnalytics()" title="View crash analytics">
                                        <i class="fas fa-chart-line"></i> View Analytics
                                    </button>
                                    <button class="action-btn secondary" onclick="exportCrashReports()" title="Export crash reports">
                                        <i class="fas fa-download"></i> Export Reports
                                    </button>
                                    <button class="action-btn secondary" onclick="clearCrashReports()" title="Clear all crash reports">
                                        <i class="fas fa-trash"></i> Clear Reports
                                    </button>
                                    <button class="action-btn warning" onclick="testCrashReporting()" title="Test crash reporting system" id="testCrashButton">
                                        <i class="fas fa-bug"></i> Test Crash
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Deep Link Management -->
                        <div class="settings-group" id="settings-deeplink" style="display: none;">
                            <div class="setting-section">
                                <h4><i class="fas fa-link"></i> Deep Link Protocol</h4>
                                <div class="setting-item">
                                    <label>Protocol Registration</label>
                                    <div class="protocol-status" id="protocolStatus">
                                        <span class="status-indicator" id="protocolIndicator"></span>
                                        <span id="protocolStatusText">Checking...</span>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Enable Deep Links</label>
                                    <div class="toggle-switch active" data-setting="deeplink.enabled" id="deeplinkEnabledToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Security Validation</label>
                                    <div class="toggle-switch active" data-setting="deeplink.enableSecurityValidation" id="deeplinkSecurityToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Link History</label>
                                    <div class="toggle-switch active" data-setting="deeplink.enableHistory" id="deeplinkHistoryToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Maximum URL Length</label>
                                    <input type="number" min="512" max="8192" value="2048" data-setting="deeplink.maxUrlLength" id="deeplinkMaxLength" class="setting-input">
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-route"></i> Supported Actions</h4>
                                <div class="deeplink-actions-list">
                                    <div class="action-item">
                                        <span class="action-name">open</span>
                                        <span class="action-description">Open external URLs</span>
                                        <code>mic-browser://open?url=https://example.com</code>
                                    </div>
                                    <div class="action-item">
                                        <span class="action-name">chat</span>
                                        <span class="action-description">Navigate to chat</span>
                                        <code>mic-browser://chat?room=general&message=hello</code>
                                    </div>
                                    <div class="action-item">
                                        <span class="action-name">search</span>
                                        <span class="action-description">Perform search</span>
                                        <code>mic-browser://search?q=search+terms</code>
                                    </div>
                                    <div class="action-item">
                                        <span class="action-name">settings</span>
                                        <span class="action-description">Open settings</span>
                                        <code>mic-browser://settings?section=general</code>
                                    </div>
                                    <div class="action-item">
                                        <span class="action-name">ocr</span>
                                        <span class="action-description">Trigger OCR</span>
                                        <code>mic-browser://ocr?file=path&lang=en</code>
                                    </div>
                                    <div class="action-item">
                                        <span class="action-name">transfer</span>
                                        <span class="action-description">Handle data transfer</span>
                                        <code>mic-browser://transfer?id=123&action=receive</code>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-tools"></i> Deep Link Testing</h4>
                                <div class="deeplink-tester">
                                    <div class="setting-item">
                                        <label>Test URL</label>
                                        <input type="text" placeholder="mic-browser://search?q=example" id="deeplinkTestUrl" class="setting-input">
                                    </div>
                                    <div class="setting-item">
                                        <button class="action-btn primary" onclick="testDeepLink()" title="Test deep link">
                                            <i class="fas fa-play"></i> Test Link
                                        </button>
                                        <button class="action-btn secondary" onclick="generateDeepLink()" title="Generate deep link">
                                            <i class="fas fa-magic"></i> Generate Link
                                        </button>
                                    </div>
                                    <div class="test-result" id="deeplinkTestResult" style="display: none;">
                                        <h5>Test Result:</h5>
                                        <pre id="deeplinkTestOutput"></pre>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-history"></i> Deep Link History</h4>
                                <div class="deeplink-history">
                                    <div class="history-stats" id="deeplinkStats">
                                        <div class="stat-item">
                                            <strong>Total Links:</strong> 
                                            <span id="totalDeepLinks">0</span>
                                        </div>
                                        <div class="stat-item">
                                            <strong>Valid Links:</strong> 
                                            <span id="validDeepLinks">0</span>
                                        </div>
                                        <div class="stat-item">
                                            <strong>Rejected Links:</strong> 
                                            <span id="rejectedDeepLinks">0</span>
                                        </div>
                                        <div class="stat-item">
                                            <strong>Last Activity:</strong> 
                                            <span id="lastDeepLinkActivity">Never</span>
                                        </div>
                                    </div>
                                    <div class="history-actions">
                                        <button class="action-btn secondary" onclick="showDeepLinkHistory()" title="View deep link history">
                                            <i class="fas fa-list"></i> View History
                                        </button>
                                        <button class="action-btn warning" onclick="clearDeepLinkHistory()" title="Clear deep link history">
                                            <i class="fas fa-trash"></i> Clear History
                                        </button>
                                    </div>
                                    <div class="history-list" id="deeplinkHistoryList" style="display: none;">
                                        <!-- History items will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-shield-alt"></i> Security Settings</h4>
                                <div class="setting-item">
                                    <label>Blocked Patterns</label>
                                    <div class="security-rules">
                                        <input type="text" placeholder="Enter regex pattern to block" id="securityRuleInput" class="setting-input">
                                        <button class="action-btn secondary" onclick="addSecurityRule()" title="Add security rule">
                                            <i class="fas fa-plus"></i> Add Rule
                                        </button>
                                    </div>
                                    <div class="rules-list" id="securityRulesList">
                                        <!-- Security rules will be listed here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Tray Management -->
                        <div class="settings-group" id="settings-systemtray" style="display: none;">
                            <div class="setting-section">
                                <h4><i class="fas fa-window-minimize"></i> System Tray Behavior</h4>
                                <div class="setting-item">
                                    <label>Enable System Tray</label>
                                    <div class="toggle-switch active" data-setting="systemTray.enabled" id="systemTrayEnabledToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Minimize to Tray</label>
                                    <div class="toggle-switch active" data-setting="systemTray.minimizeToTray" id="minimizeToTrayToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Close to Tray</label>
                                    <div class="toggle-switch" data-setting="systemTray.closeToTray" id="closeToTrayToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Start Minimized</label>
                                    <div class="toggle-switch" data-setting="systemTray.startMinimized" id="startMinimizedToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-bell"></i> Tray Notifications</h4>
                                <div class="setting-item">
                                    <label>Show Notifications</label>
                                    <div class="toggle-switch active" data-setting="systemTray.showNotifications" id="trayNotificationsToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Auto-hide Timeout</label>
                                    <select data-setting="systemTray.notificationTimeout" id="notificationTimeoutSelect" class="setting-select">
                                        <option value="3000">3 seconds</option>
                                        <option value="5000" selected>5 seconds</option>
                                        <option value="10000">10 seconds</option>
                                        <option value="0">Never</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Notification Types</label>
                                    <div class="checkbox-group">
                                        <label><input type="checkbox" class="tray-checkbox" data-setting="systemTray.notifications.info" checked> Info</label>
                                        <label><input type="checkbox" class="tray-checkbox" data-setting="systemTray.notifications.warning" checked> Warnings</label>
                                        <label><input type="checkbox" class="tray-checkbox" data-setting="systemTray.notifications.error" checked> Errors</label>
                                        <label><input type="checkbox" class="tray-checkbox" data-setting="systemTray.notifications.success" checked> Success</label>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-mouse-pointer"></i> Quick Actions</h4>
                                <div class="setting-item">
                                    <label>Enable Quick Actions</label>
                                    <div class="toggle-switch active" data-setting="systemTray.enableQuickActions" id="quickActionsToggle">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Available Actions</label>
                                    <div class="checkbox-group">
                                        <label><input type="checkbox" class="tray-checkbox" data-setting="systemTray.quickActions.newChat" checked> New Chat</label>
                                        <label><input type="checkbox" class="tray-checkbox" data-setting="systemTray.quickActions.openOcr" checked> OCR Scanner</label>
                                        <label><input type="checkbox" class="tray-checkbox" data-setting="systemTray.quickActions.openTransfer" checked> Data Transfer</label>
                                        <label><input type="checkbox" class="tray-checkbox" data-setting="systemTray.quickActions.openSettings" checked> Settings</label>
                                        <label><input type="checkbox" class="tray-checkbox" data-setting="systemTray.quickActions.viewAnalytics" checked> Analytics</label>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-chart-bar"></i> Tray Statistics</h4>
                                <div class="tray-statistics" id="trayStatistics">
                                    <div class="tray-stat-item">
                                        <div class="tray-stat-value" id="totalTrayActions">0</div>
                                        <div class="tray-stat-label">Total Actions</div>
                                    </div>
                                    <div class="tray-stat-item">
                                        <div class="tray-stat-value" id="trayNotificationsSent">0</div>
                                        <div class="tray-stat-label">Notifications</div>
                                    </div>
                                    <div class="tray-stat-item">
                                        <div class="tray-stat-value" id="trayMinimizeCount">0</div>
                                        <div class="tray-stat-label">Minimized</div>
                                    </div>
                                    <div class="tray-stat-item">
                                        <div class="tray-stat-value" id="trayRestoreCount">0</div>
                                        <div class="tray-stat-label">Restored</div>
                                    </div>
                                </div>
                                <div class="tray-quick-actions">
                                    <button class="tray-quick-button" onclick="refreshTrayStatistics()" title="Refresh statistics">
                                        <i class="fas fa-sync"></i> Refresh Stats
                                    </button>
                                    <button class="tray-quick-button" onclick="clearTrayStatistics()" title="Clear statistics">
                                        <i class="fas fa-trash"></i> Clear Stats
                                    </button>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-tools"></i> System Tray Testing</h4>
                                <div class="tray-notification-test">
                                    <div class="setting-item">
                                        <label>Test Notification</label>
                                        <div class="notification-test-controls">
                                            <input type="text" placeholder="Notification title" id="testNotificationTitle" class="setting-input" value="Test Notification">
                                            <input type="text" placeholder="Notification message" id="testNotificationMessage" class="setting-input" value="This is a test notification from system tray">
                                            <select id="testNotificationType" class="setting-select">
                                                <option value="info">Info</option>
                                                <option value="warning">Warning</option>
                                                <option value="error">Error</option>
                                                <option value="success">Success</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="setting-item">
                                        <button class="action-btn primary" onclick="testTrayNotification()" title="Test tray notification">
                                            <i class="fas fa-bell"></i> Test Notification
                                        </button>
                                        <button class="action-btn secondary" onclick="testTrayTooltip()" title="Test tray tooltip">
                                            <i class="fas fa-tag"></i> Test Tooltip
                                        </button>
                                        <button class="action-btn secondary" onclick="toggleTrayVisibility()" title="Toggle tray visibility">
                                            <i class="fas fa-eye"></i> Toggle Tray
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="settings-group" id="settings-advanced">
                            <div class="setting-section">
                                <h4><i class="fas fa-rocket"></i> Performance</h4>
                                <div class="setting-item">
                                    <label>Memory Usage</label>
                                    <select data-setting="performance.memoryUsage" class="setting-select">
                                        <option value="low">Low</option>
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Background Tabs</label>
                                    <select data-setting="performance.backgroundTabs" class="setting-select">
                                        <option value="active">Keep Active</option>
                                        <option value="suspend">Suspend</option>
                                        <option value="unload">Unload</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Hardware Acceleration</label>
                                    <div class="toggle-switch active" data-setting="performance.hardwareAcceleration">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-magic"></i> Automation</h4>
                                <div class="setting-item">
                                    <label>Auto-Record Workflows</label>
                                    <div class="toggle-switch" data-setting="workflow.autoRecording">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Smart Suggestions</label>
                                    <div class="toggle-switch active" data-setting="workflow.smartSuggestions">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Backup Workflows</label>
                                    <div class="toggle-switch active" data-setting="workflow.backupWorkflows">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-scan"></i> OCR & Document Scanning</h4>
                                <div class="setting-item">
                                    <label>Default Language</label>
                                    <select data-setting="ocr.defaultLanguage" class="setting-select">
                                        <option value="eng">English</option>
                                        <option value="spa">Spanish</option>
                                        <option value="fra">French</option>
                                        <option value="deu">German</option>
                                        <option value="ita">Italian</option>
                                        <option value="por">Portuguese</option>
                                        <option value="rus">Russian</option>
                                        <option value="chi_sim">Chinese (Simplified)</option>
                                        <option value="chi_tra">Chinese (Traditional)</option>
                                        <option value="jpn">Japanese</option>
                                        <option value="kor">Korean</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Scan Mode</label>
                                    <select data-setting="ocr.scanMode" class="setting-select">
                                        <option value="3">Auto (Default)</option>
                                        <option value="6">Single Block</option>
                                        <option value="7">Single Line</option>
                                        <option value="8">Single Word</option>
                                        <option value="13">Raw Text</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label>Preserve Word Spacing</label>
                                    <div class="toggle-switch" data-setting="ocr.preserveSpaces">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Auto Image Enhancement</label>
                                    <div class="toggle-switch" data-setting="ocr.autoEnhance">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Output Format</label>
                                    <select data-setting="ocr.outputFormat" class="setting-select">
                                        <option value="text">Plain Text</option>
                                        <option value="json">JSON Data</option>
                                        <option value="structured">Structured Text</option>
                                    </select>
                                </div>
                            </div>

                            <div class="setting-section">
                                <h4><i class="fas fa-code"></i> Developer</h4>
                                <div class="setting-item">
                                    <label>Debug Mode</label>
                                    <div class="toggle-switch" data-setting="developer.debugMode">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Show Console</label>
                                    <div class="toggle-switch" data-setting="developer.showConsole">
                                        <div class="toggle-slider"></div>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <label>Log Level</label>
                                    <select data-setting="developer.logLevel" class="setting-select">
                                        <option value="debug">Debug</option>
                                        <option value="info">Info</option>
                                        <option value="warn">Warning</option>
                                        <option value="error">Error</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="content-area">
            <div class="webview-container" id="webviewContainer">
                <!-- Demo Showcase -->
                <div class="demo-showcase" id="demoContent">
                    <div class="showcase-header">
                        <h1 class="showcase-title">MIC Browser Ultimate</h1>
                        <p class="showcase-subtitle">
                            The world's first truly intelligent browser that thinks, learns, and automates alongside you. 
                            Experience the future of web interaction powered by advanced AI, OCR, and predictive automation.
                        </p>
                    </div>

                    <div class="feature-showcase">
                        <div class="feature-demo">
                            <div class="feature-icon-large">
                                <i class="fas fa-brain"></i>
                            </div>
                            <h3>Advanced AI Assistant</h3>
                            <p>Claude-powered AI that understands context, automates workflows, and learns from your behavior to predict and execute tasks before you even ask.</p>
                            <button class="demo-button" onclick="demoAI()">Try AI Features</button>
                        </div>

                        <div class="feature-demo">
                            <div class="feature-icon-large">
                                <i class="fas fa-camera"></i>
                            </div>
                            <h3>Intelligent Document Scanning</h3>
                            <p>Scan any document with advanced OCR, AI-enhanced extraction, and automatic form population. Works with IDs, invoices, forms, and more.</p>
                            <button class="demo-button" onclick="demoScan()">Scan Document</button>
                        </div>

                        <div class="feature-demo">
                            <div class="feature-icon-large">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <h3>Workflow Automation</h3>
                            <p>Create, record, and execute complex workflows across any web application. AI-powered workflow generation and optimization included.</p>
                            <button class="demo-button" onclick="demoWorkflow()">Create Workflow</button>
                        </div>

                        <div class="feature-demo">
                            <div class="feature-icon-large">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <h3>Universal Data Transfer</h3>
                            <p>Seamlessly transfer data between any web applications with intelligent field mapping, validation, and error handling.</p>
                            <button class="demo-button" onclick="demoTransfer()">Transfer Data</button>
                        </div>

                        <div class="feature-demo">
                            <div class="feature-icon-large">
                                <i class="fas fa-microphone"></i>
                            </div>
                            <h3>Voice Commands</h3>
                            <p>Control everything with natural language voice commands. "Fill this form," "Transfer customer data," or "Generate a report."</p>
                            <button class="demo-button" onclick="demoVoice()">Voice Demo</button>
                        </div>

                        <div class="feature-demo">
                            <div class="feature-icon-large">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3>Predictive Analytics</h3>
                            <p>AI analyzes your patterns and provides insights, optimization suggestions, and predictive automation recommendations.</p>
                            <button class="demo-button" onclick="demoAnalytics()">View Analytics</button>
                        </div>

                        <div class="feature-demo">
                            <div class="feature-icon-large">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h3>Enterprise Security</h3>
                            <p>Bank-level encryption, audit logging, compliance management, and biometric authentication for enterprise environments.</p>
                            <button class="demo-button" onclick="demoSecurity()">Security Features</button>
                        </div>

                        <div class="feature-demo">
                            <div class="feature-icon-large">
                                <i class="fas fa-users"></i>
                            </div>
                            <h3>Team Collaboration</h3>
                            <p>Share workflows, collaborate in real-time, and build collective intelligence across your entire organization.</p>
                            <button class="demo-button" onclick="demoCollaboration()">Team Features</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Document Scanner Modal -->
    <div id="documentScannerModal" class="modal-overlay" style="display: none;">
        <div class="modal-content document-scanner">
            <div class="modal-header">
                <h3><i class="fas fa-scan"></i> Document Scanner</h3>
                <button class="modal-close" onclick="closeDocumentScanner()">&times;</button>
            </div>
            
            <div class="scanner-content">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-zone" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <h4>Drop your document here</h4>
                        <p>or <span class="upload-link" onclick="document.getElementById('imageInput').click()">browse files</span></p>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
                        <div class="supported-formats">
                            <small>Supports: JPG, PNG, PDF, WEBP, BMP, TIFF</small>
                        </div>
                    </div>
                </div>
                
                <div class="scanner-options">
                    <div class="options-tabs">
                        <button class="option-tab active" onclick="switchOptionsTab('basic')">Basic</button>
                        <button class="option-tab" onclick="switchOptionsTab('advanced')">Advanced</button>
                        <button class="option-tab" onclick="switchOptionsTab('preprocessing')">Preprocessing</button>
                    </div>
                    
                    <div class="option-panel" id="basicOptions">
                        <div class="option-group">
                            <label for="ocrLanguage">Language:</label>
                            <select id="ocrLanguage">
                                <option value="eng">English</option>
                                <option value="spa">Spanish</option>
                                <option value="fra">French</option>
                                <option value="deu">German</option>
                                <option value="ita">Italian</option>
                                <option value="por">Portuguese</option>
                                <option value="rus">Russian</option>
                                <option value="chi_sim">Chinese (Simplified)</option>
                                <option value="chi_tra">Chinese (Traditional)</option>
                                <option value="jpn">Japanese</option>
                                <option value="kor">Korean</option>
                                <option value="ara">Arabic</option>
                                <option value="hin">Hindi</option>
                            </select>
                        </div>
                        
                        <div class="option-group">
                            <label for="ocrMode">Page Segmentation:</label>
                            <select id="ocrMode">
                                <option value="3">Auto Detection (Recommended)</option>
                                <option value="6">Single Uniform Block</option>
                                <option value="7">Single Text Line</option>
                                <option value="8">Single Word</option>
                                <option value="10">Single Character</option>
                                <option value="13">Raw Line (No Layout)</option>
                            </select>
                        </div>
                        
                        <div class="option-group">
                            <label for="confidenceThreshold">Confidence Threshold:</label>
                            <input type="range" id="confidenceThreshold" min="0" max="100" value="60" 
                                   oninput="updateConfidenceDisplay(this.value)">
                            <span class="range-value" id="confidenceValue">60%</span>
                        </div>
                    </div>
                    
                    <div class="option-panel" id="advancedOptions" style="display: none;">
                        <div class="option-group">
                            <label>Text Processing:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="preserveSpaces" checked> Preserve Word Spacing</label>
                                <label><input type="checkbox" id="preserveFormatting" checked> Preserve Formatting</label>
                                <label><input type="checkbox" id="fixCommonErrors" checked> Fix Common OCR Errors</label>
                                <label><input type="checkbox" id="filterLowConfidence" checked> Filter Low Confidence Words</label>
                            </div>
                        </div>
                        
                        <div class="option-group">
                            <label>Result Enhancement:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="enhanceResults" checked> Enhance Results</label>
                                <label><input type="checkbox" id="detectOrientation"> Auto-Detect Orientation</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="option-panel" id="preprocessingOptions" style="display: none;">
                        <div class="option-group">
                            <label>Image Enhancement:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="preprocessImage" checked> Enable Preprocessing</label>
                                <label><input type="checkbox" id="enhanceContrast" checked> Enhance Contrast</label>
                                <label><input type="checkbox" id="sharpenImage" checked> Sharpen Text</label>
                                <label><input type="checkbox" id="denoiseImage" checked> Remove Noise</label>
                            </div>
                        </div>
                        
                        <div class="option-group">
                            <label for="imageQuality">Processing Quality:</label>
                            <select id="imageQuality">
                                <option value="fast">Fast (Lower Quality)</option>
                                <option value="balanced" selected>Balanced</option>
                                <option value="high">High Quality (Slower)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="scan-progress" id="scanProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Initializing OCR...</div>
                </div>
                
                <div class="scan-results" id="scanResults" style="display: none;">
                    <div class="results-header">
                        <h4>Extracted Text</h4>
                        <div class="results-actions">
                            <button class="btn-secondary" onclick="copyText()">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="btn-secondary" onclick="downloadText()">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="btn-secondary" onclick="exportResults()">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                            <button class="btn-secondary" onclick="sendToAI()">
                                <i class="fas fa-robot"></i> Send to AI
                            </button>
                        </div>
                    </div>
                    
                    <div class="results-tabs">
                        <button class="result-tab active" onclick="switchResultsTab('text')">Text</button>
                        <button class="result-tab" onclick="switchResultsTab('formatted')">Formatted</button>
                        <button class="result-tab" onclick="switchResultsTab('analysis')">Analysis</button>
                    </div>
                    
                    <div class="result-panel" id="textResults">
                        <textarea id="extractedText" rows="10" placeholder="Extracted text will appear here..."></textarea>
                    </div>
                    
                    <div class="result-panel" id="formattedResults" style="display: none;">
                        <div class="formatted-text" id="formattedText"></div>
                    </div>
                    
                    <div class="result-panel" id="analysisResults" style="display: none;">
                        <div class="analysis-grid">
                            <div class="analysis-item">
                                <label>Processing Time:</label>
                                <span id="processingTime">--</span>
                            </div>
                            <div class="analysis-item">
                                <label>Overall Confidence:</label>
                                <span id="overallConfidence">--</span>
                            </div>
                            <div class="analysis-item">
                                <label>Word Count:</label>
                                <span id="wordCount">0</span>
                            </div>
                            <div class="analysis-item">
                                <label>Line Count:</label>
                                <span id="lineCount">0</span>
                            </div>
                            <div class="analysis-item">
                                <label>Language Detected:</label>
                                <span id="detectedLanguage">--</span>
                            </div>
                            <div class="analysis-item">
                                <label>Preprocessing:</label>
                                <span id="preprocessingStatus">--</span>
                            </div>
                        </div>
                        
                        <div class="confidence-distribution">
                            <h5>Confidence Distribution</h5>
                            <div class="confidence-bars" id="confidenceBars"></div>
                        </div>
                    </div>
                    
                    <div class="results-footer">
                        <div class="quick-stats">
                            <span class="stat">Confidence: <span id="confidenceScore" class="confidence-badge">0%</span></span>
                            <span class="stat">Words: <span id="quickWordCount">0</span></span>
                            <span class="stat">Quality: <span id="qualityIndicator" class="quality-badge">--</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Assistant -->
    <div class="floating-assistant" onclick="toggleAssistant()" title="MIC AI Assistant">
        <i class="fas fa-robot"></i>
    </div>

    <!-- Command Palette -->
    <div class="command-palette" id="commandPalette">
        <div class="command-palette-header">
            <input type="text" class="command-palette-input" id="commandPaletteInput" 
                   placeholder="Type a command, search, or ask AI anything..."
                   autocomplete="off">
        </div>
        <div class="command-palette-results" id="commandPaletteResults">
            <div class="command-category">Navigation</div>
            <div class="command-suggestion" data-command="go to google.com">
                <div class="suggestion-name">navigate</div>
                <div class="suggestion-description">Navigate to a URL or search</div>
                <div class="suggestion-usage">navigate &lt;url|search term&gt;</div>
            </div>
            <div class="command-category">Tabs</div>
            <div class="command-suggestion" data-command="new tab">
                <div class="suggestion-name">newtab</div>
                <div class="suggestion-description">Create a new tab</div>
                <div class="suggestion-usage">newtab [url]</div>
            </div>
        </div>
    </div>

    <!-- Update Modal -->
    <div id="updateModal" class="modal-overlay" style="display: none;">
        <div class="modal-content update-modal">
            <div class="modal-header">
                <h3><i class="fas fa-download"></i> <span id="updateModalTitle">Update Available</span></h3>
                <button class="modal-close" onclick="closeUpdateModal()">&times;</button>
            </div>
            
            <div class="update-content">
                <div class="update-info" id="updateInfo">
                    <div class="update-version">
                        <div class="version-badge">
                            <span class="current-version">Current: <span id="currentVersion">1.0.0</span></span>
                            <i class="fas fa-arrow-right"></i>
                            <span class="new-version">New: <span id="newVersion">1.0.0</span></span>
                        </div>
                    </div>
                    
                    <div class="update-description">
                        <h4>What's New:</h4>
                        <div class="release-notes" id="releaseNotes">
                            <p>Loading release notes...</p>
                        </div>
                    </div>
                    
                    <div class="update-progress" id="updateProgress" style="display: none;">
                        <div class="progress-info">
                            <span class="progress-text" id="progressText">Preparing download...</span>
                            <span class="progress-percentage" id="progressPercentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                        </div>
                        <div class="progress-details">
                            <span class="download-speed" id="downloadSpeed">0 KB/s</span>
                            <span class="download-size" id="downloadSize">0 MB / 0 MB</span>
                        </div>
                    </div>
                </div>
                
                <div class="update-actions">
                    <button class="btn btn-secondary" id="updateLaterBtn" onclick="closeUpdateModal()">
                        <i class="fas fa-clock"></i> Later
                    </button>
                    <button class="btn btn-primary" id="downloadUpdateBtn" onclick="downloadUpdate()">
                        <i class="fas fa-download"></i> Download Update
                    </button>
                    <button class="btn btn-success" id="restartBtn" onclick="restartAndUpdate()" style="display: none;">
                        <i class="fas fa-sync-alt"></i> Restart & Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cross-Tab Data Transfer Modal -->
    <div id="crossTabTransferModal" class="modal-overlay" style="display: none;">
        <div class="modal-content cross-tab-transfer">
            <div class="modal-header">
                <h3><i class="fas fa-exchange-alt"></i> Cross-Tab Data Transfer</h3>
                <button class="modal-close" onclick="closeCrossTabTransfer()">&times;</button>
            </div>
            
            <div class="transfer-content">
                <div class="transfer-tabs">
                    <button class="transfer-tab active" onclick="switchTransferTab('transfer')">Transfer Data</button>
                    <button class="transfer-tab" onclick="switchTransferTab('monitor')">Monitor</button>
                    <button class="transfer-tab" onclick="switchTransferTab('settings')">Settings</button>
                    <button class="transfer-tab" onclick="switchTransferTab('history')">History</button>
                </div>
                
                <!-- Transfer Tab -->
                <div class="transfer-panel" id="transferPanel">
                    <div class="tab-selection">
                        <div class="tab-group">
                            <label>Source Tab:</label>
                            <select id="sourceTabSelect" onchange="updateTransferPreview()">
                                <option value="">Select source tab...</option>
                            </select>
                        </div>
                        <div class="tab-group">
                            <label>Target Tab:</label>
                            <select id="targetTabSelect" onchange="updateTransferPreview()">
                                <option value="">Select target tab...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="data-selection">
                        <h4>Data to Transfer:</h4>
                        <div class="data-types">
                            <label><input type="checkbox" id="transferForm" checked> Form Data</label>
                            <label><input type="checkbox" id="transferBookmarks"> Bookmarks</label>
                            <label><input type="checkbox" id="transferSettings"> Settings</label>
                            <label><input type="checkbox" id="transferCustom"> Custom Data</label>
                        </div>
                    </div>
                    
                    <div class="transfer-options">
                        <div class="option-group">
                            <h4>Transfer Options:</h4>
                            <label><input type="checkbox" id="compressData" checked> Compress Large Data</label>
                            <label><input type="checkbox" id="encryptSensitive" checked> Encrypt Sensitive Data</label>
                            <label><input type="checkbox" id="enableSync" checked> Enable Real-time Sync</label>
                            <label><input type="checkbox" id="resolveConflicts" checked> Auto-resolve Conflicts</label>
                        </div>
                    </div>
                    
                    <div class="transfer-preview" id="transferPreview" style="display: none;">
                        <h4>Transfer Preview:</h4>
                        <div class="preview-content" id="previewContent"></div>
                    </div>
                    
                    <div class="transfer-actions">
                        <button class="btn btn-secondary" onclick="previewTransfer()">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button class="btn btn-primary" onclick="startDataTransfer()">
                            <i class="fas fa-exchange-alt"></i> Start Transfer
                        </button>
                    </div>
                </div>
                
                <!-- Monitor Tab -->
                <div class="transfer-panel" id="monitorPanel" style="display: none;">
                    <div class="active-transfers">
                        <h4>Active Transfers:</h4>
                        <div class="transfers-list" id="activeTransfersList">
                            <div class="no-transfers">No active transfers</div>
                        </div>
                    </div>
                    
                    <div class="tab-status">
                        <h4>Tab Status:</h4>
                        <div class="tabs-list" id="tabStatusList"></div>
                    </div>
                    
                    <div class="metrics-display">
                        <h4>Transfer Metrics:</h4>
                        <div class="metrics-grid" id="metricsGrid">
                            <div class="metric-item">
                                <span class="metric-label">Total Transfers:</span>
                                <span class="metric-value" id="totalTransfers">0</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Success Rate:</span>
                                <span class="metric-value" id="successRate">0%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Data Transferred:</span>
                                <span class="metric-value" id="dataTransferred">0 KB</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Avg. Speed:</span>
                                <span class="metric-value" id="avgSpeed">0 ms</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings Tab -->
                <div class="transfer-panel" id="settingsPanel" style="display: none;">
                    <div class="settings-group">
                        <h4>Transfer Settings:</h4>
                        <div class="setting-item">
                            <label for="maxTransferSize">Max Transfer Size (MB):</label>
                            <input type="number" id="maxTransferSize" value="10" min="1" max="100">
                        </div>
                        <div class="setting-item">
                            <label for="compressionThreshold">Compression Threshold (KB):</label>
                            <input type="number" id="compressionThreshold" value="1" min="0.1" step="0.1">
                        </div>
                        <div class="setting-item">
                            <label for="syncInterval">Sync Interval (seconds):</label>
                            <input type="number" id="syncInterval" value="5" min="1" max="60">
                        </div>
                        <div class="setting-item">
                            <label for="maxRetries">Max Retries:</label>
                            <input type="number" id="maxRetries" value="3" min="1" max="10">
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h4>Security Settings:</h4>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="enableEncryption" checked> Enable Data Encryption</label>
                            <label><input type="checkbox" id="requireAuth"> Require Authentication</label>
                            <label><input type="checkbox" id="auditTransfers" checked> Audit Transfer Log</label>
                            <label><input type="checkbox" id="autoCleanup" checked> Auto-cleanup Old Transfers</label>
                        </div>
                    </div>
                    
                    <div class="settings-actions">
                        <button class="btn btn-secondary" onclick="resetTransferSettings()">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                        <button class="btn btn-primary" onclick="saveTransferSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
                
                <!-- History Tab -->
                <div class="transfer-panel" id="historyPanel" style="display: none;">
                    <div class="history-filters">
                        <div class="filter-group">
                            <label for="historyFilter">Filter by:</label>
                            <select id="historyFilter" onchange="filterTransferHistory()">
                                <option value="all">All Transfers</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button class="btn btn-secondary" onclick="clearTransferHistory()">
                                <i class="fas fa-trash"></i> Clear History
                            </button>
                            <button class="btn btn-secondary" onclick="exportTransferHistory()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="history-list" id="transferHistoryList">
                        <div class="no-history">No transfer history available</div>
                    </div>
                </div>
                
                <!-- Transfer Progress -->
                <div class="transfer-progress" id="transferProgress" style="display: none;">
                    <div class="progress-info">
                        <span id="transferStatus">Preparing transfer...</span>
                        <span id="transferPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="transferProgressFill"></div>
                    </div>
                    <div class="progress-details" id="transferDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Initializing MIC Browser...</div>
            <div class="loading-progress" id="loadingProgress">Loading AI systems...</div>
        </div>
    </div>

    <!-- Diagnostic Scripts for Debugging Loading Issues -->
    <!-- Note: These scripts can cause conflicts with preload APIs - enable only for debugging -->
    <!-- <script src="diagnostic-loader.js"></script> -->
    <!-- <script src="init-diagnostic.js"></script> -->
    <!-- <script src="security-hang-bypass.js"></script> -->
    
    <!-- Command Parser Script -->
    <script src="CommandParser.js"></script>

    <!-- JavaScript -->
    <script>
        
        // Comprehensive Settings Management System
        class SettingsManager {
            constructor() {
                this.settings = new Map();
                this.observers = new Map();
                this.storageKey = 'micBrowserSettings';
                
                this.initializeDefaultSettings();
                this.loadSettings();
                this.setupEventListeners();
            }

            initializeDefaultSettings() {
                // AI & Assistant Settings
                this.setDefault('ai.predictiveMode', true);
                this.setDefault('ai.autoLearning', true);
                this.setDefault('ai.voiceCommands', true);
                this.setDefault('ai.responseSpeed', 'balanced'); // 'fast', 'balanced', 'accurate'
                this.setDefault('ai.model', 'claude-3-sonnet');
                this.setDefault('ai.contextMemory', true);
                this.setDefault('ai.proactiveAssistance', true);

                // Browser Settings
                this.setDefault('browser.defaultSearchEngine', 'google');
                this.setDefault('browser.homepage', 'about:blank');
                this.setDefault('browser.newTabBehavior', 'homepage'); // 'homepage', 'blank', 'previous'
                this.setDefault('browser.tabPosition', 'top');
                this.setDefault('browser.showTabPreviews', true);
                this.setDefault('browser.enableDragReorder', true);
                this.setDefault('browser.closeTabsOnExit', true);

                // Privacy & Security
                this.setDefault('security.encryption', true);
                this.setDefault('security.auditLogging', true);
                this.setDefault('security.biometricAuth', false);
                this.setDefault('security.cookiePolicy', 'strict'); // 'allow', 'strict', 'block'
                this.setDefault('security.trackingProtection', true);
                this.setDefault('security.autoUpdates', true);

                // Appearance & Theme
                this.setDefault('appearance.theme', 'dark'); // 'dark', 'light', 'auto'
                this.setDefault('appearance.fontSize', 'medium'); // 'small', 'medium', 'large'
                this.setDefault('appearance.sidebarPosition', 'right'); // 'left', 'right'
                this.setDefault('appearance.compactMode', false);
                this.setDefault('appearance.animations', true);
                this.setDefault('appearance.transparency', 0.1);

                // Performance
                this.setDefault('performance.memoryUsage', 'normal'); // 'low', 'normal', 'high'
                this.setDefault('performance.backgroundTabs', 'suspend'); // 'active', 'suspend', 'unload'
                this.setDefault('performance.preloadPages', true);
                this.setDefault('performance.hardwareAcceleration', true);

                // Workflow & Automation
                this.setDefault('workflow.autoRecording', false);
                this.setDefault('workflow.smartSuggestions', true);
                this.setDefault('workflow.executeOnConfidence', 0.8);
                this.setDefault('workflow.backupWorkflows', true);

                // Voice & Audio
                this.setDefault('voice.language', 'en-US');
                this.setDefault('voice.sensitivity', 'medium'); // 'low', 'medium', 'high'
                this.setDefault('voice.wakWord', 'Hey MIC');
                this.setDefault('voice.continuous', false);
                this.setDefault('voice.feedback', true);

                // Notifications
                this.setDefault('notifications.enabled', true);
                this.setDefault('notifications.position', 'top-right');
                this.setDefault('notifications.duration', 3000);
                this.setDefault('notifications.sound', true);

                // OCR & Document Scanning
                this.setDefault('ocr.defaultLanguage', 'eng');
                this.setDefault('ocr.scanMode', 3); // Page segmentation mode
                this.setDefault('ocr.preserveSpaces', true);
                this.setDefault('ocr.confidenceThreshold', 0.7);
                this.setDefault('ocr.autoEnhance', true);
                this.setDefault('ocr.outputFormat', 'text'); // 'text', 'json', 'structured'

                // Developer Settings
                this.setDefault('developer.debugMode', false);
                this.setDefault('developer.showConsole', false);
                this.setDefault('developer.logLevel', 'info'); // 'debug', 'info', 'warn', 'error'
            }

            setDefault(key, value) {
                if (!this.settings.has(key)) {
                    this.settings.set(key, value);
                }
            }

            get(key, defaultValue = null) {
                return this.settings.get(key) || defaultValue;
            }

            set(key, value) {
                const oldValue = this.settings.get(key);
                this.settings.set(key, value);
                
                // Save to storage
                this.saveSettings();
                
                // Notify observers
                this.notifyObservers(key, value, oldValue);
                
                // Apply setting immediately
                this.applySettingChange(key, value);
                
                return this;
            }

            // Observe setting changes
            observe(key, callback) {
                if (!this.observers.has(key)) {
                    this.observers.set(key, []);
                }
                this.observers.get(key).push(callback);
            }

            notifyObservers(key, newValue, oldValue) {
                const callbacks = this.observers.get(key);
                if (callbacks) {
                    callbacks.forEach(callback => {
                        try {
                            callback(newValue, oldValue, key);
                        } catch (error) {
                            console.error('Settings observer error:', error);
                        }
                    });
                }
            }

            applySettingChange(key, value) {
                switch (key) {
                    case 'appearance.theme':
                        this.applyTheme(value);
                        break;
                    case 'appearance.fontSize':
                        this.applyFontSize(value);
                        break;
                    case 'appearance.sidebarPosition':
                        this.applySidebarPosition(value);
                        break;
                    case 'appearance.animations':
                        this.applyAnimations(value);
                        break;
                    case 'appearance.transparency':
                        this.applyTransparency(value);
                        break;
                    case 'voice.language':
                        this.applyVoiceLanguage(value);
                        break;
                    case 'notifications.position':
                        this.applyNotificationPosition(value);
                        break;
                }
            }

            applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                if (theme === 'auto') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                }
            }

            applyFontSize(size) {
                const sizes = { small: '14px', medium: '16px', large: '18px' };
                document.documentElement.style.fontSize = sizes[size] || sizes.medium;
            }

            applySidebarPosition(position) {
                const sidebar = document.getElementById('aiSidebar');
                const mainContainer = document.querySelector('.main-container');
                if (sidebar && mainContainer) {
                    if (position === 'left') {
                        mainContainer.style.flexDirection = 'row';
                    } else {
                        mainContainer.style.flexDirection = 'row-reverse';
                    }
                }
            }

            applyAnimations(enabled) {
                document.documentElement.style.setProperty('--animation-duration', enabled ? '0.3s' : '0s');
            }

            applyTransparency(level) {
                document.documentElement.style.setProperty('--transparency', level);
            }

            applyVoiceLanguage(language) {
                if (window.micBrowser && window.micBrowser.speechRecognition) {
                    window.micBrowser.speechRecognition.lang = language;
                }
            }

            applyNotificationPosition(position) {
                const container = document.getElementById('notificationContainer');
                if (container) {
                    container.className = `notification-container ${position}`;
                }
            }

            loadSettings() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        const parsedSettings = JSON.parse(stored);
                        Object.entries(parsedSettings).forEach(([key, value]) => {
                            this.settings.set(key, value);
                        });
                    }
                } catch (error) {
                    console.error('Failed to load settings:', error);
                }
            }

            saveSettings() {
                try {
                    const settingsObject = Object.fromEntries(this.settings);
                    localStorage.setItem(this.storageKey, JSON.stringify(settingsObject));
                } catch (error) {
                    console.error('Failed to save settings:', error);
                }
            }

            exportSettings() {
                const settingsObject = Object.fromEntries(this.settings);
                const blob = new Blob([JSON.stringify(settingsObject, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mic-browser-settings-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            async importSettings(file) {
                try {
                    const text = await file.text();
                    const importedSettings = JSON.parse(text);
                    
                    Object.entries(importedSettings).forEach(([key, value]) => {
                        this.set(key, value);
                    });
                    
                    return { success: true, message: 'Settings imported successfully' };
                } catch (error) {
                    return { success: false, message: 'Failed to import settings: ' + error.message };
                }
            }

            resetToDefaults() {
                this.settings.clear();
                this.initializeDefaultSettings();
                this.saveSettings();
                
                // Apply all default settings
                this.settings.forEach((value, key) => {
                    this.applySettingChange(key, value);
                });
                
                // Refresh settings UI
                this.refreshSettingsUI();
            }

            refreshSettingsUI() {
                // Update all toggle switches and inputs in the settings panel
                const toggles = document.querySelectorAll('[data-setting]');
                toggles.forEach(element => {
                    const settingKey = element.dataset.setting;
                    const value = this.get(settingKey);
                    
                    if (element.type === 'checkbox' || element.classList.contains('toggle-switch')) {
                        if (element.classList.contains('toggle-switch')) {
                            element.classList.toggle('active', value);
                        } else {
                            element.checked = value;
                        }
                    } else if (element.type === 'range') {
                        element.value = value;
                    } else if (element.tagName === 'SELECT') {
                        element.value = value;
                    }
                });
            }

            setupEventListeners() {
                // Listen for settings changes from UI
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('toggle-switch') && e.target.dataset.setting) {
                        const settingKey = e.target.dataset.setting;
                        const currentValue = this.get(settingKey);
                        this.set(settingKey, !currentValue);
                        e.target.classList.toggle('active', !currentValue);
                    }
                });

                document.addEventListener('change', (e) => {
                    if (e.target.dataset.setting) {
                        const settingKey = e.target.dataset.setting;
                        let value = e.target.value;
                        
                        // Convert value types
                        if (e.target.type === 'checkbox') {
                            value = e.target.checked;
                        } else if (e.target.type === 'number' || e.target.type === 'range') {
                            value = parseFloat(value);
                        }
                        
                        this.set(settingKey, value);
                    }
                });

                // Range input value display
                document.addEventListener('input', (e) => {
                    if (e.target.type === 'range' && e.target.dataset.setting) {
                        const rangeValue = e.target.parentElement.querySelector('.range-value');
                        if (rangeValue) {
                            const settingKey = e.target.dataset.setting;
                            if (settingKey === 'appearance.transparency') {
                                rangeValue.textContent = `${Math.round(e.target.value * 100)}%`;
                            } else if (settingKey === 'ai.responseSpeed') {
                                const labels = ['Accurate', 'Balanced', 'Fast'];
                                rangeValue.textContent = labels[parseInt(e.target.value)] || 'Balanced';
                            }
                        }
                    }
                });

                // Auto-detect system theme changes
                if (window.matchMedia) {
                    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                        if (this.get('appearance.theme') === 'auto') {
                            this.applyTheme('auto');
                        }
                    });
                }
            }

            getCategory(categoryName) {
                const settings = {};
                this.settings.forEach((value, key) => {
                    if (key.startsWith(categoryName + '.')) {
                        settings[key] = value;
                    }
                });
                return settings;
            }
        }

        // Enhanced Tab Management System
        class TabManager {
            constructor() {
                this.tabs = new Map();
                this.activeTabId = null;
                this.tabIdCounter = 1;
                this.draggedTab = null;
                this.contextMenu = null;
                
                this.initializeTabManager();
            }

            initializeTabManager() {
                // Create initial tab if none exist
                if (this.tabs.size === 0) {
                    this.createTab({
                        url: 'about:blank',
                        title: 'MIC Browser Ultimate',
                        favicon: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234a9eff'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z'/%3E%3C/svg%3E"
                    });
                }

                this.setupTabEvents();
                this.createContextMenu();
            }

            createTab(options = {}) {
                const tabId = `tab-${this.tabIdCounter++}`;
                const tab = {
                    id: tabId,
                    url: options.url || 'about:blank',
                    title: options.title || 'New Tab',
                    favicon: options.favicon || this.getDefaultFavicon(),
                    isLoading: false,
                    isSecure: false,
                    hasAudio: false,
                    isPinned: false,
                    canGoBack: false,
                    canGoForward: false,
                    webviewElement: null,
                    aiActive: false
                };

                this.tabs.set(tabId, tab);
                this.renderTab(tab);
                this.createWebView(tab);
                
                if (!this.activeTabId) {
                    this.switchToTab(tabId);
                }

                return tabId;
            }

            renderTab(tab) {
                const tabsWrapper = document.getElementById('tabsWrapper');
                const tabElement = document.createElement('div');
                tabElement.className = 'tab';
                tabElement.setAttribute('data-tab-id', tab.id);
                tabElement.draggable = true;

                tabElement.innerHTML = `
                    <img class="tab-favicon" src="${tab.favicon}" alt="Website icon" onerror="this.src='${this.getDefaultFavicon()}'">
                    <span class="tab-title">${this.escapeHtml(tab.title)}</span>
                    <div class="tab-indicators">
                        <div class="tab-indicator loading" style="display: ${tab.isLoading ? 'block' : 'none'}"></div>
                        <div class="tab-indicator secure" style="display: ${tab.isSecure ? 'block' : 'none'}"></div>
                        <div class="tab-indicator ai-active" style="display: ${tab.aiActive ? 'block' : 'none'}"></div>
                        <div class="tab-indicator audio" style="display: ${tab.hasAudio ? 'block' : 'none'}"></div>
                    </div>
                    <button class="tab-close" aria-label="Close tab"></button>
                `;

                // Add event listeners
                tabElement.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('tab-close')) {
                        this.switchToTab(tab.id);
                    }
                });

                tabElement.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showContextMenu(e, tab.id);
                });

                tabElement.querySelector('.tab-close').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.closeTab(tab.id);
                });

                // Drag and drop support
                tabElement.addEventListener('dragstart', (e) => {
                    this.draggedTab = tab.id;
                    tabElement.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                tabElement.addEventListener('dragend', () => {
                    tabElement.classList.remove('dragging');
                    this.draggedTab = null;
                });

                tabElement.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                tabElement.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (this.draggedTab && this.draggedTab !== tab.id) {
                        this.reorderTabs(this.draggedTab, tab.id);
                    }
                });

                tabsWrapper.appendChild(tabElement);
            }

            createWebView(tab) {
                const webviewContainer = document.querySelector('.webview-container');
                
                // Create webview element
                const webview = document.createElement('webview');
                webview.id = `webview-${tab.id}`;
                webview.className = 'webview';
                webview.src = tab.url;
                webview.style.display = 'none';
                webview.setAttribute('nodeintegration', 'false');
                webview.setAttribute('websecurity', 'true');
                webview.setAttribute('disablewebsecurity', 'false');
                webview.setAttribute('webpreferences', 'contextIsolation=yes,allowRunningInsecureContent=false,experimentalFeatures=false');
                webview.setAttribute('useragent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36');
                webview.setAttribute('partition', 'persist:main');

                // Add webview event listeners
                webview.addEventListener('dom-ready', () => {
                    this.updateTabLoading(tab.id, false);
                });

                webview.addEventListener('did-start-loading', () => {
                    this.updateTabLoading(tab.id, true);
                });

                webview.addEventListener('did-stop-loading', () => {
                    this.updateTabLoading(tab.id, false);
                });

                webview.addEventListener('page-title-updated', (e) => {
                    this.updateTabTitle(tab.id, e.title);
                });

                webview.addEventListener('page-favicon-updated', (e) => {
                    if (e.favicons && e.favicons.length > 0) {
                        this.updateTabFavicon(tab.id, e.favicons[0]);
                    }
                });

                webview.addEventListener('did-navigate', (e) => {
                    this.updateTabUrl(tab.id, e.url);
                    this.updateTabSecurity(tab.id, e.url.startsWith('https://'));
                });

                webview.addEventListener('media-started-playing', () => {
                    this.updateTabAudio(tab.id, true);
                });

                webview.addEventListener('media-paused', () => {
                    this.updateTabAudio(tab.id, false);
                });

                // Enhanced External Link Handling for Webviews
                webview.addEventListener('new-window', (e) => {
                    e.preventDefault();
                    console.log('Webview new-window event:', e.url);
                    if (window.electronAPI && window.electronAPI.openExternalLink) {
                        console.log('Opening external link via electronAPI:', e.url);
                        window.electronAPI.openExternalLink(e.url);
                    } else {
                        console.warn('electronAPI not available, cannot open external link:', e.url);
                    }
                });

                // Handle will-navigate for external domains
                webview.addEventListener('will-navigate', (e) => {
                    try {
                        // More aggressive external link detection
                        const currentURL = webview.src || tab.url;
                        
                        // If navigating to http/https and it's not a localhost or file URL
                        if ((e.url.startsWith('http://') || e.url.startsWith('https://')) &&
                            !e.url.includes('localhost') &&
                            !e.url.includes('127.0.0.1') &&
                            !e.url.includes('file://')) {
                            
                            // Check if it's a different domain
                            try {
                                const currentOrigin = new URL(currentURL).origin;
                                const newURL = new URL(e.url);
                                
                                if (newURL.origin !== currentOrigin) {
                                    e.preventDefault();
                                    console.log('External navigation detected in webview, opening in browser:', e.url);
                                    if (window.electronAPI && window.electronAPI.openExternalLink) {
                                        window.electronAPI.openExternalLink(e.url);
                                    } else {
                                        console.warn('electronAPI not available for external navigation');
                                    }
                                    return;
                                }
                            } catch (urlError) {
                                // If we can't parse the URL, but it looks external, open it externally
                                if (e.url.match(/^https?:\/\/[^\/]+/)) {
                                    e.preventDefault();
                                    console.log('External URL detected (fallback), opening in browser:', e.url);
                                    if (window.electronAPI && window.electronAPI.openExternalLink) {
                                        window.electronAPI.openExternalLink(e.url);
                                    }
                                    return;
                                }
                            }
                        }
                    } catch (error) {
                        console.log('URL processing error in webview navigation:', error.message);
                        // Allow internal navigation if processing fails completely
                    }
                });

                // Additional security: Handle DOM ready to inject link interceptor
                webview.addEventListener('dom-ready', () => {
                    this.updateTabLoading(tab.id, false);
                    
                    // Inject external link handler into webview
                    webview.executeJavaScript(`
                        (function() {
                            console.log('External link handler injected into webview');
                            
                            // Intercept clicks on all links
                            document.addEventListener('click', function(e) {
                                const target = e.target.closest('a');
                                if (!target) return;
                                
                                const href = target.href;
                                if (!href) return;
                                
                                console.log('Link clicked in webview:', href);
                                
                                try {
                                    // More aggressive external link detection
                                    const isExternal = href.startsWith('http://') || href.startsWith('https://');
                                    const hasBlankTarget = target.target === '_blank';
                                    const currentOrigin = window.location.origin;
                                    
                                    if (isExternal) {
                                        const linkURL = new URL(href);
                                        const isDifferentOrigin = linkURL.origin !== currentOrigin;
                                        
                                        // Open externally if:
                                        // 1. Has target="_blank"
                                        // 2. Different origin (domain)
                                        // 3. Not localhost/127.0.0.1
                                        if (hasBlankTarget || 
                                            (isDifferentOrigin && 
                                             !href.includes('localhost') && 
                                             !href.includes('127.0.0.1'))) {
                                            
                                            e.preventDefault();
                                            e.stopPropagation();
                                            
                                            console.log('Opening external link via window.open:', href);
                                            // This will trigger the new-window event
                                            window.open(href, '_blank');
                                            return false;
                                        }
                                    }
                                    
                                    console.log('Allowing internal navigation:', href);
                                } catch (error) {
                                    console.log('Link processing error:', error.message);
                                    // If there's an error and it looks like an external HTTP link, open externally
                                    if (href.match(/^https?:\\/\\/[^\\/]+/)) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        console.log('Fallback: opening external link:', href);
                                        window.open(href, '_blank');
                                        return false;
                                    }
                                }
                            }, true);
                            
                            console.log('External link handler setup complete');
                        })();
                    `).catch(error => {
                        console.log('Failed to inject link handler:', error.message);
                    });
                });

                tab.webviewElement = webview;
                webviewContainer.appendChild(webview);
            }

            switchToTab(tabId) {
                if (!this.tabs.has(tabId)) return;

                // Hide current active tab
                if (this.activeTabId) {
                    const currentTab = this.tabs.get(this.activeTabId);
                    const currentTabElement = document.querySelector(`[data-tab-id="${this.activeTabId}"]`);
                    const currentWebview = currentTab.webviewElement;
                    
                    if (currentTabElement) currentTabElement.classList.remove('active');
                    if (currentWebview) currentWebview.style.display = 'none';
                }

                // Show new active tab
                const newTab = this.tabs.get(tabId);
                const newTabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                const newWebview = newTab.webviewElement;

                if (newTabElement) newTabElement.classList.add('active');
                if (newWebview) {
                    newWebview.style.display = 'block';
                    // Hide demo content when switching to actual webview
                    const demoContent = document.getElementById('demoContent');
                    if (demoContent) demoContent.style.display = 'none';
                }

                this.activeTabId = tabId;
                this.updateNavigationButtons();
                
                // Notify other systems about tab change
                if (window.micBrowser) {
                    window.micBrowser.onTabChanged(tabId, newTab);
                }
            }

            closeTab(tabId) {
                if (!this.tabs.has(tabId) || this.tabs.size <= 1) return;

                const tab = this.tabs.get(tabId);
                const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                const webview = tab.webviewElement;

                // Remove elements
                if (tabElement) tabElement.remove();
                if (webview) webview.remove();

                // If closing active tab, switch to another
                if (this.activeTabId === tabId) {
                    const remainingTabs = Array.from(this.tabs.keys()).filter(id => id !== tabId);
                    if (remainingTabs.length > 0) {
                        this.switchToTab(remainingTabs[remainingTabs.length - 1]);
                    }
                }

                this.tabs.delete(tabId);
            }

            updateTabTitle(tabId, title) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                tab.title = title || 'Untitled';
                const tabElement = document.querySelector(`[data-tab-id="${tabId}"] .tab-title`);
                if (tabElement) {
                    tabElement.textContent = tab.title;
                }
            }

            updateTabFavicon(tabId, favicon) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                tab.favicon = favicon;
                const faviconElement = document.querySelector(`[data-tab-id="${tabId}"] .tab-favicon`);
                if (faviconElement) {
                    faviconElement.src = favicon;
                }
            }

            updateTabLoading(tabId, isLoading) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                tab.isLoading = isLoading;
                const loadingIndicator = document.querySelector(`[data-tab-id="${tabId}"] .tab-indicator.loading`);
                if (loadingIndicator) {
                    loadingIndicator.style.display = isLoading ? 'block' : 'none';
                }

                const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (tabElement) {
                    tabElement.classList.toggle('loading', isLoading);
                }
            }

            updateTabSecurity(tabId, isSecure) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                tab.isSecure = isSecure;
                const secureIndicator = document.querySelector(`[data-tab-id="${tabId}"] .tab-indicator.secure`);
                if (secureIndicator) {
                    secureIndicator.style.display = isSecure ? 'block' : 'none';
                }
            }

            updateTabAudio(tabId, hasAudio) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                tab.hasAudio = hasAudio;
                const audioIndicator = document.querySelector(`[data-tab-id="${tabId}"] .tab-indicator.audio`);
                if (audioIndicator) {
                    audioIndicator.style.display = hasAudio ? 'block' : 'none';
                }
            }

            updateTabUrl(tabId, url) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                tab.url = url;
                // Update address bar if this is the active tab
                if (this.activeTabId === tabId) {
                    const urlInput = document.getElementById('urlInput');
                    if (urlInput) {
                        urlInput.value = url;
                    }
                }
            }

            pinTab(tabId) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                tab.isPinned = !tab.isPinned;
                const tabElement = document.querySelector(`[data-tab-id="${tabId}"]`);
                if (tabElement) {
                    tabElement.classList.toggle('pinned', tab.isPinned);
                }
            }

            duplicateTab(tabId) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                this.createTab({
                    url: tab.url,
                    title: tab.title,
                    favicon: tab.favicon
                });
            }

            reorderTabs(draggedTabId, targetTabId) {
                const tabsWrapper = document.getElementById('tabsWrapper');
                const draggedElement = document.querySelector(`[data-tab-id="${draggedTabId}"]`);
                const targetElement = document.querySelector(`[data-tab-id="${targetTabId}"]`);

                if (draggedElement && targetElement) {
                    tabsWrapper.insertBefore(draggedElement, targetElement.nextSibling);
                }
            }

            createContextMenu() {
                this.contextMenu = document.createElement('div');
                this.contextMenu.className = 'tab-context-menu';
                this.contextMenu.innerHTML = `
                    <div class="tab-context-item" data-action="reload">
                        <i class="fas fa-redo"></i> Reload
                    </div>
                    <div class="tab-context-item" data-action="duplicate">
                        <i class="fas fa-clone"></i> Duplicate
                    </div>
                    <div class="tab-context-item" data-action="pin">
                        <i class="fas fa-thumbtack"></i> <span class="pin-text">Pin Tab</span>
                    </div>
                    <div class="tab-context-item" data-action="close">
                        <i class="fas fa-times"></i> Close Tab
                    </div>
                    <div class="tab-context-item" data-action="close-others">
                        <i class="fas fa-times-circle"></i> Close Other Tabs
                    </div>
                    <div class="tab-context-item" data-action="close-right">
                        <i class="fas fa-arrow-right"></i> Close Tabs to the Right
                    </div>
                `;

                this.contextMenu.addEventListener('click', (e) => {
                    const item = e.target.closest('.tab-context-item');
                    if (item && this.contextMenu.currentTabId) {
                        this.handleContextMenuAction(item.dataset.action, this.contextMenu.currentTabId);
                        this.hideContextMenu();
                    }
                });

                document.body.appendChild(this.contextMenu);

                // Hide context menu when clicking elsewhere
                document.addEventListener('click', () => {
                    this.hideContextMenu();
                });
            }

            showContextMenu(event, tabId) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                this.contextMenu.currentTabId = tabId;
                
                // Update pin text
                const pinText = this.contextMenu.querySelector('.pin-text');
                if (pinText) {
                    pinText.textContent = tab.isPinned ? 'Unpin Tab' : 'Pin Tab';
                }

                // Position menu
                this.contextMenu.style.left = `${event.pageX}px`;
                this.contextMenu.style.top = `${event.pageY}px`;
                this.contextMenu.classList.add('show');
            }

            hideContextMenu() {
                this.contextMenu.classList.remove('show');
            }

            handleContextMenuAction(action, tabId) {
                const tab = this.tabs.get(tabId);
                if (!tab) return;

                switch (action) {
                    case 'reload':
                        if (tab.webviewElement) {
                            tab.webviewElement.reload();
                        }
                        break;
                    case 'duplicate':
                        this.duplicateTab(tabId);
                        break;
                    case 'pin':
                        this.pinTab(tabId);
                        break;
                    case 'close':
                        this.closeTab(tabId);
                        break;
                    case 'close-others':
                        Array.from(this.tabs.keys()).forEach(id => {
                            if (id !== tabId) this.closeTab(id);
                        });
                        break;
                    case 'close-right':
                        const tabElements = Array.from(document.querySelectorAll('.tab'));
                        const targetIndex = tabElements.findIndex(el => el.dataset.tabId === tabId);
                        tabElements.slice(targetIndex + 1).forEach(el => {
                            this.closeTab(el.dataset.tabId);
                        });
                        break;
                }
            }

            setupTabEvents() {
                // New tab button
                const newTabButton = document.querySelector('.new-tab');
                if (newTabButton) {
                    newTabButton.addEventListener('click', () => {
                        const newTabId = this.createTab();
                        this.switchToTab(newTabId);
                    });
                }

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 't':
                                e.preventDefault();
                                const newTabId = this.createTab();
                                this.switchToTab(newTabId);
                                break;
                            case 'w':
                                e.preventDefault();
                                if (this.activeTabId) {
                                    this.closeTab(this.activeTabId);
                                }
                                break;
                            case 'Tab':
                                e.preventDefault();
                                this.switchToNextTab(e.shiftKey ? -1 : 1);
                                break;
                        }
                    }

                    // Ctrl+1-9 to switch to specific tabs
                    if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '9') {
                        e.preventDefault();
                        const tabIndex = parseInt(e.key) - 1;
                        const tabIds = Array.from(this.tabs.keys());
                        if (tabIds[tabIndex]) {
                            this.switchToTab(tabIds[tabIndex]);
                        }
                    }
                });
            }

            switchToNextTab(direction = 1) {
                const tabIds = Array.from(this.tabs.keys());
                const currentIndex = tabIds.indexOf(this.activeTabId);
                if (currentIndex === -1) return;

                let nextIndex = currentIndex + direction;
                if (nextIndex >= tabIds.length) nextIndex = 0;
                if (nextIndex < 0) nextIndex = tabIds.length - 1;

                this.switchToTab(tabIds[nextIndex]);
            }

            updateNavigationButtons() {
                const tab = this.tabs.get(this.activeTabId);
                if (!tab || !tab.webviewElement) return;

                const backButton = document.getElementById('backButton');
                const forwardButton = document.getElementById('forwardButton');

                if (backButton) {
                    try {
                        backButton.disabled = !tab.webviewElement.canGoBack();
                    } catch (error) {
                        backButton.disabled = true;
                    }
                }
                if (forwardButton) {
                    try {
                        forwardButton.disabled = !tab.webviewElement.canGoForward();
                    } catch (error) {
                        forwardButton.disabled = true;
                    }
                }
            }

            getActiveTab() {
                return this.tabs.get(this.activeTabId);
            }

            getDefaultFavicon() {
                return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234a9eff'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z'/%3E%3C/svg%3E";
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Enhanced MIC Browser Ultimate Implementation
        class MICBrowserUltimate {
            constructor() {
                this.sidebarCollapsed = false;
                this.isVoiceActive = false;
                this.aiContext = new Map();
                this.workflowRecorder = null;
                this.predictiveEngine = null;
                
                // Chat system properties
                this.currentChatRoom = 'general';
                this.chatUserId = null;
                this.chatConnected = false;
                this.pendingChatMessages = [];
                
                // Initialize page analyzer
                this.pageAnalyzer = new PageAnalyzer();
                this.currentAnalysis = null;
                
                // Initialize settings manager
                this.settings = new SettingsManager();
                
                // Initialize tab manager
                this.tabManager = new TabManager();
                
                // Initialize command parser
                this.commandParser = new CommandParser(this);
                
                this.initializeComponents();
                this.setupEventListeners();
                this.startSystemMonitoring();
                
                console.log(' MIC Browser Ultimate initialized with settings and tabbed browsing');
            }

            async initializeComponents() {
                // Show loading overlay
                this.showLoading('Initializing AI systems...');
                
                const timeout = setTimeout(() => {
                    console.error(' Initialization timeout - forcing completion');
                    this.hideLoading();
                    this.showNotification('Initialization timeout - some features may not work properly.', 'warning');
                }, 10000); // 10 second timeout (reduced)
                
                try {
                    // Initialize subsystems with individual timeouts
                    console.log(' Starting component initialization sequence...');
                    
                    await Promise.race([this.initializeAI(), this.createTimeout(2000, 'AI')]);
                    await Promise.race([this.initializeChat(), this.createTimeout(2000, 'Chat')]);
                    await Promise.race([this.initializeVoice(), this.createTimeout(2000, 'Voice')]);
                    await Promise.race([this.initializeWorkflows(), this.createTimeout(3000, 'Workflows')]);
                    await Promise.race([this.initializeSecurity(), this.createTimeout(2000, 'Security')]);
                    
                    // Setup real-time features
                    this.setupRealtimeFeatures();
                    
                    // Load user preferences
                    await this.loadUserPreferences();
                    
                    // Initialize settings UI
                    this.settings.refreshSettingsUI();
                    this.applySettingsToFeatures();
                    
                    clearTimeout(timeout);
                    this.hideLoading();
                    this.showNotification('MIC Browser Ultimate is ready!', 'success');
                    console.log(' All components initialized successfully');
                    
                } catch (error) {
                    clearTimeout(timeout);
                    console.error(' Initialization failed:', error);
                    this.hideLoading();
                    this.showNotification('Initialization failed. Some features may not work properly.', 'error');
                }
            }

            // Timeout helper for initialization
            createTimeout(ms, componentName) {
                return new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error(`${componentName} initialization timed out after ${ms}ms`));
                    }, ms);
                });
            }

            async initializeAI() {
                this.updateLoadingProgress('Loading AI models...');
                
                try {
                    console.log(' Starting AI initialization...');
                    
                    // Simulate AI initialization
                    await this.delay(500); // Reduced delay
                    
                    this.aiContext.set('status', 'ready');
                    this.aiContext.set('model', 'claude-3-sonnet');
                    this.aiContext.set('capabilities', ['chat', 'ocr', 'analysis', 'prediction']);
                    
                    console.log(' AI systems initialized successfully');
                } catch (error) {
                    console.error(' AI initialization failed:', error);
                    // Continue with fallback
                    this.aiContext.set('status', 'error');
                }
            }

            async initializeVoice() {
                this.updateLoadingProgress('Setting up voice recognition...');
                
                if ('speechSynthesis' in window && 'webkitSpeechRecognition' in window) {
                    this.speechRecognition = new webkitSpeechRecognition();
                    this.speechRecognition.continuous = false;
                    this.speechRecognition.interimResults = false;
                    this.speechRecognition.lang = 'en-US';
                    
                    this.speechRecognition.onresult = (event) => {
                        const command = event.results[0][0].transcript;
                        this.processVoiceCommand(command);
                    };
                    
                    this.speechRecognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.showNotification('Voice recognition error', 'error');
                    };
                }
                
                await this.delay(500);
            }

            async initializeChat() {
                this.updateLoadingProgress('Connecting to chat system...');
                
                try {
                    // Generate unique user ID if not exists
                    if (!this.chatUserId) {
                        this.chatUserId = this.generateChatUserId();
                        console.log('Generated chat user ID:', this.chatUserId);
                    }
                    
                    // Check if chat API is available
                    if (window.electronAPI && window.electronAPI.chat) {
                        // Join the default room
                        const joinResult = await window.electronAPI.chat.joinRoom({
                            roomId: this.currentChatRoom,
                            userId: this.chatUserId,
                            roomName: 'MIC Browser Chat',
                            isPrivate: false
                        });
                        
                        if (joinResult.success) {
                            this.chatConnected = true;
                            console.log(' Connected to chat system:', joinResult.room);
                            
                            // Load existing chat history
                            await this.loadChatHistory();
                            
                            // Setup chat event listeners
                            this.setupChatEventListeners();
                            
                            // Enable AI for chat
                            await window.electronAPI.chat.toggleAI(true);
                            
                        } else {
                            throw new Error(joinResult.error || 'Failed to join chat room');
                        }
                    } else {
                        console.warn(' Chat API not available, using fallback mode');
                        this.chatConnected = false;
                    }
                    
                } catch (error) {
                    console.error('Chat initialization failed:', error);
                    this.chatConnected = false;
                    this.showNotification('Chat system unavailable, using fallback mode', 'warning');
                }
                
                await this.delay(500);
            }

            async initializeWorkflows() {
                this.updateLoadingProgress('Loading workflow engine...');
                
                try {
                    console.log(' Starting workflow initialization...');
                    
                    this.workflows = new Map();
                    this.workflows.set('data-transfer', {
                        id: 'data-transfer',
                        name: 'Smart Data Transfer',
                        description: 'Transfer data between applications',
                        steps: ['analyze-source', 'map-fields', 'validate-data', 'transfer', 'verify'],
                        active: true
                    });
                    
                    console.log(' Workflow engine initialized successfully');
                    await this.delay(300); // Reduced delay
                    
                } catch (error) {
                    console.error(' Workflow initialization failed:', error);
                    this.workflows = new Map(); // Fallback to empty workflows
                    await this.delay(100);
                }
            }

            async initializeSecurity() {
                this.updateLoadingProgress('Configuring security systems...');
                
                try {
                    console.log(' Starting security initialization...');
                    
                    this.security = {
                        encryption: true,
                        auditLogging: true,
                        threatDetection: true,
                        complianceMode: 'standard'
                    };
                    
                    console.log(' Security systems configured successfully');
                    await this.delay(200); // Reduced delay
                    
                } catch (error) {
                    console.error(' Security initialization failed:', error);
                    this.security = { encryption: false, auditLogging: false, threatDetection: false, complianceMode: 'basic' };
                    await this.delay(50);
                }
            }

            // Tab Management Integration
            onTabChanged(tabId, tabData) {
                // Update address bar with new tab's URL
                const urlInput = document.getElementById('urlInput');
                if (urlInput && tabData.url !== 'about:blank') {
                    urlInput.value = tabData.url;
                }

                // Update navigation buttons
                this.updateNavigationState(tabData);

                // Sync AI context with new tab
                this.syncAIContext(tabId, tabData);

                // Update page analysis for new tab
                if (tabData.webviewElement) {
                    this.analyzePageContent(tabData.webviewElement);
                }

                console.log(` Switched to tab: ${tabId} (${tabData.title})`);
            }

            updateNavigationState(tabData) {
                const backButton = document.getElementById('backButton');
                const forwardButton = document.getElementById('forwardButton');
                const refreshButton = document.getElementById('refreshButton');

                if (backButton) backButton.disabled = !tabData.canGoBack;
                if (forwardButton) forwardButton.disabled = !tabData.canGoForward;
                if (refreshButton) refreshButton.disabled = false;
            }

            syncAIContext(tabId, tabData) {
                // Store AI context per tab
                if (!this.aiContext.has(tabId)) {
                    this.aiContext.set(tabId, {
                        history: [],
                        pageContent: null,
                        insights: [],
                        suggestions: []
                    });
                }

                // Update active tab context
                this.aiContext.set('activeTab', tabId);
            }

            async analyzePageContent(webview) {
                try {
                    // Get page content for AI analysis
                    const pageTitle = await webview.executeJavaScript('document.title');
                    const pageUrl = webview.getURL();
                    
                    // Store page info for AI context
                    const activeTabId = this.tabManager.activeTabId;
                    if (this.aiContext.has(activeTabId)) {
                        const tabContext = this.aiContext.get(activeTabId);
                        tabContext.pageContent = {
                            title: pageTitle,
                            url: pageUrl,
                            timestamp: Date.now()
                        };
                    }

                    // Perform actual page analysis
                    if (this.pageAnalyzer) {
                        this.showNotification('Analyzing page...', 'info');
                        
                        // Get page content from webview
                        const pageContent = await webview.executeJavaScript(`
                            ({
                                title: document.title,
                                url: window.location.href,
                                html: document.documentElement.outerHTML,
                                text: document.body ? document.body.innerText : '',
                                headings: Array.from(document.querySelectorAll('h1,h2,h3,h4,h5,h6')).map(h => ({
                                    tag: h.tagName.toLowerCase(),
                                    text: h.textContent.trim()
                                })),
                                images: Array.from(document.querySelectorAll('img')).map(img => ({
                                    src: img.src,
                                    alt: img.alt || '',
                                    width: img.width,
                                    height: img.height
                                })),
                                links: Array.from(document.querySelectorAll('a')).map(a => ({
                                    href: a.href,
                                    text: a.textContent.trim()
                                })),
                                meta: Array.from(document.querySelectorAll('meta')).map(meta => ({
                                    name: meta.name || meta.property,
                                    content: meta.content
                                }))
                            })
                        `);
                        
                        // Run analysis using the extracted content
                        const analysis = await this.pageAnalyzer.analyzeExtractedContent(pageContent);
                        
                        if (analysis) {
                            // Store the analysis result
                            this.currentAnalysis = analysis;
                            
                            // Show analysis results
                            this.showAnalysisResults(analysis);
                        }
                    }

                    // Trigger predictive suggestions
                    this.generatePageSuggestions(pageUrl, pageTitle);

                } catch (error) {
                    console.warn('Page analysis failed:', error);
                    this.showNotification('Page analysis failed: ' + error.message, 'error');
                }
            }

            generatePageSuggestions(url, title) {
                // Simple predictive suggestions based on page content
                const suggestions = [];

                if (url.includes('github.com')) {
                    suggestions.push('Would you like me to analyze this repository?');
                    suggestions.push('I can help you understand the code structure.');
                }

                if (url.includes('stackoverflow.com')) {
                    suggestions.push('I can explain this coding problem in detail.');
                    suggestions.push('Would you like me to provide additional solutions?');
                }

                if (url.includes('youtube.com') || url.includes('vimeo.com')) {
                    suggestions.push('I can create a summary of this video content.');
                    suggestions.push('Would you like me to extract key timestamps?');
                }

                if (suggestions.length > 0) {
                    this.showAISuggestions(suggestions);
                }
            }

            showAISuggestions(suggestions) {
                const suggestionsContainer = document.getElementById('aiSuggestions');
                if (!suggestionsContainer) return;

                suggestionsContainer.innerHTML = suggestions.map(suggestion => 
                    `<div class="suggestion-item" onclick="micBrowser.sendMessage('${suggestion}')">${suggestion}</div>`
                ).join('');
            }

            // Navigation methods for tabs
            navigateActiveTab(url) {
                const activeTab = this.tabManager.getActiveTab();
                if (activeTab && activeTab.webviewElement) {
                    activeTab.webviewElement.loadURL(url);
                }
            }

            refreshActiveTab() {
                const activeTab = this.tabManager.getActiveTab();
                if (activeTab && activeTab.webviewElement) {
                    activeTab.webviewElement.reload();
                }
            }

            goBackActiveTab() {
                const activeTab = this.tabManager.getActiveTab();
                if (activeTab && activeTab.webviewElement) {
                    try {
                        if (activeTab.webviewElement.canGoBack()) {
                            activeTab.webviewElement.goBack();
                        }
                    } catch (error) {
                        console.warn('Navigation back failed:', error);
                    }
                }
            }

            goForwardActiveTab() {
                const activeTab = this.tabManager.getActiveTab();
                if (activeTab && activeTab.webviewElement) {
                    try {
                        if (activeTab.webviewElement.canGoForward()) {
                            activeTab.webviewElement.goForward();
                        }
                    } catch (error) {
                        console.warn('Navigation forward failed:', error);
                    }
                }
            }

            refreshActiveTab() {
                const activeTab = this.tabManager.getActiveTab();
                if (activeTab && activeTab.webviewElement) {
                    try {
                        activeTab.webviewElement.reload();
                    } catch (error) {
                        console.warn('Tab refresh failed:', error);
                    }
                }
            }

            navigateActiveTab(url) {
                const activeTab = this.tabManager.getActiveTab();
                if (activeTab && activeTab.webviewElement) {
                    try {
                        activeTab.webviewElement.src = url;
                        this.tabManager.updateTabUrl(activeTab.id, url);
                    } catch (error) {
                        console.warn('Navigation failed:', error);
                    }
                }
            }

            async navigateFromUrlBar() {
                const urlInput = document.getElementById('urlInput');
                if (!urlInput) return;

                let input = urlInput.value.trim();
                if (!input) return;

                // Check if input is a command (starts with / or contains command keywords)
                if (input.startsWith('/') || this.isCommand(input)) {
                    await this.executeCommand(input.startsWith('/') ? input.substring(1) : input);
                    return;
                }

                // Regular URL navigation
                let url = input;

                // Add protocol if missing
                if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('file://')) {
                    // Check if it's a relative file path
                    if (url.startsWith('./') || url.endsWith('.html') || url.endsWith('.htm')) {
                        // Convert relative path to absolute file URL
                        const currentLocation = window.location.href;
                        const baseDir = currentLocation.substring(0, currentLocation.lastIndexOf('/'));
                        url = baseDir + '/' + url.replace('./', '');
                    } else if (url.includes('.') && !url.includes(' ')) {
                        // Check if it looks like a URL
                        url = 'https://' + url;
                    } else {
                        // Treat as search query
                        url = `https://www.google.com/search?q=${encodeURIComponent(url)}`;
                    }
                }

                this.navigateActiveTab(url);
            }

            // Check if input looks like a command
            isCommand(input) {
                const commandKeywords = [
                    'go to', 'open', 'search for', 'find', 'create new tab', 'close tab',
                    'go back', 'go forward', 'reload', 'refresh', 'home', 'settings',
                    'scan', 'screenshot', 'ai', 'assistant', 'help', 'voice', 'theme'
                ];
                
                const lowerInput = input.toLowerCase();
                return commandKeywords.some(keyword => lowerInput.startsWith(keyword));
            }

            // Execute command and show result
            async executeCommand(input) {
                try {
                    const result = await this.commandParser.parseCommand(input);
                    
                    if (result.success) {
                        this.showCommandResult(result.result, 'success');
                    } else {
                        this.showCommandResult(result.error, 'error');
                    }
                    
                    // Clear URL input after command execution
                    document.getElementById('urlInput').value = '';
                    
                } catch (error) {
                    console.error('Command execution error:', error);
                    this.showCommandResult('Command execution failed: ' + error.message, 'error');
                }
            }

            // Show command result notification
            showCommandResult(message, type = 'info') {
                // Create or update command result display
                let resultDiv = document.getElementById('commandResult');
                if (!resultDiv) {
                    resultDiv = document.createElement('div');
                    resultDiv.id = 'commandResult';
                    resultDiv.className = 'command-result';
                    document.body.appendChild(resultDiv);
                }

                resultDiv.className = `command-result ${type}`;
                resultDiv.textContent = message;
                resultDiv.style.display = 'block';

                // Auto-hide after 3 seconds
                setTimeout(() => {
                    if (resultDiv) {
                        resultDiv.style.display = 'none';
                    }
                }, 3000);
            }

            setupEventListeners() {
                // Chat input handling
                const chatInput = document.getElementById('chatInput');
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Auto-resize textarea
                chatInput.addEventListener('input', () => {
                    chatInput.style.height = 'auto';
                    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
                });

                // URL bar enhancements with command support
                const urlInput = document.getElementById('urlInput');
                const urlContainer = document.getElementById('urlContainer');
                const commandSuggestions = document.getElementById('commandSuggestions');
                
                if (urlInput) {
                    urlInput.addEventListener('focus', () => {
                        urlInput.select();
                    });

                    urlInput.addEventListener('input', (e) => {
                        const value = e.target.value;
                        
                        // Check if it's a command (starts with / or looks like command)
                        if (value.startsWith('/') || this.isCommand(value)) {
                            urlContainer.classList.add('command-mode');
                            this.showCommandSuggestions(value);
                        } else {
                            urlContainer.classList.remove('command-mode');
                            this.hideCommandSuggestions();
                        }
                    });

                    urlInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Tab' && commandSuggestions.style.display !== 'none') {
                            e.preventDefault();
                            this.selectNextSuggestion();
                        } else if (e.key === 'Escape') {
                            this.hideCommandSuggestions();
                            urlContainer.classList.remove('command-mode');
                        }
                    });

                    urlInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            this.navigateFromUrlBar();
                        }
                    });

                    urlInput.addEventListener('blur', () => {
                        // Hide suggestions after a delay to allow clicking
                        setTimeout(() => {
                            this.hideCommandSuggestions();
                            urlContainer.classList.remove('command-mode');
                        }, 200);
                    });
                }

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'k':
                                e.preventDefault();
                                this.openCommandPalette();
                                break;
                            case 'm':
                                e.preventDefault();
                                this.toggleAssistant();
                                break;
                            case 'j':
                                e.preventDefault();
                                this.startVoiceCommand();
                                break;
                        }
                    }
                });
            }

            setupRealtimeFeatures() {
                // Real-time collaboration
                this.collaboration = {
                    connected: false,
                    users: [],
                    sharedWorkflows: new Map()
                };

                // Performance monitoring
                this.performanceMonitor = {
                    startTime: Date.now(),
                    metrics: {
                        aiRequests: 0,
                        workflowsExecuted: 0,
                        timesSaved: 0,
                        errorsHandled: 0
                    }
                };
            }

            // Command System Functions
            showCommandSuggestions(input) {
                const suggestions = this.commandParser.getSuggestions(input.startsWith('/') ? input.substring(1) : input);
                const suggestionsContainer = document.getElementById('commandSuggestions');
                
                if (suggestions.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                suggestionsContainer.innerHTML = '';
                suggestions.forEach((suggestion, index) => {
                    const div = document.createElement('div');
                    div.className = 'command-suggestion';
                    if (index === 0) div.classList.add('selected');
                    
                    div.innerHTML = `
                        <div class="suggestion-name">${suggestion.text}</div>
                        <div class="suggestion-description">${suggestion.description}</div>
                        <div class="suggestion-usage">${suggestion.usage}</div>
                    `;
                    
                    div.addEventListener('click', () => {
                        document.getElementById('urlInput').value = '/' + suggestion.text + ' ';
                        document.getElementById('urlInput').focus();
                        this.hideCommandSuggestions();
                    });
                    
                    suggestionsContainer.appendChild(div);
                });
                
                suggestionsContainer.style.display = 'block';
            }

            hideCommandSuggestions() {
                document.getElementById('commandSuggestions').style.display = 'none';
            }

            selectNextSuggestion() {
                const suggestions = document.querySelectorAll('.command-suggestion');
                const selected = document.querySelector('.command-suggestion.selected');
                
                if (!selected || !suggestions.length) return;
                
                selected.classList.remove('selected');
                const nextIndex = Array.from(suggestions).indexOf(selected) + 1;
                const next = suggestions[nextIndex] || suggestions[0];
                next.classList.add('selected');
            }

            openCommandPalette() {
                const palette = document.getElementById('commandPalette');
                const input = document.getElementById('commandPaletteInput');
                
                palette.style.display = 'block';
                input.focus();
                
                this.setupCommandPalette();
            }

            closeCommandPalette() {
                document.getElementById('commandPalette').style.display = 'none';
            }

            setupCommandPalette() {
                const input = document.getElementById('commandPaletteInput');
                const results = document.getElementById('commandPaletteResults');
                
                input.addEventListener('input', (e) => {
                    const query = e.target.value;
                    this.updateCommandPaletteResults(query);
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeCommandPalette();
                    } else if (e.key === 'Enter') {
                        const selected = results.querySelector('.command-suggestion.selected');
                        if (selected) {
                            const command = selected.dataset.command;
                            this.executeCommand(command);
                            this.closeCommandPalette();
                        }
                    }
                });
                
                // Close palette when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.command-palette')) {
                        this.closeCommandPalette();
                    }
                });
            }

            updateCommandPaletteResults(query) {
                const results = document.getElementById('commandPaletteResults');
                const suggestions = this.commandParser.getSuggestions(query);
                const categories = this.commandParser.getCategories();
                
                results.innerHTML = '';
                
                if (query.trim() === '') {
                    // Show all commands by category
                    categories.forEach(category => {
                        const commands = this.commandParser.getCommandsByCategory(category);
                        if (commands.length > 0) {
                            const categoryDiv = document.createElement('div');
                            categoryDiv.className = 'command-category';
                            categoryDiv.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                            results.appendChild(categoryDiv);
                            
                            commands.slice(0, 3).forEach(command => {
                                const div = this.createCommandSuggestionElement(command);
                                results.appendChild(div);
                            });
                        }
                    });
                } else {
                    // Show filtered suggestions
                    suggestions.forEach(suggestion => {
                        const div = this.createCommandSuggestionElement(suggestion);
                        results.appendChild(div);
                    });
                }
            }

            createCommandSuggestionElement(command) {
                const div = document.createElement('div');
                div.className = 'command-suggestion';
                div.dataset.command = command.name || command.text;
                
                div.innerHTML = `
                    <div class="suggestion-name">${command.name || command.text}</div>
                    <div class="suggestion-description">${command.description}</div>
                    <div class="suggestion-usage">${command.usage}</div>
                `;
                
                div.addEventListener('click', () => {
                    this.executeCommand(command.name || command.text);
                    this.closeCommandPalette();
                });
                
                return div;
            }

            async loadUserPreferences() {
                // Load from localStorage or API
                const preferences = JSON.parse(localStorage.getItem('micPreferences') || '{}');
                
                this.userPreferences = {
                    theme: preferences.theme || 'dark',
                    aiModel: preferences.aiModel || 'claude-3-sonnet',
                    voiceEnabled: preferences.voiceEnabled || true,
                    predictiveMode: preferences.predictiveMode || true,
                    securityLevel: preferences.securityLevel || 'standard',
                    ...preferences
                };
            }

            startSystemMonitoring() {
                setInterval(() => {
                    this.updateSystemStatus();
                    this.checkPerformance();
                    this.updateAnalytics();
                }, 5000);

                // Update time display
                setInterval(() => {
                    document.getElementById('systemTime').textContent = new Date().toLocaleTimeString();
                }, 1000);
            }

            // Core Functions
            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;
                
                input.value = '';
                input.style.height = 'auto';
                
                // Use the new chat backend if available
                if (window.electronAPI && window.electronAPI.chat) {
                    try {
                        // Send message through new chat system
                        const result = await window.electronAPI.chat.sendMessage({
                            roomId: this.currentChatRoom || 'general',
                            userId: this.chatUserId || this.generateChatUserId(),
                            message: message,
                            type: 'text',
                            metadata: { 
                                timestamp: new Date().toISOString(),
                                source: 'main-interface'
                            }
                        });

                        if (result.success) {
                            // Display the message
                            this.addMessage('user', message);
                            
                            // AI will respond automatically through the chat backend
                            // Show typing indicator while waiting
                            this.showTypingIndicator();
                            
                            // Hide typing indicator after delay (AI should respond by then)
                            setTimeout(() => {
                                this.hideTypingIndicator();
                            }, 3000);
                            
                            this.performanceMonitor.metrics.aiRequests++;
                        } else {
                            throw new Error(result.error || 'Failed to send message');
                        }
                        
                    } catch (chatError) {
                        console.error('Chat backend error, falling back to old system:', chatError);
                        await this.sendMessageFallback(message);
                    }
                } else {
                    // Fallback to old system
                    await this.sendMessageFallback(message);
                }
            }

            // Fallback to original sendMessage behavior
            async sendMessageFallback(message) {
                this.addMessage('user', message);
                this.showTypingIndicator();
                
                try {
                    // Process with AI
                    const response = await this.processWithAI(message);
                    
                    this.hideTypingIndicator();
                    this.addMessage('assistant', response.content, response.actions);
                    
                    // Execute any actions
                    if (response.actions) {
                        await this.executeActions(response.actions);
                    }
                    
                    this.performanceMonitor.metrics.aiRequests++;
                    
                } catch (error) {
                    this.hideTypingIndicator();
                    this.addMessage('assistant', 'I encountered an error processing your request. Please try again.');
                    console.error('AI processing error:', error);
                }
            }

            async processWithAI(message) {
                const lowerMessage = message.toLowerCase();
                
                // Handle browser commands locally for immediate response
                const browserCommand = await this.handleBrowserCommands(lowerMessage, message);
                if (browserCommand) {
                    return browserCommand;
                }
                
                // For general AI requests, use the actual AI service
                try {
                    if (window.electronAPI && window.electronAPI.aiRequest) {
                        const result = await window.electronAPI.aiRequest({ 
                            command: message,
                            context: {
                                currentUrl: this.getCurrentUrl(),
                                tabCount: this.tabManager.tabs.size,
                                settings: this.settings ? Object.fromEntries(this.settings.settings) : {}
                            }
                        });
                        
                        if (result.success) {
                            return {
                                content: result.response,
                                actions: this.extractActionsFromAIResponse(result.response)
                            };
                        } else {
                            console.warn('AI request failed:', result.error);
                            return this.getFallbackResponse(message);
                        }
                    } else {
                        return this.getFallbackResponse(message);
                    }
                } catch (error) {
                    console.error('AI processing error:', error);
                    return this.getFallbackResponse(message);
                }
            }

            async handleBrowserCommands(lowerMessage, originalMessage) {
                // Tab-related commands
                if (lowerMessage.includes('new tab') || lowerMessage.includes('open tab')) {
                    const newTabId = this.tabManager.createTab();
                    this.tabManager.switchToTab(newTabId);
                    return {
                        content: "I've opened a new tab for you. You can now navigate to any website.",
                        actions: ['focus-url-bar']
                    };
                }
                
                if (lowerMessage.includes('close tab')) {
                    if (this.tabManager.tabs.size > 1) {
                        this.tabManager.closeTab(this.tabManager.activeTabId);
                        return {
                            content: "I've closed the current tab.",
                            actions: []
                        };
                    } else {
                        return {
                            content: "I can't close the last tab. Would you like me to open a new tab first?",
                            actions: []
                        };
                    }
                }
                
                if (lowerMessage.includes('go to') || lowerMessage.includes('navigate to') || lowerMessage.includes('open')) {
                    // Extract URL from message
                    const urlMatch = originalMessage.match(/(?:go to|navigate to|open)\s+(.+)/i);
                    if (urlMatch) {
                        const url = urlMatch[1].trim();
                        this.navigateActiveTab(url.includes('.') ? `https://${url}` : `https://www.google.com/search?q=${encodeURIComponent(url)}`);
                        return {
                            content: `I'm navigating to ${url} for you.`,
                            actions: []
                        };
                    }
                }
                
                if (lowerMessage.includes('switch to tab') || lowerMessage.includes('tab')) {
                    const numberMatch = originalMessage.match(/\d+/);
                    if (numberMatch) {
                        const tabIndex = parseInt(numberMatch[0]) - 1;
                        const tabIds = Array.from(this.tabManager.tabs.keys());
                        if (tabIds[tabIndex]) {
                            this.tabManager.switchToTab(tabIds[tabIndex]);
                            return {
                                content: `I've switched to tab ${numberMatch[0]}.`,
                                actions: []
                            };
                        }
                    }
                }
                
                if (lowerMessage.includes('reload') || lowerMessage.includes('refresh')) {
                    this.refreshActiveTab();
                    return {
                        content: "I've refreshed the current page.",
                        actions: []
                    };
                }
                
                if (lowerMessage.includes('back') || lowerMessage.includes('go back')) {
                    this.goBackActiveTab();
                    return {
                        content: "I've navigated back to the previous page.",
                        actions: []
                    };
                }
                
                if (lowerMessage.includes('forward') || lowerMessage.includes('go forward')) {
                    this.goForwardActiveTab();
                    return {
                        content: "I've navigated forward to the next page.",
                        actions: []
                    };
                }
                
                // Return null if no browser command matches
                return null;
            }

            getCurrentUrl() {
                const activeTab = this.tabManager.getActiveTab();
                return activeTab ? activeTab.url : 'about:blank';
            }

            extractActionsFromAIResponse(response) {
                const actions = [];
                const lowerResponse = response.toLowerCase();
                
                if (lowerResponse.includes('scan') || lowerResponse.includes('document')) {
                    actions.push('highlight-scan-button');
                }
                if (lowerResponse.includes('workflow') || lowerResponse.includes('automate')) {
                    actions.push('show-workflow-recorder');
                }
                if (lowerResponse.includes('analytics') || lowerResponse.includes('report')) {
                    actions.push('switch-to-analytics');
                }
                if (lowerResponse.includes('settings') || lowerResponse.includes('configure')) {
                    actions.push('open-settings');
                }
                
                return actions;
            }

            getFallbackResponse(message) {
                return {
                    content: `I understand you want help with: "${message}". I can assist you with web browsing, tab management, document scanning, workflow automation, and more. However, I need an AI service to be configured for advanced assistance. Please check your API key settings.`,
                    actions: ['open-settings']
                };
            }

            async executeActions(actions) {
                for (const action of actions) {
                    switch (action) {
                        case 'focus-url-bar':
                            const urlInput = document.getElementById('urlInput');
                            if (urlInput) {
                                urlInput.focus();
                                urlInput.select();
                            }
                            break;
                        case 'open-settings':
                            this.switchSidebarTab('settings');
                            this.toggleAssistant();
                            break;
                        case 'highlight-scan-button':
                            this.highlightElement('.action-btn.primary');
                            break;
                        case 'show-workflow-recorder':
                            this.switchSidebarTab('workflows');
                            break;
                        case 'switch-to-analytics':
                            this.switchSidebarTab('analytics');
                            break;
                        case 'analyze-page-structure':
                            this.analyzeCurrentPage();
                            break;
                        default:
                            console.log('Unknown action:', action);
                    }
                }
            }

            addMessage(role, content, actions = [], displayName = null) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                let actionsHtml = '';
                if (actions && actions.length > 0) {
                    actionsHtml = `
                        <div class="message-actions">
                            ${actions.map(action => `
                                <button class="message-action" onclick="micBrowser.executeAction('${action}')">
                                    ${this.getActionLabel(action)}
                                </button>
                            `).join('')}
                        </div>
                    `;
                }

                // Add timestamp
                const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Determine display name and icon
                const name = displayName || (role === 'user' ? 'You' : 'MIC Assistant');
                const icon = role === 'user' ? 'user' : 'robot';
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas fa-${icon}"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-header" style="font-size: 12px; opacity: 0.7; margin-bottom: 5px;">
                            ${name} <span style="font-size: 10px;">${timestamp}</span>
                        </div>
                        <div class="message-text">${content}</div>
                        ${actionsHtml}
                    </div>
                `;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Add fade-in animation
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(10px)';
                requestAnimationFrame(() => {
                    messageDiv.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                });
            }

            getActionLabel(action) {
                const labels = {
                    'highlight-scan-button': 'Show Scan',
                    'show-workflow-recorder': 'Create Workflow',
                    'switch-to-analytics': 'View Analytics',
                    'analyze-page-structure': 'Analyze Page',
                    'show-suggestions': 'Show Suggestions'
                };
                return labels[action] || action;
            }

            showTypingIndicator() {
                const chatMessages = document.getElementById('chatMessages');
                const indicator = document.createElement('div');
                indicator.id = 'typingIndicator';
                indicator.className = 'message assistant';
                indicator.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div style="display: flex; gap: 4px; padding: 8px;">
                            <div style="width: 8px; height: 8px; background: var(--text-secondary); border-radius: 50%; animation: typing 1.4s infinite;"></div>
                            <div style="width: 8px; height: 8px; background: var(--text-secondary); border-radius: 50%; animation: typing 1.4s infinite 0.2s;"></div>
                            <div style="width: 8px; height: 8px; background: var(--text-secondary); border-radius: 50%; animation: typing 1.4s infinite 0.4s;"></div>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(indicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            hideTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            // Interface Functions
            switchSidebarTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // Update panels
                document.querySelectorAll('.sidebar-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.getElementById(`${tabName}Panel`).classList.add('active');
            }

            toggleAssistant() {
                const sidebar = document.getElementById('aiSidebar');
                sidebar.classList.toggle('collapsed');
                this.sidebarCollapsed = !this.sidebarCollapsed;
                
                if (!this.sidebarCollapsed) {
                    this.showNotification('AI Assistant activated', 'success');
                } else {
                    this.showNotification('AI Assistant minimized', 'info');
                }
            }

            async startVoiceCommand() {
                if (!this.speechRecognition) {
                    this.showNotification('Voice recognition not available', 'error');
                    return;
                }
                
                this.isVoiceActive = true;
                this.showNotification('Listening... Speak your command', 'info');
                
                try {
                    this.speechRecognition.start();
                } catch (error) {
                    this.showNotification('Voice recognition error', 'error');
                    this.isVoiceActive = false;
                }
            }

            async processVoiceCommand(command) {
                this.isVoiceActive = false;
                this.showNotification(`Heard: "${command}"`, 'success');
                
                // Add to chat as user message
                this.addMessage('user', ` ${command}`);
                
                // Process with AI
                this.showTypingIndicator();
                const response = await this.processWithAI(command);
                this.hideTypingIndicator();
                this.addMessage('assistant', response.content, response.actions);
                
                // Execute actions
                if (response.actions) {
                    await this.executeActions(response.actions);
                }
            }

            // Demo Functions
            demoAI() {
                this.switchSidebarTab('chat');
                this.toggleAssistant();
                setTimeout(() => {
                    document.getElementById('chatInput').value = 'Show me what you can do';
                    this.sendMessage();
                }, 500);
            }

            demoScan() {
                this.showNotification('Opening document scanner...', 'info');
                setTimeout(() => {
                    this.showNotification('Demo: Scan feature would open camera or file picker', 'success');
                }, 1000);
            }

            demoWorkflow() {
                this.switchSidebarTab('workflows');
                this.toggleAssistant();
                this.showNotification('Workflow automation demo', 'info');
            }

            demoTransfer() {
                this.addMessage('assistant', 'I can transfer data between any web applications. For example, I could take customer information from your CRM and automatically populate it in your finance system, mapping fields intelligently and validating data.');
                this.toggleAssistant();
            }

            demoVoice() {
                if (this.speechRecognition) {
                    this.startVoiceCommand();
                } else {
                    this.showNotification('Voice demo: "Fill this form with test data"', 'info');
                    setTimeout(() => {
                        this.addMessage('assistant', ' Voice command received: "Fill this form with test data". I would analyze the current page, identify form fields, and populate them with appropriate test data.');
                    }, 1000);
                }
            }

            demoAnalytics() {
                this.switchSidebarTab('analytics');
                this.toggleAssistant();
                this.updateAnalytics();
                this.showNotification('Analytics dashboard updated', 'success');
            }

            demoSecurity() {
                this.switchSidebarTab('settings');
                this.toggleAssistant();
                this.showNotification('Security features: Encryption, audit logs, compliance monitoring', 'info');
            }

            demoCollaboration() {
                this.showNotification('Collaboration features: Real-time sharing, team workflows, collective intelligence', 'info');
            }

            // Utility Functions
            updateSystemStatus() {
                const statusDot = document.getElementById('systemStatus');
                const statusText = document.getElementById('systemStatusText');
                
                // Simulate system health
                const health = Math.random();
                if (health > 0.8) {
                    statusDot.className = 'status-dot';
                    statusText.textContent = 'System Optimal';
                } else if (health > 0.6) {
                    statusDot.className = 'status-dot warning';
                    statusText.textContent = 'System Normal';
                } else {
                    statusDot.className = 'status-dot error';
                    statusText.textContent = 'System Alert';
                }
                
                // Update memory usage
                const memoryUsage = Math.floor(200 + Math.random() * 100);
                document.getElementById('memoryUsage').textContent = `Memory: ${memoryUsage}MB`;
            }

            checkPerformance() {
                // Monitor performance and show warnings if needed
                const performanceIssues = [];
                
                if (this.performanceMonitor.metrics.errorsHandled > 5) {
                    performanceIssues.push('High error rate detected');
                }
                
                // Show performance notifications
                if (performanceIssues.length > 0) {
                    this.showNotification(performanceIssues[0], 'warning');
                }
            }

            updateAnalytics() {
                // Update analytics with current metrics
                const timeSaved = (2.5 + Math.random() * 3).toFixed(1);
                const tasksAutomated = 30 + Math.floor(Math.random() * 20);
                const accuracyRate = (94 + Math.random() * 5).toFixed(0);
                const valueGenerated = Math.floor(800 + Math.random() * 600);
                
                const metricCards = document.querySelectorAll('.metric-value');
                if (metricCards[0]) metricCards[0].textContent = `${timeSaved}h`;
                if (metricCards[1]) metricCards[1].textContent = tasksAutomated;
                if (metricCards[2]) metricCards[2].textContent = `${accuracyRate}%`;
                if (metricCards[3]) metricCards[3].textContent = `$${valueGenerated}`;
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notificationContainer');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const icons = {
                    info: 'fa-info-circle',
                    success: 'fa-check-circle',
                    warning: 'fa-exclamation-triangle',
                    error: 'fa-times-circle'
                };
                
                notification.innerHTML = `
                    <i class="notification-icon fas ${icons[type]}"></i>
                    <div class="notification-content">
                        <div class="notification-title">MIC Browser</div>
                        <div class="notification-message">${message}</div>
                    </div>
                    <button class="notification-close" onclick="this.parentElement.remove()"></button>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'notificationSlide 0.4s ease reverse';
                    setTimeout(() => notification.remove(), 400);
                }, 5000);
            }

            showLoading(text = 'Loading...') {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                
                loadingText.textContent = text;
                overlay.classList.add('active');
            }

            updateLoadingProgress(progress) {
                const progressText = document.getElementById('loadingProgress');
                progressText.textContent = progress;
            }

            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            }

            highlightElement(selector) {
                const element = document.querySelector(selector);
                if (element) {
                    element.style.animation = 'aiPulse 2s ease-in-out 3';
                    setTimeout(() => {
                        element.style.animation = '';
                    }, 6000);
                }
            }

            async analyzeCurrentPage() {
                try {
                    this.showNotification('Analyzing page...', 'info');
                    
                    // Use the command parser to run analysis
                    const result = await this.commandParser.executeCommand('analyze');
                    
                    if (result.success) {
                        this.addMessage('assistant', result.response);
                    } else {
                        this.addMessage('assistant', `Analysis failed: ${result.error}`);
                        this.showNotification('Analysis failed', 'error');
                    }
                } catch (error) {
                    console.error('Page analysis error:', error);
                    this.showNotification('Analysis failed', 'error');
                    this.addMessage('assistant', 'Page analysis encountered an error. Please try again.');
                }
            }

            // Settings Management Methods
            switchSettingsTab(tabName) {
                // Remove active from all tabs and groups
                document.querySelectorAll('.settings-tab.active').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.settings-group.active').forEach(group => {
                    group.classList.remove('active');
                });

                // Activate selected tab and group
                const tab = document.querySelector(`[data-tab="${tabName}"]`);
                const group = document.getElementById(`settings-${tabName}`);
                
                if (tab) tab.classList.add('active');
                if (group) group.classList.add('active');
            }

            async handleImportSettings(fileInput) {
                const file = fileInput.files[0];
                if (!file) return;

                try {
                    const result = await this.settings.importSettings(file);
                    if (result.success) {
                        this.showNotification('Settings imported successfully!', 'success');
                        this.settings.refreshSettingsUI();
                    } else {
                        this.showNotification(result.message, 'error');
                    }
                } catch (error) {
                    this.showNotification('Failed to import settings', 'error');
                }
                
                // Clear the file input
                fileInput.value = '';
            }

            onTabChanged(tabId, tabData) {
                // Update settings based on active tab if needed
                // This allows per-tab settings in the future
                console.log('Tab changed:', tabId, tabData);
            }

            // Settings integration with existing features
            applySettingsToFeatures() {
                // Apply AI settings
                const aiSettings = this.settings.getCategory('ai');
                if (aiSettings['ai.voiceCommands'] === false) {
                    // Disable voice commands
                    this.isVoiceActive = false;
                }

                // Apply browser settings
                const browserSettings = this.settings.getCategory('browser');
                // Apply tab behavior settings to tab manager
                if (this.tabManager) {
                    this.tabManager.settings = browserSettings;
                }

                // Apply appearance settings
                const appearanceSettings = this.settings.getCategory('appearance');
                // Theme and visual settings are handled by SettingsManager

                console.log('Settings applied to features');
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }

            // Chat System Helper Methods
            generateChatUserId() {
                const prefix = 'user';
                const timestamp = Date.now();
                const random = Math.random().toString(36).substr(2, 9);
                return `${prefix}_${timestamp}_${random}`;
            }

            async loadChatHistory() {
                try {
                    if (!window.electronAPI || !window.electronAPI.chat) return;
                    
                    const result = await window.electronAPI.chat.getHistory({
                        roomId: this.currentChatRoom,
                        limit: 50
                    });

                    if (result.success && result.history.length > 0) {
                        // Clear existing messages except the welcome message
                        const chatMessages = document.getElementById('chatMessages');
                        const firstMessage = chatMessages.firstElementChild;
                        chatMessages.innerHTML = '';
                        if (firstMessage && firstMessage.classList.contains('assistant')) {
                            chatMessages.appendChild(firstMessage);
                        }

                        // Add historical messages
                        result.history.forEach(message => {
                            if (message.userId !== 'system') {
                                this.displayChatMessage(message);
                            }
                        });

                        console.log(`Loaded ${result.history.length} chat messages`);
                    }
                } catch (error) {
                    console.error('Failed to load chat history:', error);
                }
            }

            setupChatEventListeners() {
                try {
                    if (!window.electronAPI || !window.electronAPI.chat) return;

                    // Listen for new messages from other sources
                    window.electronAPI.chat.onNewMessage((event, message) => {
                        // Only display messages from AI or other users, not our own
                        if (message.userId !== this.chatUserId) {
                            this.displayChatMessage(message);
                        }
                    });

                    // Listen for user events
                    window.electronAPI.chat.onUserJoined((event, data) => {
                        if (data.userId !== this.chatUserId) {
                            this.addSystemMessage(`${data.userId} joined the chat`);
                        }
                    });

                    window.electronAPI.chat.onUserLeft((event, data) => {
                        if (data.userId !== this.chatUserId) {
                            this.addSystemMessage(`${data.userId} left the chat`);
                        }
                    });

                    // Listen for typing indicators
                    window.electronAPI.chat.onUserTyping((event, data) => {
                        if (data.userId !== this.chatUserId) {
                            if (data.typing) {
                                this.showTypingIndicator(data.userId);
                            } else {
                                this.hideTypingIndicator();
                            }
                        }
                    });

                    console.log(' Chat event listeners setup complete');
                } catch (error) {
                    console.error('Failed to setup chat event listeners:', error);
                }
            }

            displayChatMessage(message) {
                const messageClass = message.userId === 'ai-assistant' ? 'assistant' : 
                                   message.userId === this.chatUserId ? 'user' : 'user';
                
                const displayName = message.userId === 'ai-assistant' ? 'MIC Assistant' : 
                                   message.userId === this.chatUserId ? 'You' : 
                                   message.userId;

                this.addMessage(messageClass, message.content, null, displayName);
            }

            addSystemMessage(content) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message system';
                messageDiv.innerHTML = `
                    <div class="message-content" style="text-align: center; font-style: italic; color: #888; margin: 10px 0;">
                        ${content}
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            showTypingIndicator(userId = 'AI') {
                const chatMessages = document.getElementById('chatMessages');
                
                // Remove existing typing indicator
                const existingIndicator = chatMessages.querySelector('.typing-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }

                // Add new typing indicator
                const indicator = document.createElement('div');
                indicator.className = 'message assistant typing-indicator';
                indicator.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="typing-animation">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <small>${userId} is typing...</small>
                    </div>
                `;

                chatMessages.appendChild(indicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Add typing animation styles if not already added
                if (!document.getElementById('typing-animation-styles')) {
                    const styles = document.createElement('style');
                    styles.id = 'typing-animation-styles';
                    styles.textContent = `
                        .typing-animation {
                            display: flex;
                            gap: 4px;
                            margin-bottom: 5px;
                        }
                        .typing-animation span {
                            width: 8px;
                            height: 8px;
                            border-radius: 50%;
                            background: #667eea;
                            animation: typing 1.4s infinite;
                        }
                        .typing-animation span:nth-child(1) { animation-delay: 0s; }
                        .typing-animation span:nth-child(2) { animation-delay: 0.2s; }
                        .typing-animation span:nth-child(3) { animation-delay: 0.4s; }
                        @keyframes typing {
                            0%, 60%, 100% { transform: translateY(0); opacity: 0.3; }
                            30% { transform: translateY(-10px); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(styles);
                }
            }

            hideTypingIndicator() {
                const chatMessages = document.getElementById('chatMessages');
                const indicator = chatMessages.querySelector('.typing-indicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            // Page Analysis UI Methods
            showAnalysisResults(analysis) {
                // Create analysis modal
                const modal = this.createAnalysisModal(analysis);
                document.body.appendChild(modal);
                
                // Show with animation
                requestAnimationFrame(() => {
                    modal.classList.add('active');
                });

                this.showNotification(`Page analysis complete! Overall score: ${analysis.overallScore}/100`, 'success');
            }

            showCategoryAnalysis(category, analysis) {
                // Create category-specific modal
                const modal = this.createCategoryModal(category, analysis);
                document.body.appendChild(modal);
                
                // Show with animation
                requestAnimationFrame(() => {
                    modal.classList.add('active');
                });

                this.showNotification(`${category.toUpperCase()} analysis complete! Score: ${analysis.score}/100`, 'info');
            }

            createAnalysisModal(analysis) {
                const modal = document.createElement('div');
                modal.className = 'analysis-modal';
                modal.innerHTML = `
                    <div class="analysis-modal-content">
                        <div class="analysis-header">
                            <h2> Page Analysis Results</h2>
                            <button class="analysis-close" onclick="this.closest('.analysis-modal').remove()"></button>
                        </div>
                        <div class="analysis-score">
                            <div class="overall-score">
                                <div class="score-circle" data-score="${analysis.overallScore}">
                                    <span class="score-number">${analysis.overallScore}</span>
                                    <span class="score-label">/100</span>
                                </div>
                                <h3>Overall Score</h3>
                            </div>
                        </div>
                        <div class="analysis-categories">
                            ${Object.entries(analysis.categories).map(([category, data]) => `
                                <div class="category-card" onclick="window.micBrowser.showCategoryDetails('${category}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">
                                    <div class="category-header">
                                        <h4>${this.getCategoryIcon(category)} ${this.capitalize(category)}</h4>
                                        <span class="category-score ${this.getScoreClass(data.score)}">${data.score}/100</span>
                                    </div>
                                    <div class="category-preview">
                                        ${data.issues.length > 0 ? `<p class="issues"> ${data.issues.length} issues found</p>` : ''}
                                        ${data.recommendations.length > 0 ? `<p class="recommendations"> ${data.recommendations.length} recommendations</p>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="analysis-insights">
                            <h3> Key Insights</h3>
                            <ul>
                                ${analysis.insights.map(insight => `<li>${insight}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="analysis-recommendations">
                            <h3> Top Recommendations</h3>
                            <ul>
                                ${analysis.recommendations.slice(0, 5).map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="analysis-actions">
                            <button onclick="window.micBrowser.exportAnalysis('${analysis.url}', 'json')" class="btn-secondary">
                                 Export JSON
                            </button>
                            <button onclick="window.micBrowser.shareAnalysis('${analysis.url}')" class="btn-secondary">
                                 Share Results
                            </button>
                            <button onclick="this.closest('.analysis-modal').remove()" class="btn-primary">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                // Add styles if not already added
                if (!document.querySelector('#analysis-modal-styles')) {
                    this.addAnalysisStyles();
                }

                return modal;
            }

            createCategoryModal(category, analysis) {
                const modal = document.createElement('div');
                modal.className = 'analysis-modal category-modal';
                modal.innerHTML = `
                    <div class="analysis-modal-content">
                        <div class="analysis-header">
                            <h2>${this.getCategoryIcon(category)} ${this.capitalize(category)} Analysis</h2>
                            <button class="analysis-close" onclick="this.closest('.analysis-modal').remove()"></button>
                        </div>
                        <div class="category-score-section">
                            <div class="score-circle ${this.getScoreClass(analysis.score)}" data-score="${analysis.score}">
                                <span class="score-number">${analysis.score}</span>
                                <span class="score-label">/100</span>
                            </div>
                            <div class="score-description">
                                <h3>${this.getScoreDescription(analysis.score)}</h3>
                            </div>
                        </div>
                        
                        ${analysis.metrics && Object.keys(analysis.metrics).length > 0 ? `
                            <div class="metrics-section">
                                <h3> Metrics</h3>
                                <div class="metrics-grid">
                                    ${this.renderMetrics(analysis.metrics)}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${analysis.issues.length > 0 ? `
                            <div class="issues-section">
                                <h3> Issues Found (${analysis.issues.length})</h3>
                                <ul class="issues-list">
                                    ${analysis.issues.map(issue => `<li class="issue-item">${issue}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${analysis.recommendations.length > 0 ? `
                            <div class="recommendations-section">
                                <h3> Recommendations (${analysis.recommendations.length})</h3>
                                <ul class="recommendations-list">
                                    ${analysis.recommendations.map(rec => `<li class="recommendation-item">${rec}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div class="analysis-actions">
                            <button onclick="this.closest('.analysis-modal').remove()" class="btn-primary">
                                Close
                            </button>
                        </div>
                    </div>
                `;

                return modal;
            }

            renderMetrics(metrics) {
                const metricHtml = [];
                
                for (const [key, value] of Object.entries(metrics)) {
                    if (typeof value === 'object' && value !== null) {
                        // Handle nested metrics
                        metricHtml.push(`
                            <div class="metric-group">
                                <h4>${this.capitalize(key)}</h4>
                                ${Object.entries(value).map(([subKey, subValue]) => `
                                    <div class="metric-item">
                                        <span class="metric-label">${this.capitalize(subKey)}:</span>
                                        <span class="metric-value">${this.formatMetricValue(subValue)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `);
                    } else {
                        metricHtml.push(`
                            <div class="metric-item">
                                <span class="metric-label">${this.capitalize(key)}:</span>
                                <span class="metric-value">${this.formatMetricValue(value)}</span>
                            </div>
                        `);
                    }
                }
                
                return metricHtml.join('');
            }

            formatMetricValue(value) {
                if (typeof value === 'boolean') return value ? '' : '';
                if (typeof value === 'number') return value.toLocaleString();
                if (Array.isArray(value)) return `${value.length} items`;
                return String(value);
            }

            getCategoryIcon(category) {
                const icons = {
                    content: '',
                    seo: '',
                    accessibility: '',
                    performance: '',
                    security: '',
                    social: '',
                    technical: '',
                    readability: ''
                };
                return icons[category] || '';
            }

            getScoreClass(score) {
                if (score >= 80) return 'excellent';
                if (score >= 60) return 'good';
                if (score >= 40) return 'fair';
                return 'poor';
            }

            getScoreDescription(score) {
                if (score >= 90) return 'Excellent';
                if (score >= 80) return 'Good';
                if (score >= 60) return 'Fair';
                if (score >= 40) return 'Needs Improvement';
                return 'Poor';
            }

            capitalize(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            showCategoryDetails(category, data) {
                this.showCategoryAnalysis(category, data);
            }

            async exportAnalysis(url, format = 'json') {
                try {
                    const result = await window.electronAPI.pageAnalysis.exportAnalysis(url, format);
                    if (result.success) {
                        // Create download
                        const blob = new Blob([result.data], { type: 'application/json' });
                        const downloadUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = `page-analysis-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(downloadUrl);
                        
                        this.showNotification('Analysis exported successfully!', 'success');
                    } else {
                        this.showNotification('Export failed: ' + result.error, 'error');
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    this.showNotification('Export failed', 'error');
                }
            }

            shareAnalysis(url) {
                // Simple share functionality - copy to clipboard
                const shareText = `Check out this page analysis: Overall score ${this.currentAnalysis?.overallScore || 'N/A'}/100 for ${url}`;
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareText).then(() => {
                        this.showNotification('Analysis summary copied to clipboard!', 'success');
                    });
                } else {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = shareText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    this.showNotification('Analysis summary copied to clipboard!', 'success');
                }
            }

            addAnalysisStyles() {
                const styles = document.createElement('style');
                styles.id = 'analysis-modal-styles';
                styles.textContent = `
                    .analysis-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }
                    
                    .analysis-modal.active {
                        opacity: 1;
                    }
                    
                    .analysis-modal-content {
                        background: #1a1a1a;
                        border-radius: 12px;
                        padding: 24px;
                        max-width: 900px;
                        max-height: 90vh;
                        overflow-y: auto;
                        color: #ffffff;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                        border: 1px solid #333;
                    }
                    
                    .analysis-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 24px;
                        border-bottom: 1px solid #333;
                        padding-bottom: 16px;
                    }
                    
                    .analysis-header h2 {
                        margin: 0;
                        color: #4fc3f7;
                    }
                    
                    .analysis-close {
                        background: #ff4444;
                        border: none;
                        color: white;
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        cursor: pointer;
                        font-size: 18px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .analysis-score {
                        text-align: center;
                        margin-bottom: 32px;
                    }
                    
                    .overall-score {
                        display: inline-block;
                    }
                    
                    .score-circle {
                        width: 120px;
                        height: 120px;
                        border-radius: 50%;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 16px;
                        position: relative;
                    }
                    
                    .score-circle.excellent {
                        background: linear-gradient(135deg, #4caf50, #2e7d32);
                        box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
                    }
                    
                    .score-circle.good {
                        background: linear-gradient(135deg, #2196f3, #1565c0);
                        box-shadow: 0 0 20px rgba(33, 150, 243, 0.3);
                    }
                    
                    .score-circle.fair {
                        background: linear-gradient(135deg, #ff9800, #f57c00);
                        box-shadow: 0 0 20px rgba(255, 152, 0, 0.3);
                    }
                    
                    .score-circle.poor {
                        background: linear-gradient(135deg, #f44336, #c62828);
                        box-shadow: 0 0 20px rgba(244, 67, 54, 0.3);
                    }
                    
                    .score-number {
                        font-size: 32px;
                        font-weight: bold;
                        line-height: 1;
                    }
                    
                    .score-label {
                        font-size: 14px;
                        opacity: 0.8;
                    }
                    
                    .analysis-categories {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                        gap: 16px;
                        margin-bottom: 32px;
                    }
                    
                    .category-card {
                        background: #262626;
                        border-radius: 8px;
                        padding: 16px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        border: 1px solid #333;
                    }
                    
                    .category-card:hover {
                        background: #333;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                    }
                    
                    .category-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 12px;
                    }
                    
                    .category-header h4 {
                        margin: 0;
                        font-size: 16px;
                    }
                    
                    .category-score {
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: bold;
                    }
                    
                    .category-score.excellent { background: #4caf50; }
                    .category-score.good { background: #2196f3; }
                    .category-score.fair { background: #ff9800; }
                    .category-score.poor { background: #f44336; }
                    
                    .category-preview p {
                        margin: 4px 0;
                        font-size: 14px;
                        opacity: 0.8;
                    }
                    
                    .analysis-insights,
                    .analysis-recommendations {
                        margin-bottom: 24px;
                    }
                    
                    .analysis-insights h3,
                    .analysis-recommendations h3 {
                        color: #4fc3f7;
                        margin-bottom: 12px;
                    }
                    
                    .analysis-insights ul,
                    .analysis-recommendations ul {
                        list-style: none;
                        padding: 0;
                    }
                    
                    .analysis-insights li,
                    .analysis-recommendations li {
                        padding: 8px 0;
                        border-bottom: 1px solid #333;
                    }
                    
                    .analysis-actions {
                        display: flex;
                        gap: 12px;
                        justify-content: flex-end;
                        margin-top: 32px;
                        padding-top: 24px;
                        border-top: 1px solid #333;
                    }
                    
                    .btn-primary,
                    .btn-secondary {
                        padding: 10px 20px;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.3s ease;
                    }
                    
                    .btn-primary {
                        background: #4fc3f7;
                        color: #000;
                    }
                    
                    .btn-primary:hover {
                        background: #29b6f6;
                    }
                    
                    .btn-secondary {
                        background: #666;
                        color: #fff;
                    }
                    
                    .btn-secondary:hover {
                        background: #777;
                    }
                    
                    .metrics-section,
                    .issues-section,
                    .recommendations-section {
                        margin-bottom: 24px;
                    }
                    
                    .metrics-section h3,
                    .issues-section h3,
                    .recommendations-section h3 {
                        color: #4fc3f7;
                        margin-bottom: 16px;
                    }
                    
                    .metrics-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 16px;
                    }
                    
                    .metric-group {
                        background: #262626;
                        padding: 16px;
                        border-radius: 8px;
                        border: 1px solid #333;
                    }
                    
                    .metric-group h4 {
                        margin: 0 0 12px 0;
                        color: #4fc3f7;
                        font-size: 14px;
                    }
                    
                    .metric-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 6px 0;
                        border-bottom: 1px solid #333;
                    }
                    
                    .metric-item:last-child {
                        border-bottom: none;
                    }
                    
                    .metric-label {
                        opacity: 0.8;
                        font-size: 14px;
                    }
                    
                    .metric-value {
                        font-weight: bold;
                        color: #4fc3f7;
                        font-size: 14px;
                    }
                    
                    .issues-list,
                    .recommendations-list {
                        list-style: none;
                        padding: 0;
                    }
                    
                    .issue-item,
                    .recommendation-item {
                        padding: 12px;
                        margin: 8px 0;
                        border-radius: 6px;
                        border-left: 4px solid;
                    }
                    
                    .issue-item {
                        background: rgba(244, 67, 54, 0.1);
                        border-left-color: #f44336;
                        color: #ffcdd2;
                    }
                    
                    .recommendation-item {
                        background: rgba(76, 175, 80, 0.1);
                        border-left-color: #4caf50;
                        color: #c8e6c9;
                    }
                    
                    @media (max-width: 768px) {
                        .analysis-modal-content {
                            margin: 20px;
                            max-height: calc(100vh - 40px);
                        }
                        
                        .analysis-categories {
                            grid-template-columns: 1fr;
                        }
                        
                        .analysis-actions {
                            flex-direction: column;
                        }
                    }
                `;
                document.head.appendChild(styles);
            }
        }

        // Global functions for UI interactions
        function safeCallMicBrowser(method, ...args) {
            try {
                if (!window.micBrowser) {
                    console.error(' micBrowser object not initialized yet. Please wait for the app to fully load.');
                    console.log(' Retrying in 500ms...');
                    setTimeout(() => safeCallMicBrowser(method, ...args), 500);
                    return;
                }
                
                if (typeof window.micBrowser[method] !== 'function') {
                    console.error(` Method '${method}' not found on micBrowser object`);
                    console.log('Available methods:', Object.getOwnPropertyNames(window.micBrowser).filter(prop => 
                        typeof window.micBrowser[prop] === 'function'));
                    return;
                }
                
                console.log(` Calling micBrowser.${method}(${args.join(', ')})`);
                return window.micBrowser[method].apply(window.micBrowser, args);
            } catch (error) {
                console.error(` Error calling micBrowser.${method}():`, error);
                console.log('This is likely a timing issue. The app may still be loading.');
            }
        }

        function switchSidebarTab(tabName) {
            safeCallMicBrowser('switchSidebarTab', tabName);
        }

        function toggleAssistant() {
            safeCallMicBrowser('toggleAssistant');
        }

        function sendMessage() {
            if (window.micBrowser) {
                window.micBrowser.sendMessage();
            }
        }

        function startVoiceCommand() {
            if (window.micBrowser) {
                window.micBrowser.startVoiceCommand();
            }
        }

        function quickScan() {
            openDocumentScanner();
        }

        function runExternalLinkTest() {
            console.log(' Starting external link test...');
            
            // First, let's debug what's available
            console.log('Available micBrowser methods:', 
                window.micBrowser ? Object.getOwnPropertyNames(window.micBrowser).filter(prop => 
                    typeof window.micBrowser[prop] === 'function') : 'micBrowser not available');
            
            // Create inline external link test instead of navigating to a file
            const testContainer = document.createElement('div');
            testContainer.innerHTML = `
                <div style="position: fixed; top: 50px; left: 50px; z-index: 10000; 
                           background: #2a2a2a; padding: 20px; border-radius: 10px; 
                           color: white; box-shadow: 0 4px 20px rgba(0,0,0,0.5); max-width: 400px;">
                    <h3> External Link Test</h3>
                    <p>Click these links - they should open in your default browser:</p>
                    <div id="electronapi-debug" style="background: #333; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 12px;">
                        <strong>Debug Info:</strong><br>
                        electronAPI available: ${!!window.electronAPI}<br>
                        openExternalLink available: ${!!(window.electronAPI && window.electronAPI.openExternalLink)}<br>
                        Available APIs: ${window.electronAPI ? Object.keys(window.electronAPI).join(', ') : 'None'}
                    </div>
                    <div style="margin: 10px 0;">
                        <a href="https://www.google.com" target="_blank" 
                           style="display: block; background: #007acc; color: white; padding: 10px; 
                           margin: 5px 0; text-decoration: none; border-radius: 5px; text-align: center;">
                            Google
                        </a>
                        <a href="https://github.com" target="_blank"
                           style="display: block; background: #007acc; color: white; padding: 10px; 
                           margin: 5px 0; text-decoration: none; border-radius: 5px; text-align: center;">
                            GitHub
                        </a>
                        <a href="https://stackoverflow.com" target="_blank"
                           style="display: block; background: #007acc; color: white; padding: 10px; 
                           margin: 5px 0; text-decoration: none; border-radius: 5px; text-align: center;">
                            Stack Overflow
                        </a>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                           style="background: #dc3545; color: white; border: none; padding: 8px 16px; 
                           border-radius: 4px; cursor: pointer; float: right;">
                        Close Test
                    </button>
                    <div style="clear: both;"></div>
                </div>
            `;
            
            document.body.appendChild(testContainer);
            console.log(' Inline external link test created - click the links above');
        }

        function testQuickExternalLinks() {
            console.log(' Quick External Link Test');
            
            // Test direct external link
            const testUrl = 'https://www.google.com';
            console.log('Testing external URL:', testUrl);
            
            if (window.electronAPI && window.electronAPI.openExternalLink) {
                console.log(' Using electronAPI.openExternalLink');
                window.electronAPI.openExternalLink(testUrl)
                    .then(() => {
                        console.log(' External link opened successfully');
                        alert(' External link should have opened in your default browser!');
                    })
                    .catch(error => {
                        console.error(' electronAPI failed:', error);
                        fallbackOpenExternal(testUrl);
                    });
            } else {
                console.warn(' electronAPI.openExternalLink not available, using fallback');
                fallbackOpenExternal(testUrl);
            }
        }
        
        function fallbackOpenExternal(url) {
            console.log(' Using window.open fallback for:', url);
            try {
                // Method 1: Try basic window.open (WORKING METHOD)
                const newWindow = window.open(url, '_blank');
                console.log(' window.open returned:', newWindow);
                
                if (newWindow) {
                    console.log(' New window opened successfully');
                } else {
                    console.log(' window.open returned null - likely blocked or handled by main process');
                }
                
                // Method 2: Try creating a temporary link and clicking it
                console.log(' Trying temporary link method...');
                const tempLink = document.createElement('a');
                tempLink.href = url;
                tempLink.target = '_blank';
                tempLink.rel = 'noopener noreferrer';
                tempLink.style.display = 'none';
                
                document.body.appendChild(tempLink);
                tempLink.click();
                document.body.removeChild(tempLink);
                
                console.log(' Temporary link clicked - should trigger external link handlers');
                
                setTimeout(() => {
                    alert(' External link methods attempted. Check if your browser opened!');
                }, 100);
                
            } catch (error) {
                console.error(' All methods failed:', error);
                alert(' External link opening failed. Check console for details.');
            }
        }

        function showAnalytics() {
            if (window.micBrowser) {
                window.micBrowser.demoAnalytics();
            }
        }

        function safeNavigateFromUrlBar() {
            if (window.micBrowser && typeof window.micBrowser.navigateFromUrlBar === 'function') {
                window.micBrowser.navigateFromUrlBar();
            } else {
                console.warn(' Navigation unavailable - MIC Browser not ready yet');
                // Try again in a moment
                setTimeout(() => {
                    if (window.micBrowser && typeof window.micBrowser.navigateFromUrlBar === 'function') {
                        window.micBrowser.navigateFromUrlBar();
                    }
                }, 500);
            }
        }

        function quickAction(action) {
            if (!window.micBrowser) return;
            
            switch(action) {
                case 'scan':
                    window.micBrowser.demoScan();
                    break;
                case 'analyze':
                    window.micBrowser.analyzeCurrentPage();
                    break;
                case 'automate':
                    window.micBrowser.demoWorkflow();
                    break;
            }
        }

        // Demo functions
        function demoAI() { if (window.micBrowser) window.micBrowser.demoAI(); }
        function demoScan() { if (window.micBrowser) window.micBrowser.demoScan(); }
        function demoWorkflow() { if (window.micBrowser) window.micBrowser.demoWorkflow(); }
        function demoTransfer() { if (window.micBrowser) window.micBrowser.demoTransfer(); }
        function demoVoice() { if (window.micBrowser) window.micBrowser.demoVoice(); }
        function demoAnalytics() { if (window.micBrowser) window.micBrowser.demoAnalytics(); }
        function demoSecurity() { if (window.micBrowser) window.micBrowser.demoSecurity(); }
        function demoCollaboration() { if (window.micBrowser) window.micBrowser.demoCollaboration(); }

        // Navigation functions
        function navigateBack() {
            micBrowser.showNotification('Navigating back', 'info');
        }

        function navigateForward() {
            micBrowser.showNotification('Navigating forward', 'info');
        }

        function reloadPage() {
            micBrowser.showNotification('Page reloaded', 'success');
        }

        function goHome() {
            micBrowser.showNotification('Navigating to home', 'info');
        }

        // Initialize the application
        let micBrowser;
        document.addEventListener('DOMContentLoaded', () => {
            // Add custom CSS for typing animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes typing {
                    0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
                    30% { transform: translateY(-10px); opacity: 1; }
                }
                
                .toggle-switch {
                    position: relative;
                    width: 48px;
                    height: 24px;
                    background: rgba(255,255,255,0.2);
                    border-radius: 12px;
                    cursor: pointer;
                    transition: background 0.3s ease;
                }
                
                .toggle-switch.active {
                    background: var(--accent-blue);
                }
                
                .toggle-slider {
                    position: absolute;
                    top: 2px;
                    left: 2px;
                    width: 20px;
                    height: 20px;
                    background: white;
                    border-radius: 50%;
                    transition: transform 0.3s ease;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                }
                
                .toggle-switch.active .toggle-slider {
                    transform: translateX(24px);
                }

                /* Enhanced Settings Panel Styles */
                .settings-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                    padding-bottom: 15px;
                    border-bottom: 1px solid var(--dark-border);
                }

                .settings-header h3 {
                    color: white;
                    font-size: 18px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }

                .settings-actions {
                    display: flex;
                    gap: 8px;
                }

                .settings-btn {
                    background: var(--dark-elevated);
                    border: 1px solid var(--dark-border);
                    color: var(--text-secondary);
                    width: 32px;
                    height: 32px;
                    border-radius: 6px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: all 0.2s ease;
                }

                .settings-btn:hover {
                    background: var(--accent-blue);
                    color: white;
                    transform: translateY(-1px);
                }

                .settings-tabs {
                    display: flex;
                    gap: 4px;
                    margin-bottom: 20px;
                    overflow-x: auto;
                    scrollbar-width: none;
                }

                .settings-tabs::-webkit-scrollbar {
                    display: none;
                }

                .settings-tab {
                    background: rgba(255,255,255,0.05);
                    border: 1px solid rgba(255,255,255,0.1);
                    color: var(--text-secondary);
                    padding: 8px 12px;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    white-space: nowrap;
                    font-size: 12px;
                    display: flex;
                    align-items: center;
                    gap: 6px;
                }

                .settings-tab:hover {
                    background: rgba(255,255,255,0.1);
                    color: var(--text-primary);
                }

                .settings-tab.active {
                    background: var(--accent-blue);
                    border-color: var(--accent-blue);
                    color: white;
                }

                .settings-content {
                    height: calc(100% - 120px);
                    overflow-y: auto;
                    scrollbar-width: thin;
                }

                .settings-group {
                    display: none;
                }

                .settings-group.active {
                    display: block;
                }

                .setting-section {
                    background: rgba(255,255,255,0.05);
                    border-radius: 12px;
                    padding: 16px;
                    margin-bottom: 16px;
                }

                .setting-section h4 {
                    color: white;
                    font-size: 14px;
                    margin-bottom: 16px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }

                .setting-item {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 12px;
                    padding: 8px 0;
                }

                .setting-item:last-child {
                    margin-bottom: 0;
                }

                .setting-item label {
                    color: var(--text-primary);
                    font-size: 14px;
                    flex: 1;
                }

                .setting-select {
                    background: var(--dark-elevated);
                    border: 1px solid var(--dark-border);
                    color: var(--text-primary);
                    padding: 6px 10px;
                    border-radius: 6px;
                    font-size: 13px;
                    min-width: 120px;
                }

                .setting-input {
                    background: var(--dark-elevated);
                    border: 1px solid var(--dark-border);
                    color: var(--text-primary);
                    padding: 6px 10px;
                    border-radius: 6px;
                    font-size: 13px;
                    min-width: 120px;
                }

                .setting-input:focus,
                .setting-select:focus {
                    outline: none;
                    border-color: var(--accent-blue);
                    box-shadow: 0 0 0 2px rgba(59,130,246,0.2);
                }

                .range-setting {
                    flex-direction: column;
                    align-items: stretch;
                }

                .range-container {
                    margin-top: 8px;
                }

                .setting-range {
                    width: 100%;
                    accent-color: var(--accent-blue);
                    margin-bottom: 8px;
                }

                .range-labels {
                    display: flex;
                    justify-content: space-between;
                    font-size: 11px;
                    color: var(--text-secondary);
                }

                .range-value {
                    text-align: center;
                    font-size: 12px;
                    color: var(--accent-blue);
                    font-weight: 500;
                    margin-top: 4px;
                }

                /* Settings Panel Animations */
                .settings-group {
                    animation: settingsFadeIn 0.3s ease;
                }

                @keyframes settingsFadeIn {
                    from {
                        opacity: 0;
                        transform: translateY(10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                .setting-item {
                    transition: background 0.2s ease;
                }

                .setting-item:hover {
                    background: rgba(255,255,255,0.02);
                    border-radius: 6px;
                }

                /* Monitoring Analytics Styles */
                .analytics-summary {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 16px;
                    margin-bottom: 24px;
                }

                .stat-card {
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    padding: 16px;
                    text-align: center;
                }

                .stat-card h4 {
                    margin: 0 0 8px 0;
                    color: #b0b0b0;
                    font-size: 0.9em;
                    font-weight: 500;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }

                .stat-number {
                    margin: 0;
                    color: #ffffff;
                    font-size: 2em;
                    font-weight: 700;
                }

                .stat-text {
                    margin: 0;
                    color: #ffffff;
                    font-size: 1.1em;
                    font-weight: 600;
                }

                .crash-list {
                    background: rgba(255, 255, 255, 0.03);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    padding: 16px;
                    max-height: 300px;
                    overflow-y: auto;
                }

                .crash-list h4 {
                    margin: 0 0 16px 0;
                    color: #ffffff;
                    font-size: 1.1em;
                }

                .crash-item {
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                    padding: 12px;
                    margin-bottom: 8px;
                }

                .crash-item:last-child {
                    margin-bottom: 0;
                }

                .crash-time {
                    color: #b0b0b0;
                    font-size: 0.85em;
                    margin-bottom: 4px;
                }

                .crash-type {
                    color: #ff6b6b;
                    font-weight: 600;
                    margin-bottom: 4px;
                }

                .crash-message {
                    color: #ffffff;
                    font-size: 0.9em;
                    opacity: 0.8;
                }

                .no-data {
                    color: #b0b0b0;
                    text-align: center;
                    font-style: italic;
                    margin: 20px 0;
                }

                .monitoring-info {
                    background: rgba(255, 255, 255, 0.03);
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    padding: 16px;
                }

                .monitoring-actions {
                    display: flex;
                    gap: 12px;
                    flex-wrap: wrap;
                }

                .action-btn.warning {
                    background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);
                    border: 1px solid rgba(255, 149, 0, 0.3);
                }

                .action-btn.warning:hover {
                    background: linear-gradient(135deg, #ff6b00 0%, #ff4500 100%);
                    transform: translateY(-2px);
                    box-shadow: 0 8px 25px rgba(255, 149, 0, 0.3);
                }
            `;
            document.head.appendChild(style);
            
            // Initialize MIC Browser Ultimate
            try {
                console.log(' Initializing MIC Browser Ultimate...');
                window.micBrowser = new MICBrowserUltimate();
                console.log(' MIC Browser Ultimate initialized successfully');
                console.log(' switchSettingsTab method available:', typeof window.micBrowser.switchSettingsTab === 'function');
                
                // Dispatch a custom event to notify that micBrowser is ready
                window.dispatchEvent(new CustomEvent('micBrowserReady', {
                    detail: { micBrowser: window.micBrowser }
                }));
            } catch (error) {
                console.error(' Failed to initialize MIC Browser Ultimate:', error);
                console.log('Error details:', error.message);
                console.log('Stack trace:', error.stack);
            }
        });

        // Add toggle switch functionality
        document.addEventListener('click', (e) => {
            if (e.target.closest('.toggle-switch')) {
                e.target.closest('.toggle-switch').classList.toggle('active');
            }
        });

        // Ensure micBrowser is available for settings tab switching
        window.addEventListener('micBrowserReady', () => {
            console.log(' MIC Browser is ready for settings interactions');
        });

        // Fallback: If micBrowser doesn't initialize within 3 seconds, try again
        setTimeout(() => {
            if (!window.micBrowser) {
                console.warn(' micBrowser not initialized after 3 seconds, attempting manual initialization...');
                try {
                    window.micBrowser = new MICBrowserUltimate();
                    console.log(' Manual initialization successful');
                } catch (error) {
                    console.error(' Manual initialization failed:', error);
                }
            } else {
                console.log(' micBrowser already initialized');
            }
        }, 3000);

        // Document Scanner Functions
        let currentImageData = null;
        let ocrInProgress = false;

        function openDocumentScanner() {
            document.getElementById('documentScannerModal').style.display = 'flex';
            resetScanner();
            initializeScannerDefaults();
        }

        function initializeScannerDefaults() {
            const settingsManager = window.micBrowser?.settingsManager;
            if (settingsManager) {
                document.getElementById('ocrLanguage').value = settingsManager.get('ocr.defaultLanguage', 'eng');
                document.getElementById('ocrMode').value = settingsManager.get('ocr.scanMode', 3);
                document.getElementById('preserveSpaces').checked = settingsManager.get('ocr.preserveSpaces', true);
            }
        }

        function closeDocumentScanner() {
            document.getElementById('documentScannerModal').style.display = 'none';
            resetScanner();
        }

        function resetScanner() {
            currentImageData = null;
            ocrInProgress = false;
            document.getElementById('scanProgress').style.display = 'none';
            document.getElementById('scanResults').style.display = 'none';
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('extractedText').value = '';
            document.getElementById('confidenceScore').textContent = '0%';
            document.getElementById('wordCount').textContent = '0';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = 'Initializing OCR...';
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function processFile(file) {
            if (ocrInProgress) {
                showNotification('OCR processing already in progress', 'warning');
                return;
            }

            const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/bmp', 'image/tiff', 'application/pdf'];
            if (!validTypes.includes(file.type)) {
                showNotification('Please select a valid image or PDF file', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                showNotification('File size too large. Please select a file under 10MB', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                startOCR();
            };
            reader.readAsDataURL(file);
        }

        async function startOCR() {
            if (!currentImageData || ocrInProgress) return;

            ocrInProgress = true;
            document.getElementById('uploadArea').style.display = 'none';
            document.getElementById('scanProgress').style.display = 'block';
            document.getElementById('scanResults').style.display = 'none';
            
            // Initialize progress
            resetOCRProgress();
            showOCRProgress();

            // Get enhanced options from UI
            const options = getOCROptions();
            
            // Initialize language if needed
            try {
                await window.electronAPI.initOCRLanguage(options.language);
            } catch (error) {
                console.warn('Language initialization failed:', error);
            }

            try {
                // Set up progress listener
                const progressHandler = (event, progress) => {
                    updateOCRProgress(progress.progress || 0);
                };
                
                // Listen for progress updates (assuming we have an event listener setup)
                window.electronAPI.onOCRProgress?.(progressHandler);

                const startTime = Date.now();
                const result = await window.electronAPI.scanDocument(currentImageData, options);
                const processingTime = Date.now() - startTime;

                if (result.success) {
                    result.processingTime = processingTime;
                    displayEnhancedResults(result);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('OCR Error:', error);
                showNotification('OCR processing failed: ' + error.message, 'error');
                resetScanner();
            } finally {
                ocrInProgress = false;
                hideOCRProgress();
            }
        }

        function getOCROptions() {
            // Basic options
            const basicOptions = {
                language: document.getElementById('ocrLanguage').value || 'eng',
                psm: parseInt(document.getElementById('ocrMode').value) || 3,
                minConfidence: parseInt(document.getElementById('confidenceThreshold').value) || 60
            };

            // Advanced options
            const advancedOptions = {
                preserveSpaces: document.getElementById('preserveSpaces')?.checked !== false,
                preserveFormatting: document.getElementById('preserveFormatting')?.checked !== false,
                fixCommonErrors: document.getElementById('fixCommonErrors')?.checked !== false,
                filterLowConfidence: document.getElementById('filterLowConfidence')?.checked !== false,
                enhanceResults: document.getElementById('enhanceResults')?.checked !== false,
                detectOrientation: document.getElementById('detectOrientation')?.checked === true
            };

            // Preprocessing options
            const preprocessingOptions = {
                preprocessImage: document.getElementById('preprocessImage')?.checked !== false,
                enhance: document.getElementById('enhanceContrast')?.checked !== false,
                sharpen: document.getElementById('sharpenImage')?.checked !== false,
                denoise: document.getElementById('denoiseImage')?.checked !== false
            };

            // Quality settings
            const quality = document.getElementById('imageQuality')?.value || 'balanced';
            const qualityOptions = quality === 'fast' ? {
                maxImageSize: 2048,
                jpegQuality: 85
            } : quality === 'high' ? {
                maxImageSize: 8192,
                jpegQuality: 100
            } : {
                maxImageSize: 4096,
                jpegQuality: 95
            };

            return {
                ...basicOptions,
                ...advancedOptions,
                ...preprocessingOptions,
                ...qualityOptions
            };
        }

        function updateProgress(progress, status) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = (progress * 100) + '%';
            progressText.textContent = status + ' (' + Math.round(progress * 100) + '%)';
        }

        function displayEnhancedResults(result) {
            document.getElementById('scanProgress').style.display = 'none';
            document.getElementById('scanResults').style.display = 'block';
            
            // Store current result globally for export functions
            window.currentOCRResult = result;
            
            // Display text results
            document.getElementById('extractedText').value = result.text || '';
            
            // Display formatted results
            const formattedDiv = document.getElementById('formattedText');
            if (formattedDiv) {
                formattedDiv.innerHTML = formatTextForDisplay(result.text || '');
            }
            
            // Update analysis panel
            updateAnalysisPanel(result);
            
            // Update quick stats
            updateQuickStats(result);
            
            // Update confidence distribution
            updateConfidenceDistribution(result);
            
            showNotification('OCR processing completed successfully!', 'success');
        }

        function updateAnalysisPanel(result) {
            // Processing time
            const processingTime = document.getElementById('processingTime');
            if (processingTime) {
                processingTime.textContent = result.processingTime ? 
                    `${(result.processingTime / 1000).toFixed(2)}s` : '--';
            }
            
            // Overall confidence
            const overallConfidence = document.getElementById('overallConfidence');
            if (overallConfidence) {
                const confidence = Math.round(result.confidence || 0);
                overallConfidence.textContent = `${confidence}%`;
                overallConfidence.className = getConfidenceClass(confidence);
            }
            
            // Word and line counts
            document.getElementById('wordCount').textContent = result.metadata?.wordCount || 0;
            document.getElementById('lineCount').textContent = result.metadata?.lineCount || 0;
            
            // Language
            const detectedLanguage = document.getElementById('detectedLanguage');
            if (detectedLanguage) {
                detectedLanguage.textContent = result.language || 'Unknown';
            }
            
            // Preprocessing status
            const preprocessingStatus = document.getElementById('preprocessingStatus');
            if (preprocessingStatus) {
                preprocessingStatus.textContent = result.metadata?.preprocessed ? 'Enabled' : 'Disabled';
            }
        }

        function updateQuickStats(result) {
            // Confidence score with styling
            const confidenceBadge = document.getElementById('confidenceScore');
            if (confidenceBadge) {
                const confidence = Math.round(result.confidence || 0);
                confidenceBadge.textContent = `${confidence}%`;
                confidenceBadge.className = `confidence-badge ${getConfidenceLevel(confidence)}`;
            }
            
            // Quick word count
            const quickWordCount = document.getElementById('quickWordCount');
            if (quickWordCount) {
                quickWordCount.textContent = result.metadata?.wordCount || 0;
            }
            
            // Quality indicator
            const qualityIndicator = document.getElementById('qualityIndicator');
            if (qualityIndicator) {
                const confidence = result.confidence || 0;
                const quality = confidence > 85 ? 'Excellent' : 
                              confidence > 70 ? 'Good' : 
                              confidence > 50 ? 'Fair' : 'Poor';
                qualityIndicator.textContent = quality;
            }
        }

        function updateConfidenceDistribution(result) {
            const confidenceBars = document.getElementById('confidenceBars');
            if (!confidenceBars || !result.words) return;
            
            // Create confidence distribution
            const ranges = [
                { min: 90, max: 100, color: '#10b981', label: '90-100%' },
                { min: 70, max: 89, color: '#f59e0b', label: '70-89%' },
                { min: 50, max: 69, color: '#ef4444', label: '50-69%' },
                { min: 0, max: 49, color: '#6b7280', label: '0-49%' }
            ];
            
            const distribution = ranges.map(range => ({
                ...range,
                count: result.words.filter(word => 
                    word.confidence >= range.min && word.confidence <= range.max
                ).length
            }));
            
            const maxCount = Math.max(...distribution.map(d => d.count));
            
            confidenceBars.innerHTML = distribution.map(range => {
                const height = maxCount > 0 ? (range.count / maxCount) * 100 : 0;
                return `
                    <div class="confidence-bar" 
                         style="height: ${height}%; background-color: ${range.color};"
                         title="${range.label}: ${range.count} words">
                    </div>
                `;
            }).join('');
        }

        function getConfidenceClass(confidence) {
            return confidence >= 80 ? 'high' : confidence >= 60 ? 'medium' : 'low';
        }

        function getConfidenceLevel(confidence) {
            return confidence >= 80 ? 'high' : confidence >= 60 ? 'medium' : 'low';
        }

        function formatTextForDisplay(text) {
            return text
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>');
        }

        // UI Helper Functions
        function switchOptionsTab(tabName) {
            // Hide all option panels
            const panels = document.querySelectorAll('.option-panel');
            panels.forEach(panel => panel.style.display = 'none');
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.option-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected panel and activate tab
            const selectedPanel = document.getElementById(tabName + 'Options');
            const selectedTab = event.target;
            
            if (selectedPanel) {
                selectedPanel.style.display = 'grid';
            }
            selectedTab.classList.add('active');
        }

        function switchResultsTab(tabName) {
            // Hide all result panels
            const panels = document.querySelectorAll('.result-panel');
            panels.forEach(panel => panel.style.display = 'none');
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.result-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected panel and activate tab
            const selectedPanel = document.getElementById(tabName + 'Results');
            const selectedTab = event.target;
            
            if (selectedPanel) {
                selectedPanel.style.display = 'block';
            }
            selectedTab.classList.add('active');
        }

        function updateConfidenceDisplay(value) {
            document.getElementById('confidenceValue').textContent = value + '%';
        }

        function copyText() {
            const textArea = document.getElementById('extractedText');
            textArea.select();
            textArea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                showNotification('Text copied to clipboard!', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                showNotification('Failed to copy text', 'error');
            }
        }

        function downloadText() {
            const text = document.getElementById('extractedText').value;
            if (!text.trim()) {
                showNotification('No text to download', 'warning');
                return;
            }

            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'extracted-text-' + new Date().toISOString().slice(0, 19).replace(/:/g, '-') + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Text file downloaded!', 'success');
        }

        function exportResults(format) {
            const extractedText = document.getElementById('extractedText').value;
            const analysisContent = document.getElementById('analysisResults');
            
            if (!extractedText && !analysisContent.innerHTML) {
                showNotification('No results to export', 'error');
                return;
            }

            let content, filename, mimeType;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);

            switch (format) {
                case 'txt':
                    content = extractedText;
                    filename = `ocr-results-${timestamp}.txt`;
                    mimeType = 'text/plain';
                    break;
                
                case 'json':
                    const jsonData = {
                        timestamp: new Date().toISOString(),
                        text: extractedText,
                        metadata: {
                            confidence: document.getElementById('overallConfidence')?.textContent || 'N/A',
                            wordCount: extractedText.split(/\s+/).filter(word => word.length > 0).length,
                            characterCount: extractedText.length,
                            language: document.getElementById('languageSelect').value || 'eng'
                        }
                    };
                    content = JSON.stringify(jsonData, null, 2);
                    filename = `ocr-results-${timestamp}.json`;
                    mimeType = 'application/json';
                    break;
                
                case 'html':
                    content = `<!DOCTYPE html>
<html>
<head>
    <title>OCR Results - ${timestamp}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 20px; }
        .content { white-space: pre-wrap; line-height: 1.6; }
        .metadata { margin-top: 20px; font-size: 0.9em; color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <h1>OCR Results</h1>
        <p>Generated on: ${new Date().toLocaleString()}</p>
    </div>
    <div class="content">${extractedText.replace(/\n/g, '<br>')}</div>
    <div class="metadata">
        <p><strong>Language:</strong> ${document.getElementById('languageSelect').value || 'eng'}</p>
        <p><strong>Confidence:</strong> ${document.getElementById('overallConfidence')?.textContent || 'N/A'}</p>
        <p><strong>Word Count:</strong> ${extractedText.split(/\s+/).filter(word => word.length > 0).length}</p>
        <p><strong>Character Count:</strong> ${extractedText.length}</p>
    </div>
</body>
</html>`;
                    filename = `ocr-results-${timestamp}.html`;
                    mimeType = 'text/html';
                    break;
                
                default:
                    showNotification('Invalid export format', 'error');
                    return;
            }

            // Create and download file
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification(`Results exported as ${filename}`, 'success');
        }

        async function sendToAI() {
            const text = document.getElementById('extractedText').value;
            if (!text.trim()) {
                showNotification('No text to send to AI', 'warning');
                return;
            }

            try {
                const response = await window.electronAPI.aiRequest({
                    command: `Please analyze and summarize this extracted text from a document:\n\n${text}`
                });

                if (response.success) {
                    // Create a new tab or panel to show AI analysis
                    showNotification('AI analysis complete! Check the assistant panel.', 'success');
                    
                    // You could also display the result in a modal or send it to the AI assistant
                    if (window.micBrowser && window.micBrowser.addAIResponse) {
                        window.micBrowser.addAIResponse(response.response);
                    }
                } else {
                    showNotification('AI analysis failed: ' + response.error, 'error');
                }
            } catch (error) {
                console.error('AI request failed:', error);
                showNotification('Failed to send text to AI', 'error');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', (event) => {
            const modal = document.getElementById('documentScannerModal');
            if (event.target === modal) {
                closeDocumentScanner();
            }
        });

        // Keyboard shortcuts for document scanner
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const modal = document.getElementById('documentScannerModal');
                if (modal.style.display === 'flex') {
                    closeDocumentScanner();
                }
            }
        });

        // Progress Handling for Enhanced OCR
        function updateOCRProgress(progress) {
            const progressBar = document.getElementById('ocrProgressBar');
            const progressText = document.getElementById('ocrProgressText');
            
            if (progressBar && progressText) {
                const percentage = Math.round(progress * 100);
                progressBar.style.width = percentage + '%';
                progressText.textContent = `Processing... ${percentage}%`;
            }
        }

        function showOCRProgress() {
            const progressContainer = document.getElementById('ocrProgress');
            if (progressContainer) {
                progressContainer.style.display = 'block';
            }
        }

        function hideOCRProgress() {
            const progressContainer = document.getElementById('ocrProgress');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
        }

        function resetOCRProgress() {
            const progressBar = document.getElementById('ocrProgressBar');
            const progressText = document.getElementById('ocrProgressText');
            
            if (progressBar && progressText) {
                progressBar.style.width = '0%';
                progressText.textContent = 'Initializing...';
            }
        }

        // Cross-Tab Data Transfer Functions
        let crossTabData = {
            activeTabs: new Map(),
            currentTabId: null,
            transferInProgress: false,
            syncEnabled: true
        };

        function openCrossTabTransfer() {
            document.getElementById('crossTabTransferModal').style.display = 'flex';
            initializeCrossTabTransfer();
        }

        function closeCrossTabTransfer() {
            document.getElementById('crossTabTransferModal').style.display = 'none';
        }

        async function initializeCrossTabTransfer() {
            try {
                // Generate current tab ID
                crossTabData.currentTabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Register current tab
                const tabInfo = {
                    url: window.location.href,
                    title: document.title || 'MIC Browser Ultimate',
                    timestamp: Date.now()
                };
                
                await window.electronAPI.crossTab.registerTab(crossTabData.currentTabId, tabInfo);
                
                // Load active tabs
                await loadActiveTabs();
                
                // Load transfer history
                await loadTransferHistory();
                
                // Load metrics
                await loadTransferMetrics();
                
                console.log('Cross-tab transfer initialized');
                
            } catch (error) {
                console.error('Cross-tab transfer initialization failed:', error);
                showNotification('Failed to initialize cross-tab transfer', 'error');
            }
        }

        async function loadActiveTabs() {
            try {
                const result = await window.electronAPI.crossTab.getActiveTabs();
                if (result.success) {
                    updateTabSelectors(result.tabs);
                    updateTabStatusDisplay(result.tabs);
                }
            } catch (error) {
                console.error('Failed to load active tabs:', error);
            }
        }

        function updateTabSelectors(tabs) {
            const sourceSelect = document.getElementById('sourceTabSelect');
            const targetSelect = document.getElementById('targetTabSelect');
            
            // Clear existing options
            sourceSelect.innerHTML = '<option value="">Select source tab...</option>';
            targetSelect.innerHTML = '<option value="">Select target tab...</option>';
            
            // Add tab options
            tabs.forEach(tab => {
                const option = document.createElement('option');
                option.value = tab.id;
                option.textContent = `${tab.title} (${new URL(tab.url).hostname})`;
                
                sourceSelect.appendChild(option.cloneNode(true));
                targetSelect.appendChild(option);
            });
        }

        function updateTabStatusDisplay(tabs) {
            const tabStatusList = document.getElementById('tabStatusList');
            tabStatusList.innerHTML = '';
            
            tabs.forEach(tab => {
                const tabItem = document.createElement('div');
                tabItem.className = 'tab-status-item';
                tabItem.innerHTML = `
                    <div class="tab-info">
                        <h5>${tab.title}</h5>
                        <p>${new URL(tab.url).hostname}</p>
                        <span class="sync-status ${tab.syncStatus || 'idle'}">${tab.syncStatus || 'idle'}</span>
                    </div>
                    <div class="tab-actions">
                        <button class="btn-sync" onclick="syncTab('${tab.id}')">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                `;
                tabStatusList.appendChild(tabItem);
            });
        }

        function switchTransferTab(tabName) {
            // Hide all panels
            const panels = document.querySelectorAll('.transfer-panel');
            panels.forEach(panel => panel.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.transfer-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected panel and activate tab
            const selectedPanel = document.getElementById(tabName + 'Panel');
            const selectedTab = event.target;
            
            if (selectedPanel) {
                selectedPanel.classList.add('active');
                selectedPanel.style.display = 'block';
            }
            selectedTab.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'monitor') {
                loadActiveTransfers();
            } else if (tabName === 'history') {
                loadTransferHistory();
            }
        }

        async function startDataTransfer() {
            if (crossTabData.transferInProgress) {
                showNotification('Transfer already in progress', 'warning');
                return;
            }
            
            const sourceTabId = document.getElementById('sourceTabSelect').value;
            const targetTabId = document.getElementById('targetTabSelect').value;
            
            if (!sourceTabId || !targetTabId) {
                showNotification('Please select both source and target tabs', 'warning');
                return;
            }
            
            if (sourceTabId === targetTabId) {
                showNotification('Source and target tabs cannot be the same', 'warning');
                return;
            }
            
            try {
                crossTabData.transferInProgress = true;
                
                // Show progress
                showTransferProgress();
                
                // Collect data to transfer
                const dataToTransfer = await collectTransferData();
                
                // Get transfer options
                const options = getTransferOptions();
                
                // Start transfer
                const result = await window.electronAPI.crossTab.transferData(
                    sourceTabId, 
                    targetTabId, 
                    dataToTransfer, 
                    options
                );
                
                if (result.success) {
                    showNotification('Data transfer completed successfully', 'success');
                    hideTransferProgress();
                    await loadTransferHistory();
                    await loadTransferMetrics();
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Data transfer failed:', error);
                showNotification('Data transfer failed: ' + error.message, 'error');
                hideTransferProgress();
            } finally {
                crossTabData.transferInProgress = false;
            }
        }

        async function collectTransferData() {
            const data = {};
            
            // Form data
            if (document.getElementById('transferForm').checked) {
                data.formData = collectFormData();
            }
            
            // Bookmarks
            if (document.getElementById('transferBookmarks').checked) {
                data.bookmarks = await collectBookmarks();
            }
            
            // Settings
            if (document.getElementById('transferSettings').checked) {
                data.settings = await collectSettings();
            }
            
            // Custom data
            if (document.getElementById('transferCustom').checked) {
                data.customData = collectCustomData();
            }
            
            return data;
        }

        function collectFormData() {
            const forms = document.querySelectorAll('form');
            const formData = [];
            
            forms.forEach((form, index) => {
                const formInfo = {
                    index,
                    action: form.action,
                    method: form.method,
                    fields: []
                };
                
                const formElements = form.querySelectorAll('input, select, textarea');
                formElements.forEach(element => {
                    if (element.type !== 'password') { // Skip passwords for security
                        formInfo.fields.push({
                            name: element.name,
                            type: element.type,
                            value: element.value,
                            id: element.id
                        });
                    }
                });
                
                if (formInfo.fields.length > 0) {
                    formData.push(formInfo);
                }
            });
            
            return formData;
        }

        async function collectBookmarks() {
            try {
                const bookmarks = await window.electronAPI.storage.getBookmarks();
                return bookmarks;
            } catch (error) {
                console.error('Failed to collect bookmarks:', error);
                return [];
            }
        }

        async function collectSettings() {
            try {
                const settings = await window.electronAPI.storage.getAllSettings();
                return settings;
            } catch (error) {
                console.error('Failed to collect settings:', error);
                return {};
            }
        }

        function collectCustomData() {
            // Collect any custom application data
            return {
                localStorage: { ...localStorage },
                sessionStorage: { ...sessionStorage },
                customState: crossTabData
            };
        }

        function getTransferOptions() {
            return {
                compress: document.getElementById('compressData').checked,
                encrypt: document.getElementById('encryptSensitive').checked,
                enableSync: document.getElementById('enableSync').checked,
                resolveConflicts: document.getElementById('resolveConflicts').checked,
                dataType: 'mixed'
            };
        }

        function showTransferProgress() {
            const progressElement = document.getElementById('transferProgress');
            if (progressElement) {
                progressElement.style.display = 'block';
                updateTransferProgress(0, 'Initializing transfer...');
            }
        }

        function hideTransferProgress() {
            const progressElement = document.getElementById('transferProgress');
            if (progressElement) {
                progressElement.style.display = 'none';
            }
        }

        function updateTransferProgress(percent, status, details) {
            const progressFill = document.getElementById('transferProgressFill');
            const statusElement = document.getElementById('transferStatus');
            const percentElement = document.getElementById('transferPercent');
            const detailsElement = document.getElementById('transferDetails');
            
            if (progressFill) progressFill.style.width = percent + '%';
            if (statusElement) statusElement.textContent = status;
            if (percentElement) percentElement.textContent = percent + '%';
            if (detailsElement && details) detailsElement.textContent = details;
        }

        async function previewTransfer() {
            const sourceTabId = document.getElementById('sourceTabSelect').value;
            const targetTabId = document.getElementById('targetTabSelect').value;
            
            if (!sourceTabId || !targetTabId) {
                showNotification('Please select both source and target tabs', 'warning');
                return;
            }
            
            try {
                const dataToTransfer = await collectTransferData();
                const previewContent = document.getElementById('previewContent');
                const transferPreview = document.getElementById('transferPreview');
                
                previewContent.textContent = JSON.stringify(dataToTransfer, null, 2);
                transferPreview.style.display = 'block';
                
            } catch (error) {
                console.error('Preview generation failed:', error);
                showNotification('Failed to generate preview', 'error');
            }
        }

        function updateTransferPreview() {
            // Called when tab selection changes
            const sourceTabId = document.getElementById('sourceTabSelect').value;
            const targetTabId = document.getElementById('targetTabSelect').value;
            const transferPreview = document.getElementById('transferPreview');
            
            if (sourceTabId && targetTabId && sourceTabId !== targetTabId) {
                transferPreview.style.display = 'block';
                previewTransfer();
            } else {
                transferPreview.style.display = 'none';
            }
        }

        async function loadActiveTransfers() {
            const activeTransfersList = document.getElementById('activeTransfersList');
            activeTransfersList.innerHTML = '<div class="no-transfers">No active transfers</div>';
            
            // In a real implementation, you'd load this from the backend
            // For now, show placeholder
        }

        async function loadTransferHistory() {
            try {
                const result = await window.electronAPI.crossTab.getTransferHistory();
                if (result.success) {
                    displayTransferHistory(result.history);
                }
            } catch (error) {
                console.error('Failed to load transfer history:', error);
            }
        }

        function displayTransferHistory(history) {
            const historyList = document.getElementById('transferHistoryList');
            
            if (!history || history.length === 0) {
                historyList.innerHTML = '<div class="no-history">No transfer history available</div>';
                return;
            }
            
            historyList.innerHTML = history.map(transfer => `
                <div class="history-item ${transfer.status}">
                    <div class="transfer-info">
                        <h5>Transfer ${transfer.id.substring(0, 8)}</h5>
                        <p>From: ${transfer.sourceTabId}  To: ${transfer.targetTabId}</p>
                        <span class="transfer-time">${new Date(transfer.startTime).toLocaleString()}</span>
                    </div>
                    <div class="transfer-status">
                        <span class="status-badge ${transfer.status}">${transfer.status}</span>
                        <span class="transfer-size">${formatBytes(transfer.metadata?.originalSize || 0)}</span>
                    </div>
                </div>
            `).join('');
        }

        async function loadTransferMetrics() {
            try {
                const result = await window.electronAPI.crossTab.getMetrics();
                if (result.success) {
                    updateMetricsDisplay(result.metrics);
                }
            } catch (error) {
                console.error('Failed to load transfer metrics:', error);
            }
        }

        function updateMetricsDisplay(metrics) {
            document.getElementById('totalTransfers').textContent = metrics.totalTransfers || '0';
            
            const successRate = metrics.totalTransfers > 0 
                ? Math.round((metrics.successfulTransfers / metrics.totalTransfers) * 100)
                : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            
            document.getElementById('dataTransferred').textContent = formatBytes(metrics.totalDataTransferred || 0);
            document.getElementById('avgSpeed').textContent = Math.round(metrics.averageTransferTime || 0) + ' ms';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function syncTab(tabId) {
            try {
                await window.electronAPI.crossTab.syncData(tabId);
                showNotification('Tab synchronized successfully', 'success');
                await loadActiveTabs();
            } catch (error) {
                console.error('Tab sync failed:', error);
                showNotification('Tab synchronization failed', 'error');
            }
        }

        function filterTransferHistory() {
            // Implementation for filtering transfer history
            const filter = document.getElementById('historyFilter').value;
            loadTransferHistory(); // For now, just reload
        }

        function clearTransferHistory() {
            if (confirm('Are you sure you want to clear the transfer history?')) {
                // Implementation for clearing history
                showNotification('Transfer history cleared', 'success');
                loadTransferHistory();
            }
        }

        function exportTransferHistory() {
            // Implementation for exporting transfer history
            showNotification('Transfer history exported', 'success');
        }

        function resetTransferSettings() {
            if (confirm('Reset all transfer settings to default values?')) {
                document.getElementById('maxTransferSize').value = '10';
                document.getElementById('compressionThreshold').value = '1';
                document.getElementById('syncInterval').value = '5';
                document.getElementById('maxRetries').value = '3';
                document.getElementById('enableEncryption').checked = true;
                document.getElementById('requireAuth').checked = false;
                document.getElementById('auditTransfers').checked = true;
                document.getElementById('autoCleanup').checked = true;
                showNotification('Settings reset to defaults', 'success');
            }
        }

        function saveTransferSettings() {
            // Implementation for saving transfer settings
            showNotification('Transfer settings saved', 'success');
        }

        // Set up cross-tab transfer event listeners
        if (window.electronAPI && window.electronAPI.crossTab) {
            window.electronAPI.crossTab.onTransferStarted((transfer) => {
                console.log('Transfer started:', transfer);
                updateTransferProgress(0, 'Transfer started...');
            });
            
            window.electronAPI.crossTab.onTransferCompleted((transfer) => {
                console.log('Transfer completed:', transfer);
                showNotification('Data transfer completed', 'success');
                hideTransferProgress();
            });
            
            window.electronAPI.crossTab.onTransferFailed((transfer) => {
                console.error('Transfer failed:', transfer);
                showNotification('Data transfer failed', 'error');
                hideTransferProgress();
            });
            
            window.electronAPI.crossTab.onDataReceive(async (data) => {
                console.log('Data received:', data);
                // Handle incoming data transfer
                await handleIncomingDataTransfer(data);
            });
        }

        async function handleIncomingDataTransfer(data) {
            try {
                const { payload } = data;
                
                // Process the received data
                if (payload.data.formData) {
                    await applyFormData(payload.data.formData);
                }
                
                if (payload.data.bookmarks) {
                    await applyBookmarks(payload.data.bookmarks);
                }
                
                if (payload.data.settings) {
                    await applySettings(payload.data.settings);
                }
                
                // Send acknowledgment
                await window.electronAPI.crossTab.sendTransferAck({
                    transferId: payload.transferId,
                    success: true,
                    timestamp: Date.now()
                });
                
                showNotification('Data received and applied successfully', 'success');
                
            } catch (error) {
                console.error('Failed to handle incoming data:', error);
                
                // Send error acknowledgment
                await window.electronAPI.crossTab.sendTransferAck({
                    transferId: data.payload.transferId,
                    success: false,
                    error: error.message,
                    timestamp: Date.now()
                });
            }
        }

        async function applyFormData(formData) {
            // Apply form data to current page forms
            formData.forEach(formInfo => {
                const forms = document.querySelectorAll('form');
                if (forms[formInfo.index]) {
                    formInfo.fields.forEach(field => {
                        const element = forms[formInfo.index].querySelector(`[name="${field.name}"]`) ||
                                      forms[formInfo.index].querySelector(`#${field.id}`);
                        if (element && element.type !== 'password') {
                            element.value = field.value;
                        }
                    });
                }
            });
        }

        async function applyBookmarks(bookmarks) {
            // Merge bookmarks into current bookmarks
            for (const bookmark of bookmarks) {
                try {
                    await window.electronAPI.storage.addBookmark(
                        bookmark.url, 
                        bookmark.title, 
                        bookmark.folder, 
                        bookmark.tags
                    );
                } catch (error) {
                    console.warn('Failed to add bookmark:', bookmark.title, error);
                }
            }
        }

        async function applySettings(settings) {
            // Apply settings to current session
            for (const [key, value] of Object.entries(settings)) {
                try {
                    await window.electronAPI.storage.setSetting(key, value);
                } catch (error) {
                    console.warn('Failed to apply setting:', key, error);
                }
            }
        }

        // Auto-updater functions
        let updateInfo = null;

        function showUpdateModal(info) {
            updateInfo = info;
            
            document.getElementById('currentVersion').textContent = info.currentVersion || '1.0.0';
            document.getElementById('newVersion').textContent = info.version || '1.0.1';
            
            const releaseNotes = document.getElementById('releaseNotes');
            if (info.releaseNotes) {
                releaseNotes.innerHTML = `<p>${info.releaseNotes}</p>`;
            } else {
                releaseNotes.innerHTML = `
                    <ul>
                        <li>Performance improvements</li>
                        <li>Bug fixes and stability enhancements</li>
                        <li>Updated dependencies</li>
                        <li>Enhanced security features</li>
                    </ul>
                `;
            }
            
            // Reset UI state
            document.getElementById('updateProgress').style.display = 'none';
            document.getElementById('downloadUpdateBtn').style.display = 'flex';
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('updateLaterBtn').style.display = 'flex';
            
            document.getElementById('updateModal').style.display = 'flex';
        }

        function closeUpdateModal() {
            document.getElementById('updateModal').style.display = 'none';
        }

        async function downloadUpdate() {
            try {
                document.getElementById('downloadUpdateBtn').style.display = 'none';
                document.getElementById('updateLaterBtn').style.display = 'none';
                document.getElementById('updateProgress').style.display = 'block';
                document.getElementById('progressText').textContent = 'Starting download...';
                
                const result = await window.electronAPI.updater.downloadUpdate();
                
                if (result.success) {
                    document.getElementById('progressText').textContent = 'Download started...';
                } else {
                    showNotification('Update download failed: ' + result.error, 'error');
                    resetUpdateModal();
                }
            } catch (error) {
                console.error('Download update error:', error);
                showNotification('Failed to start update download', 'error');
                resetUpdateModal();
            }
        }

        async function restartAndUpdate() {
            try {
                const result = await window.electronAPI.updater.quitAndInstall();
                if (!result.success) {
                    showNotification('Failed to restart and update: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Restart and update error:', error);
                showNotification('Failed to restart application', 'error');
            }
        }

        function resetUpdateModal() {
            document.getElementById('updateProgress').style.display = 'none';
            document.getElementById('downloadUpdateBtn').style.display = 'flex';
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('updateLaterBtn').style.display = 'flex';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatSpeed(bytesPerSecond) {
            return formatBytes(bytesPerSecond) + '/s';
        }

        // Setup update event listeners when page loads
        if (window.electronAPI && window.electronAPI.updater) {
            // Listen for update events
            window.electronAPI.updater.onUpdateAvailable((event, info) => {
                console.log('Update available:', info);
                showUpdateModal({
                    currentVersion: '1.0.0', // Will be updated with actual version
                    version: info.version,
                    releaseNotes: info.releaseNotes || null
                });
            });

            window.electronAPI.updater.onDownloadProgress((event, progressObj) => {
                const percent = Math.round(progressObj.percent);
                document.getElementById('progressFill').style.width = percent + '%';
                document.getElementById('progressPercentage').textContent = percent + '%';
                document.getElementById('progressText').textContent = 'Downloading update...';
                document.getElementById('downloadSpeed').textContent = formatSpeed(progressObj.bytesPerSecond);
                document.getElementById('downloadSize').textContent = 
                    formatBytes(progressObj.transferred) + ' / ' + formatBytes(progressObj.total);
            });

            window.electronAPI.updater.onUpdateDownloaded((event, info) => {
                console.log('Update downloaded:', info);
                document.getElementById('progressText').textContent = 'Update ready to install';
                document.getElementById('downloadUpdateBtn').style.display = 'none';
                document.getElementById('restartBtn').style.display = 'flex';
                document.getElementById('updateLaterBtn').textContent = 'Install Later';
                document.getElementById('updateLaterBtn').style.display = 'flex';
                showNotification('Update downloaded successfully! Restart to apply.', 'success');
            });

            window.electronAPI.updater.onUpdateError((event, error) => {
                console.error('Update error:', error);
                showNotification('Update failed: ' + error, 'error');
                resetUpdateModal();
            });

            window.electronAPI.updater.onUpdateNotAvailable((event, info) => {
                console.log('No updates available');
            });

            window.electronAPI.updater.onUpdateChecking((event) => {
                console.log('Checking for updates...');
            });

            // Get current version
            window.electronAPI.updater.getVersion().then(versionInfo => {
                console.log('App version:', versionInfo);
            });
        }

        // Platform-specific event handlers
        if (window.electronAPI && window.electronAPI.platform) {
            // Get platform info
            window.electronAPI.platform.getInfo().then(platformInfo => {
                console.log('Platform info:', platformInfo);
                
                // Show platform-specific features in UI
                if (platformInfo.features.jumpList) {
                    console.log(' Windows Jump List available');
                }
                if (platformInfo.features.touchBar) {
                    console.log(' macOS Touch Bar available');
                }
                if (platformInfo.features.dock) {
                    console.log(' macOS Dock integration available');
                }
            });

            // Handle thumbnail toolbar actions (Windows)
            window.electronAPI.platform.onThumbnailAction((event, action) => {
                console.log('Thumbnail action:', action);
                handlePlatformAction(action);
            });

            // Handle Touch Bar actions (macOS)
            window.electronAPI.platform.onTouchBarAction((event, action) => {
                console.log('Touch Bar action:', action);
                handlePlatformAction(action);
            });

            // Handle Dock actions (macOS)
            window.electronAPI.platform.onDockAction((event, action) => {
                console.log('Dock action:', action);
                handlePlatformAction(action);
            });

            // Handle system tray actions
            window.electronAPI.platform.onTrayAction((event, action) => {
                console.log('Tray action:', action);
                handlePlatformAction(action);
            });

            // Handle menu actions (macOS)
            window.electronAPI.platform.onMenuAction((event, action) => {
                console.log('Menu action:', action);
                handlePlatformAction(action);
            });
        }

        // Manual update check function (can be called from UI)
        async function checkForUpdates() {
            try {
                showNotification('Checking for updates...', 'info');
                const result = await window.electronAPI.updater.checkForUpdates();
                
                if (result.success) {
                    if (!result.result) {
                        showNotification('You are running the latest version!', 'success');
                    }
                } else {
                    showNotification('Failed to check for updates: ' + result.error, 'warning');
                }
            } catch (error) {
                console.error('Check for updates error:', error);
                showNotification('Update check failed', 'error');
            }
        }

        // Handle platform-specific actions
        function handlePlatformAction(action) {
            switch (action) {
                case 'new-tab':
                    if (window.micBrowser && window.micBrowser.tabManager) {
                        window.micBrowser.tabManager.createTab('https://www.google.com', 'New Tab');
                    }
                    break;
                    
                case 'prev-tab':
                    if (window.micBrowser && window.micBrowser.tabManager) {
                        window.micBrowser.tabManager.switchToPrevious();
                    }
                    break;
                    
                case 'next-tab':
                    if (window.micBrowser && window.micBrowser.tabManager) {
                        window.micBrowser.tabManager.switchToNext();
                    }
                    break;
                    
                case 'close-tab':
                    if (window.micBrowser && window.micBrowser.tabManager) {
                        window.micBrowser.tabManager.closeCurrentTab();
                    }
                    break;
                    
                case 'scan-document':
                    openDocumentScanner();
                    break;
                    
                case 'voice-assistant':
                    if (window.micBrowser) {
                        window.micBrowser.toggleAssistant();
                    }
                    break;
                    
                case 'analyze-page':
                    if (window.micBrowser) {
                        window.micBrowser.analyzeCurrentPage();
                    }
                    break;
                    
                case 'settings':
                case 'preferences':
                    if (window.micBrowser) {
                        window.micBrowser.switchSidebarTab('settings');
                    }
                    break;
                    
                default:
                    console.log('Unknown platform action:', action);
            }
        }

        // Progress bar integration for platform features
        function updatePlatformProgress(progress) {
            if (window.electronAPI && window.electronAPI.platform) {
                window.electronAPI.platform.updateProgress(progress);
            }
        }

        function clearPlatformProgress() {
            if (window.electronAPI && window.electronAPI.platform) {
                window.electronAPI.platform.clearProgress();
            }
        }

        // Enhanced notification function using platform features
        function showPlatformNotification(title, body, options = {}) {
            if (window.electronAPI && window.electronAPI.platform) {
                return window.electronAPI.platform.showNotification(title, body, options);
            } else {
                return showNotification(title, 'info');
            }
        }

        // Handle escape key for update modal
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                const updateModal = document.getElementById('updateModal');
                if (updateModal.style.display === 'flex') {
                    closeUpdateModal();
                }
            }
        });

        // Theme Management System
        class ThemeManager {
            constructor() {
                this.currentTheme = null;
                this.initializeTheme();
            }

            async initializeTheme() {
                try {
                    // Check if electronAPI is available
                    if (!window.electronAPI || !window.electronAPI.getTheme) {
                        console.warn('ElectronAPI not available, using default theme');
                        this.applyTheme({ name: 'dark', colors: this.getDefaultDarkTheme() });
                        return;
                    }

                    // Get current theme from main process
                    const result = await window.electronAPI.getTheme();
                    if (result.success) {
                        this.applyTheme(result.theme);
                    }
                } catch (error) {
                    console.error('Failed to initialize theme:', error);
                    // Fallback to dark theme
                    this.applyTheme({ name: 'dark', colors: this.getDefaultDarkTheme() });
                }
            }

            getDefaultDarkTheme() {
                return {
                    background: '#0a0a0a',
                    surface: '#1a1a2e',
                    primary: '#667eea',
                    text: '#e0e0e0',
                    secondary: '#a0a0a0',
                    accent: '#3b82f6',
                    success: '#10b981',
                    warning: '#f59e0b',
                    danger: '#ef4444'
                };
            }

            applyTheme(theme) {
                this.currentTheme = theme;
                const root = document.documentElement;
                const colors = theme.colors;

                // Apply CSS custom properties
                root.style.setProperty('--theme-background', colors.background);
                root.style.setProperty('--theme-surface', colors.surface);
                root.style.setProperty('--theme-primary', colors.primary);
                root.style.setProperty('--theme-text', colors.text);
                root.style.setProperty('--theme-secondary', colors.secondary);
                root.style.setProperty('--theme-accent', colors.accent);
                root.style.setProperty('--theme-success', colors.success);
                root.style.setProperty('--theme-warning', colors.warning);
                root.style.setProperty('--theme-danger', colors.danger);

                // Update existing CSS variables to use theme colors
                root.style.setProperty('--dark-bg', colors.background);
                root.style.setProperty('--dark-surface', colors.surface);
                root.style.setProperty('--text-primary', colors.text);
                root.style.setProperty('--text-secondary', colors.secondary);
                root.style.setProperty('--accent-blue', colors.accent);

                // Add theme class to body
                document.body.className = document.body.className.replace(/theme-\w+/g, '');
                document.body.classList.add(`theme-${theme.name}`);

                // Notify other components
                this.broadcastThemeChange(theme);

                console.log(`Applied theme: ${theme.name}`);
            }

            async changeTheme(themeName) {
                try {
                    // Check if electronAPI is available
                    if (!window.electronAPI || !window.electronAPI.setTheme) {
                        console.error('ElectronAPI.setTheme not available');
                        return false;
                    }

                    const result = await window.electronAPI.setTheme(themeName);
                    if (result.success) {
                        this.applyTheme(result.theme);
                        return true;
                    } else {
                        console.error('Failed to change theme:', result.error);
                        return false;
                    }
                } catch (error) {
                    console.error('Error changing theme:', error);
                    return false;
                }
            }

            async getAvailableThemes() {
                try {
                    // Check if electronAPI is available
                    if (!window.electronAPI || !window.electronAPI.getAvailableThemes) {
                        console.error('ElectronAPI.getAvailableThemes not available');
                        return [];
                    }

                    const result = await window.electronAPI.getAvailableThemes();
                    return result.success ? result.themes : [];
                } catch (error) {
                    console.error('Error getting available themes:', error);
                    return [];
                }
            }

            broadcastThemeChange(theme) {
                // Dispatch custom event for components that need to react to theme changes
                const themeEvent = new CustomEvent('themeChanged', {
                    detail: { theme, colors: theme.colors }
                });
                document.dispatchEvent(themeEvent);
            }

            getCurrentTheme() {
                return this.currentTheme;
            }
        }

        // Initialize theme manager with ElectronAPI availability check
        function initializeThemeManager() {
            console.log(' Checking ElectronAPI for theme system...');
            
            // Check if ElectronAPI is available with theme methods
            if (window.electronAPI && 
                window.electronAPI.getAvailableThemes && 
                window.electronAPI.setTheme && 
                window.electronAPI.getTheme) {
                
                console.log(' ElectronAPI theme methods available, initializing theme manager...');
                
                const themeManager = new ThemeManager();

                // Listen for theme changes from main process
                if (window.electronAPI.onThemeChanged) {
                    window.electronAPI.onThemeChanged((theme) => {
                        themeManager.applyTheme(theme);
                    });
                }

                // Expose theme manager globally for settings panel
                window.themeManager = themeManager;
                
                console.log(' Theme manager initialized successfully');
                return true;
            } else {
                console.log(' ElectronAPI theme methods not available yet');
                return false;
            }
        }

        // Initialize theme manager when DOM is ready
        function initThemeManagerOnReady() {
            console.log(' Starting theme manager initialization...');
            
            // First, wait for the electronapi-ready event
            window.addEventListener('electronapi-ready', () => {
                console.log(' ElectronAPI ready signal received, initializing theme manager...');
                if (initializeThemeManager()) {
                    return;
                }
            });
            
            // Also try to initialize immediately in case the ready signal was missed
            if (initializeThemeManager()) {
                return;
            }
            
            console.log(' Waiting for ElectronAPI to become available...');
            
            // Fallback: Retry initialization every 100ms until ElectronAPI is ready
            const retryInterval = setInterval(() => {
                if (initializeThemeManager()) {
                    clearInterval(retryInterval);
                    console.log(' Theme manager initialization complete');
                }
            }, 100);
            
            // Stop trying after 10 seconds
            setTimeout(() => {
                clearInterval(retryInterval);
                if (!window.themeManager) {
                    console.log(' Creating fallback theme manager...');
                    // Create a robust fallback theme manager
                    window.themeManager = {
                        currentTheme: 'dark',
                        initialized: true,
                        fallbackMode: true,
                        applyTheme: (theme) => {
                            console.log(` Fallback theme applied: ${theme}`);
                            document.documentElement.setAttribute('data-theme', theme);
                        },
                        getAvailableThemes: () => ['dark', 'light', 'auto'],
                        getCurrentTheme: () => window.themeManager.currentTheme,
                        setTheme: (theme) => {
                            window.themeManager.currentTheme = theme;
                            window.themeManager.applyTheme(theme);
                        }
                    };
                    
                    // Apply default dark theme
                    window.themeManager.applyTheme('dark');
                    console.log(' Fallback theme manager ready');
                }
            }, 3000); // Reduced timeout to 3 seconds
        }

        // Wait for DOM to be ready before initializing theme manager
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initThemeManagerOnReady);
        } else {
            // DOM is already ready
            setTimeout(initThemeManagerOnReady, 100);
        }

        // Theme Settings Functions
        async function handleThemeChange(themeName) {
            if (!window.themeManager) {
                console.error(' Theme manager not available');
                if (window.micBrowser) {
                    window.micBrowser.showNotification('Theme manager not available', 'error');
                }
                return;
            }

            const success = await window.themeManager.changeTheme(themeName);
            if (success) {
                // Update theme preview selection
                updateThemePreviewSelection(themeName);
                
                // Show success notification
                if (window.micBrowser) {
                    window.micBrowser.showNotification(`Theme changed to ${themeName}`, 'success');
                }
            } else {
                if (window.micBrowser) {
                    window.micBrowser.showNotification('Failed to change theme', 'error');
                }
            }
        }

        async function initializeThemeSettings() {
            try {
                // Check if theme manager is available
                if (!window.themeManager) {
                    console.warn(' Theme manager not available, skipping theme settings initialization');
                    return;
                }

                // Get available themes
                const themes = await window.themeManager.getAvailableThemes();
                
                // Populate theme previews
                populateThemePreviews(themes);
                
                // Set current theme in selector
                const currentTheme = window.themeManager.getCurrentTheme();
                if (currentTheme) {
                    const selector = document.getElementById('themeSelector');
                    if (selector) {
                        selector.value = currentTheme.name;
                    }
                    updateThemePreviewSelection(currentTheme.name);
                }
            } catch (error) {
                console.error('Failed to initialize theme settings:', error);
            }
        }

        function populateThemePreviews(themes) {
            const grid = document.getElementById('themePreviewGrid');
            if (!grid) return;

            grid.innerHTML = '';

            themes.forEach(theme => {
                const card = document.createElement('div');
                card.className = 'theme-preview-card';
                card.dataset.theme = theme.name;
                card.onclick = () => handleThemeChange(theme.name);

                const colors = document.createElement('div');
                colors.className = 'theme-preview-colors';

                // Create color samples
                const colorSamples = [
                    theme.colors.background,
                    theme.colors.surface,
                    theme.colors.primary,
                    theme.colors.accent
                ];

                colorSamples.forEach(color => {
                    const sample = document.createElement('div');
                    sample.className = 'theme-color-sample';
                    sample.style.backgroundColor = color;
                    colors.appendChild(sample);
                });

                const name = document.createElement('div');
                name.className = 'theme-preview-name';
                name.textContent = theme.name.charAt(0).toUpperCase() + theme.name.slice(1);

                card.appendChild(colors);
                card.appendChild(name);
                grid.appendChild(card);
            });
        }

        function updateThemePreviewSelection(themeName) {
            // Update preview card selection
            document.querySelectorAll('.theme-preview-card').forEach(card => {
                card.classList.toggle('active', card.dataset.theme === themeName);
            });

            // Update selector
            const selector = document.getElementById('themeSelector');
            if (selector) {
                selector.value = themeName;
            }
        }

        // Initialize theme settings when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initializeThemeSettings();
            }, 1000); // Delay to ensure ThemeManager is initialized
        });

        // Enhanced Web Browsing - Real Webview Function
        function createWebview(url) {
            const webview = document.createElement('webview');
            webview.src = url;
            webview.style.width = '100%';
            webview.style.height = '100%';
            webview.partition = 'persist:main';
            
            // Security settings
            webview.webpreferences = 'contextIsolation=yes';
            
            // Add to container
            document.getElementById('webviewContainer').appendChild(webview);
            
            // Handle events
            webview.addEventListener('did-start-loading', () => {
                console.log('Loading:', url);
            });
            
            webview.addEventListener('did-stop-loading', () => {
                console.log('Loaded:', url);
            });

            return webview;
        }

        // Language Management Functions
        async function handleLanguageChange(selectElement) {
            const newLanguage = selectElement.value;
            
            try {
                // Show loading state
                showLanguageStatus('Changing language...', 'loading');
                
                // Change language through i18n system
                const success = await window.i18n.changeLanguage(newLanguage);
                
                if (success) {
                    // Update language info display
                    updateLanguageInfo();
                    showLanguageStatus('Language changed successfully', 'success');
                    
                    // Hide status after 3 seconds
                    setTimeout(() => {
                        hideLanguageStatus();
                    }, 3000);
                } else {
                    showLanguageStatus('Failed to change language', 'error');
                    // Revert selection
                    selectElement.value = window.i18n.getCurrentLanguage();
                }
            } catch (error) {
                console.error('Error changing language:', error);
                showLanguageStatus('Error changing language', 'error');
                selectElement.value = window.i18n.getCurrentLanguage();
            }
        }

        async function updateLanguageInfo() {
            try {
                const result = await window.electronAPI.i18n.getCurrentLanguage();
                
                if (result && result.success) {
                    const { language, info } = result;
                    
                    // Update current language display
                    const nameElement = document.getElementById('currentLanguageName');
                    if (nameElement && info) {
                        nameElement.textContent = info.nativeName || info.name || language;
                    }
                    
                    // Update text direction
                    const directionElement = document.getElementById('textDirection');
                    if (directionElement && info) {
                        const direction = info.direction === 'rtl' ? 'Right to Left' : 'Left to Right';
                        directionElement.textContent = direction;
                    }
                    
                    // Update translation status (this would be enhanced with actual validation)
                    const statusElement = document.getElementById('translationStatus');
                    if (statusElement) {
                        statusElement.textContent = 'Complete';
                        statusElement.className = 'status-complete';
                    }
                }
            } catch (error) {
                console.error('Error updating language info:', error);
            }
        }

        async function refreshLanguages() {
            try {
                showLanguageStatus('Refreshing available languages...', 'loading');
                
                // Get available languages from main process
                const languages = await window.i18n.getAvailableLanguages();
                
                // Update language selector
                const selector = document.getElementById('languageSelect');
                if (selector) {
                    // Clear current options except the selected one
                    const currentValue = selector.value;
                    selector.innerHTML = '';
                    
                    // Add available languages
                    languages.forEach(lang => {
                        const option = document.createElement('option');
                        option.value = lang.code;
                        option.textContent = lang.nativeName || lang.name;
                        if (lang.code === currentValue) {
                            option.selected = true;
                        }
                        selector.appendChild(option);
                    });
                }
                
                showLanguageStatus(`Found ${languages.length} available languages`, 'success');
                setTimeout(() => {
                    hideLanguageStatus();
                }, 3000);
                
            } catch (error) {
                console.error('Error refreshing languages:', error);
                showLanguageStatus('Error refreshing languages', 'error');
            }
        }

        async function validateTranslations() {
            try {
                showLanguageStatus('Validating translations...', 'loading');
                
                // This would call a validation function in the main process
                // For now, we'll just simulate validation
                setTimeout(() => {
                    showLanguageStatus('All translations are valid', 'success');
                    setTimeout(() => {
                        hideLanguageStatus();
                    }, 3000);
                }, 1500);
                
            } catch (error) {
                console.error('Error validating translations:', error);
                showLanguageStatus('Error validating translations', 'error');
            }
        }

        function showLanguageStatus(message, type = 'info') {
            const statusContainer = document.getElementById('languageStatus');
            const messageElement = statusContainer.querySelector('.status-message');
            
            if (statusContainer && messageElement) {
                messageElement.textContent = message;
                statusContainer.className = `language-status ${type}`;
                statusContainer.style.display = 'block';
            }
        }

        function hideLanguageStatus() {
            const statusContainer = document.getElementById('languageStatus');
            if (statusContainer) {
                statusContainer.style.display = 'none';
            }
        }

        // Initialize language settings when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait a bit for i18n to initialize
            setTimeout(async () => {
                try {
                    // Set current language in selector
                    const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'en';
                    const selector = document.getElementById('languageSelect');
                    if (selector) {
                        selector.value = currentLang;
                    }
                    
                    // Update language info
                    updateLanguageInfo();
                    
                    // Setup language change observer
                    if (window.i18n) {
                        window.i18n.onLanguageChange((event) => {
                            console.log('Language changed:', event);
                            updateLanguageInfo();
                        });
                    }
                } catch (error) {
                    console.error('Error initializing language settings:', error);
                }
            }, 1000);
        });

        // External Link Handler for Main Window
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up external link handler for main window');
            
            // Handle clicks on all links in the main window
            document.addEventListener('click', function(e) {
                const target = e.target.closest('a');
                if (!target) return;
                
                const href = target.href;
                if (!href) return;
                
                console.log('Main window link clicked:', href);
                
                try {
                    // Check if it's an external HTTP/HTTPS link
                    if (href.startsWith('http://') || href.startsWith('https://')) {
                        const currentOrigin = window.location.origin;
                        const linkURL = new URL(href);
                        
                        // More aggressive external link detection
                        const hasBlankTarget = target.target === '_blank';
                        const isDifferentOrigin = linkURL.origin !== currentOrigin;
                        const isNotLocalhost = !href.includes('localhost') && !href.includes('127.0.0.1');
                        
                        // Open externally if it's a different origin or has target="_blank"
                        if (hasBlankTarget || (isDifferentOrigin && isNotLocalhost)) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            console.log('Opening external link from main window:', href);
                            if (window.electronAPI && window.electronAPI.openExternalLink) {
                                window.electronAPI.openExternalLink(href)
                                    .then(() => console.log(' External link opened successfully'))
                                    .catch(error => console.error(' Failed to open external link:', error));
                            } else {
                                console.warn('electronAPI.openExternalLink not available, using fallback');
                                // Fallback: Use window.open which should trigger the main process handlers
                                console.log('Trying window.open fallback for:', href);
                                try {
                                    const result = window.open(href, '_blank');
                                    console.log(' Fallback window.open called, result:', result);
                                } catch (error) {
                                    console.error(' Fallback window.open failed:', error);
                                }
                            }
                            return false;
                        } else {
                            console.log('Allowing internal navigation (same origin):', href);
                        }
                    } else {
                        console.log('Non-HTTP link, allowing default behavior:', href);
                    }
                } catch (error) {
                    console.log('Link processing error:', error.message);
                    // Fallback for external-looking links
                    if (href.match(/^https?:\/\/[^\/]+/)) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Fallback: opening external-looking link:', href);
                        if (window.electronAPI && window.electronAPI.openExternalLink) {
                            window.electronAPI.openExternalLink(href);
                        }
                        return false;
                    }
                }
            }, true);
            
            console.log('External link handler setup complete for main window');
            
            console.log('External link handler initialized for main window');
        });

        // Update Settings JavaScript
        // Update-related functions
        let updateSettings = {};
        let updateStatus = {};

        // Initialize update settings when DOM is ready
        async function initUpdateSettings() {
            try {
                if (window.electronAPI?.updater) {
                    updateSettings = await window.electronAPI.updater.getSettings();
                    updateStatus = await window.electronAPI.updater.getStatus();
                    
                    // Update UI with current settings
                    updateUpdateSettingsUI();
                    updateUpdateInfoUI();
                    
                    // Setup event listeners for setting changes
                    setupUpdateSettingsListeners();
                    
                    console.log('Update settings initialized:', updateSettings);
                }
            } catch (error) {
                console.error('Failed to initialize update settings:', error);
            }
        }

        // Update the settings UI with current values
        function updateUpdateSettingsUI() {
            if (!updateSettings) return;

            // Update toggle switches
            updateToggleSwitch('autoDownloadToggle', updateSettings.autoDownload);
            updateToggleSwitch('autoInstallToggle', updateSettings.autoInstall);
            updateToggleSwitch('checkStartupToggle', updateSettings.checkOnStartup);
            updateToggleSwitch('notifyUserToggle', updateSettings.notifyUser);
            updateToggleSwitch('silentUpdatesToggle', updateSettings.silentUpdates);
            updateToggleSwitch('prereleaseToggle', updateSettings.allowPrerelease);

            // Update select box
            const intervalSelect = document.getElementById('checkIntervalSelect');
            if (intervalSelect) {
                intervalSelect.value = updateSettings.checkInterval.toString();
            }
        }

        // Update toggle switch state
        function updateToggleSwitch(toggleId, isActive) {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
                if (isActive) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // Update the info UI with current status
        function updateUpdateInfoUI() {
            if (!updateStatus) return;

            const currentVersion = document.getElementById('currentVersion');
            const lastCheck = document.getElementById('lastUpdateCheck');
            const statusEl = document.getElementById('updateStatus');

            if (currentVersion) {
                currentVersion.textContent = updateStatus.version || 'Unknown';
            }

            if (lastCheck) {
                const lastCheckTime = updateStatus.lastCheckTime;
                if (lastCheckTime) {
                    lastCheck.textContent = new Date(lastCheckTime).toLocaleString();
                } else {
                    lastCheck.textContent = 'Never';
                }
            }

            if (statusEl) {
                if (updateStatus.isUpdateAvailable) {
                    statusEl.textContent = 'Update Available';
                    statusEl.className = 'status-update-available';
                } else if (updateStatus.isDownloading) {
                    statusEl.textContent = 'Downloading...';
                    statusEl.className = 'status-downloading';
                } else {
                    statusEl.textContent = 'Up to date';
                    statusEl.className = 'status-up-to-date';
                }
            }

            // Show restart button if update is downloaded
            const restartButton = document.getElementById('restartButton');
            if (restartButton && updateStatus.isUpdateAvailable && !updateStatus.isDownloading) {
                restartButton.style.display = 'inline-block';
            }
        }

        // Setup event listeners for settings changes
        function setupUpdateSettingsListeners() {
            // Toggle switches
            setupToggleListener('autoDownloadToggle', 'autoDownload');
            setupToggleListener('autoInstallToggle', 'autoInstall');
            setupToggleListener('checkStartupToggle', 'checkOnStartup');
            setupToggleListener('notifyUserToggle', 'notifyUser');
            setupToggleListener('silentUpdatesToggle', 'silentUpdates');
            setupToggleListener('prereleaseToggle', 'allowPrerelease');

            // Select box
            const intervalSelect = document.getElementById('checkIntervalSelect');
            if (intervalSelect) {
                intervalSelect.addEventListener('change', async (e) => {
                    await saveUpdateSetting('checkInterval', parseInt(e.target.value));
                });
            }
        }

        // Setup toggle listener
        function setupToggleListener(toggleId, settingKey) {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
                toggle.addEventListener('click', async () => {
                    const isActive = toggle.classList.contains('active');
                    await saveUpdateSetting(settingKey, !isActive);
                    toggle.classList.toggle('active');
                });
            }
        }

        // Save update setting
        async function saveUpdateSetting(key, value) {
            try {
                const newSettings = { ...updateSettings, [key]: value };
                updateSettings = await window.electronAPI.updater.updateSettings(newSettings);
                console.log(`Update setting ${key} changed to:`, value);
            } catch (error) {
                console.error(`Failed to save update setting ${key}:`, error);
            }
        }

        // Check for updates manually
        async function checkForUpdatesManually() {
            try {
                const button = event.target.closest('button');
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
                }

                await window.electronAPI.updater.checkForUpdates();
                
                // Update status after check
                setTimeout(async () => {
                    updateStatus = await window.electronAPI.updater.getStatus();
                    updateUpdateInfoUI();
                    
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<i class="fas fa-search"></i> Check for Updates';
                    }
                }, 2000);
            } catch (error) {
                console.error('Failed to check for updates:', error);
                const button = event.target.closest('button');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-search"></i> Check for Updates';
                }
            }
        }

        // Show update history
        function showUpdateHistory() {
            // For now, just show an alert with basic info
            alert('Update History feature coming soon!\\n\\nCurrent Version: ' + (updateStatus?.version || 'Unknown'));
        }

        // Restart to update
        async function restartToUpdate() {
            try {
                const confirmed = confirm('This will restart the application to install the update. Continue?');
                if (confirmed) {
                    await window.electronAPI.updater.quitAndInstall();
                }
            } catch (error) {
                console.error('Failed to restart for update:', error);
            }
        }

        // Listen for update events from main process
        if (window.electronAPI?.updater) {
            window.electronAPI.updater.onUpdateEvent((event, data) => {
                console.log('Update event received:', data.event, data.data);
                
                // Update progress bar if downloading
                if (data.event === 'download-progress') {
                    const progressContainer = document.getElementById('updateProgressContainer');
                    const progressBar = document.getElementById('settingsUpdateProgress');
                    const progressText = document.getElementById('settingsUpdateProgressText');
                    
                    if (progressContainer && progressBar && progressText) {
                        progressContainer.style.display = 'block';
                        progressBar.style.width = `${data.data.percent}%`;
                        progressText.textContent = `${Math.round(data.data.percent)}%`;
                    }
                } else if (data.event === 'update-downloaded') {
                    const progressContainer = document.getElementById('updateProgressContainer');
                    if (progressContainer) {
                        progressContainer.style.display = 'none';
                    }
                }

                // Refresh status
                setTimeout(async () => {
                    try {
                        updateStatus = await window.electronAPI.updater.getStatus();
                        updateUpdateInfoUI();
                    } catch (error) {
                        console.error('Failed to refresh update status:', error);
                    }
                }, 1000);
            });
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initUpdateSettings);
        } else {
            initUpdateSettings();
        }
    </script>

    <!-- Crash Reporting and Monitoring Functions -->
    <script>
        // Monitoring settings management
        let monitoringSettings = {};
        let crashReports = [];
        let monitoringStats = {};

        // Initialize monitoring settings
        async function initMonitoringSettings() {
            try {
                if (window.electronAPI?.crashReporting) {
                    const result = await window.electronAPI.crashReporting.getSettings();
                    if (result.success) {
                        monitoringSettings = result.settings;
                        updateMonitoringSettingsUI();
                    }
                }
                
                // Load monitoring stats
                await loadMonitoringStats();
                
                console.log('Monitoring settings initialized');
            } catch (error) {
                console.error('Failed to initialize monitoring settings:', error);
            }
        }

        // Update monitoring settings UI
        function updateMonitoringSettingsUI() {
            // Update toggle switches
            const settings = {
                'monitoring.crashReporting.enabled': monitoringSettings.enabled || false,
                'monitoring.crashReporting.includeUserData': monitoringSettings.privacy?.collectUserData || false,
                'monitoring.crashReporting.includeSystemInfo': monitoringSettings.privacy?.collectSystemInfo || true,
                'monitoring.crashReporting.includePerformanceData': monitoringSettings.privacy?.collectPerformanceData || true,
                'monitoring.crashReporting.retentionDays': monitoringSettings.retentionDays || '30',
                'monitoring.performance.memoryMonitoring': monitoringSettings.performance?.memoryMonitoring || true,
                'monitoring.performance.cpuMonitoring': monitoringSettings.performance?.cpuMonitoring || true,
                'monitoring.performance.pageLoadTimes': monitoringSettings.performance?.pageLoadTimes || true,
                'monitoring.performance.alerts': monitoringSettings.performance?.alerts || false
            };

            Object.entries(settings).forEach(([key, value]) => {
                const element = document.querySelector(`[data-setting="${key}"]`);
                if (element) {
                    if (element.classList.contains('toggle-switch')) {
                        element.classList.toggle('active', Boolean(value));
                    } else if (element.tagName === 'SELECT') {
                        element.value = value;
                    }
                }
            });

            // Update info displays
            updateMonitoringInfoUI();
        }

        // Update monitoring info UI
        function updateMonitoringInfoUI() {
            const totalReportsEl = document.getElementById('totalCrashReports');
            const lastReportEl = document.getElementById('lastCrashReport');
            const storageUsedEl = document.getElementById('monitoringStorageUsed');

            if (totalReportsEl) {
                totalReportsEl.textContent = crashReports.length || '0';
            }

            if (lastReportEl) {
                const lastReport = crashReports.length > 0 ? crashReports[crashReports.length - 1] : null;
                lastReportEl.textContent = lastReport ? 
                    new Date(lastReport.timestamp).toLocaleDateString() : 'None';
            }

            if (storageUsedEl) {
                const storageSize = monitoringStats.storageSize || 0;
                const sizeInMB = (storageSize / (1024 * 1024)).toFixed(2);
                storageUsedEl.textContent = `${sizeInMB} MB`;
            }
        }

        // Load monitoring statistics
        async function loadMonitoringStats() {
            try {
                if (window.electronAPI?.crashReporting) {
                    const reportsResult = await window.electronAPI.crashReporting.getReports();
                    if (reportsResult.success) {
                        crashReports = reportsResult.reports || [];
                    }

                    const analyticsResult = await window.electronAPI.crashReporting.getAnalytics();
                    if (analyticsResult.success) {
                        monitoringStats = analyticsResult.analytics || {};
                    }
                }
            } catch (error) {
                console.error('Failed to load monitoring stats:', error);
            }
        }

        // Handle monitoring setting changes
        async function onMonitoringSettingChange(element, value) {
            const key = element.getAttribute('data-setting');
            if (!key) return;

            try {
                // Update local settings object
                const keyParts = key.split('.');
                let current = monitoringSettings;
                
                for (let i = 1; i < keyParts.length - 1; i++) {
                    if (!current[keyParts[i]]) {
                        current[keyParts[i]] = {};
                    }
                    current = current[keyParts[i]];
                }
                
                current[keyParts[keyParts.length - 1]] = value;

                // Save to backend
                if (window.electronAPI?.crashReporting) {
                    const result = await window.electronAPI.crashReporting.updateSettings(monitoringSettings);
                    if (!result.success) {
                        console.error('Failed to save monitoring setting:', result.error);
                    }
                }

                console.log(`Monitoring setting ${key} changed to:`, value);
            } catch (error) {
                console.error(`Failed to save monitoring setting ${key}:`, error);
            }
        }

        // Show crash analytics dashboard
        async function showCrashAnalytics() {
            try {
                if (window.crashDashboard) {
                    await window.crashDashboard.showDashboard();
                } else {
                    // Fallback to simple modal if dashboard not available
                    await loadMonitoringStats();
                    
                    const modal = document.createElement('div');
                    modal.className = 'settings-modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3><i class="fas fa-chart-line"></i> Crash Analytics</h3>
                                <button class="modal-close" onclick="this.closest('.settings-modal').remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="analytics-summary">
                                    <div class="stat-card">
                                        <h4>Total Crashes</h4>
                                        <p class="stat-number">${crashReports.length}</p>
                                    </div>
                                    <div class="stat-card">
                                        <h4>Last 7 Days</h4>
                                        <p class="stat-number">${getRecentCrashes(7)}</p>
                                    </div>
                                    <div class="stat-card">
                                        <h4>Most Common</h4>
                                        <p class="stat-text">${getMostCommonCrashType()}</p>
                                    </div>
                                </div>
                                <div class="crash-list">
                                    <h4>Recent Crashes</h4>
                                    ${generateCrashList()}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                }
            } catch (error) {
                console.error('Failed to show crash analytics:', error);
                alert('Failed to load crash analytics. Please try again.');
            }
        }

        // Export crash reports
        async function exportCrashReports() {
            try {
                if (!window.electronAPI?.crashReporting) {
                    alert('Crash reporting API not available');
                    return;
                }

                const result = await window.electronAPI.crashReporting.exportReports();
                if (result.success) {
                    alert(`Crash reports exported to: ${result.path}`);
                } else {
                    alert(`Failed to export crash reports: ${result.error}`);
                }
            } catch (error) {
                console.error('Failed to export crash reports:', error);
                alert('Failed to export crash reports. Please try again.');
            }
        }

        // Clear crash reports
        async function clearCrashReports() {
            try {
                const confirmed = confirm('Are you sure you want to clear all crash reports? This action cannot be undone.');
                if (!confirmed) return;

                if (!window.electronAPI?.crashReporting) {
                    alert('Crash reporting API not available');
                    return;
                }

                const result = await window.electronAPI.crashReporting.clearReports();
                if (result.success) {
                    crashReports = [];
                    updateMonitoringInfoUI();
                    alert('Crash reports cleared successfully');
                } else {
                    alert(`Failed to clear crash reports: ${result.error}`);
                }
            } catch (error) {
                console.error('Failed to clear crash reports:', error);
                alert('Failed to clear crash reports. Please try again.');
            }
        }

        // Test crash reporting (development only)
        async function testCrashReporting() {
            try {
                if (!window.electronAPI?.crashReporting) {
                    alert('Crash reporting API not available');
                    return;
                }

                const confirmed = confirm('This will trigger a test crash to verify the crash reporting system. Continue?');
                if (!confirmed) return;

                const result = await window.electronAPI.crashReporting.testCrash();
                if (result.success) {
                    alert('Test crash triggered successfully');
                } else {
                    alert(`Failed to trigger test crash: ${result.error}`);
                }
            } catch (error) {
                console.error('Failed to test crash reporting:', error);
                alert('Failed to test crash reporting. Please try again.');
            }
        }

        // === NOTIFICATION MANAGEMENT FUNCTIONS ===
        
        // Test notification system
        async function testNotification() {
            try {
                if (!window.electronAPI?.notifications) {
                    alert('Notification API not available');
                    return;
                }

                const notificationTypes = [
                    { type: 'system', title: 'System Test', body: 'Testing system notifications' },
                    { type: 'security', title: 'Security Test', body: 'Testing security alert notifications' },
                    { type: 'update', title: 'Update Test', body: 'Testing update notifications' },
                    { type: 'chat', title: 'Chat Test', body: 'Testing chat message notifications' },
                    { type: 'download', title: 'Download Test', body: 'Testing download completion notifications' },
                    { type: 'success', title: 'Success Test', body: 'Testing success notifications' }
                ];

                const randomNotification = notificationTypes[Math.floor(Math.random() * notificationTypes.length)];
                
                let result;
                switch (randomNotification.type) {
                    case 'system':
                        result = await window.electronAPI.notifications.showSystem(randomNotification.title, randomNotification.body);
                        break;
                    case 'security':
                        result = await window.electronAPI.notifications.showSecurity(randomNotification.title, randomNotification.body);
                        break;
                    case 'update':
                        result = await window.electronAPI.notifications.showUpdate(randomNotification.title, randomNotification.body);
                        break;
                    case 'chat':
                        result = await window.electronAPI.notifications.showChat(randomNotification.title, randomNotification.body);
                        break;
                    case 'download':
                        result = await window.electronAPI.notifications.showDownload(randomNotification.title, randomNotification.body);
                        break;
                    case 'success':
                        result = await window.electronAPI.notifications.showSuccess(randomNotification.title, randomNotification.body);
                        break;
                }

                if (result.success) {
                    console.log('Test notification sent:', result.notificationId);
                } else {
                    alert(`Failed to send test notification: ${result.error}`);
                }
            } catch (error) {
                console.error('Failed to test notification:', error);
                alert('Failed to test notification. Please try again.');
            }
        }

        // Show notification history
        async function showNotificationHistory() {
            try {
                if (!window.electronAPI?.notifications) {
                    alert('Notification API not available');
                    return;
                }

                const result = await window.electronAPI.notifications.getHistory();
                if (result.success) {
                    const history = result.history;
                    
                    if (history.length === 0) {
                        alert('No notification history available');
                        return;
                    }

                    let historyText = 'Notification History:\\n\\n';
                    history.slice(-10).forEach((item, index) => {
                        const date = new Date(item.timestamp).toLocaleString();
                        const status = item.read ? '' : '';
                        historyText += `${status} [${item.category}] ${item.title}\\n   ${item.body}\\n   ${date}\\n\\n`;
                    });

                    alert(historyText);
                } else {
                    alert(`Failed to get notification history: ${result.error}`);
                }
            } catch (error) {
                console.error('Failed to get notification history:', error);
                alert('Failed to get notification history. Please try again.');
            }
        }

        // Clear notification history
        async function clearNotificationHistory() {
            try {
                if (!window.electronAPI?.notifications) {
                    alert('Notification API not available');
                    return;
                }

                const confirmed = confirm('Are you sure you want to clear all notification history?');
                if (!confirmed) return;

                const result = await window.electronAPI.notifications.clearHistory();
                if (result.success) {
                    alert('Notification history cleared successfully');
                    updateNotificationStatus(); // Refresh the status display
                } else {
                    alert(`Failed to clear notification history: ${result.error}`);
                }
            } catch (error) {
                console.error('Failed to clear notification history:', error);
                alert('Failed to clear notification history. Please try again.');
            }
        }

        // Close all active notifications
        async function closeAllNotifications() {
            try {
                if (!window.electronAPI?.notifications) {
                    alert('Notification API not available');
                    return;
                }

                const result = await window.electronAPI.notifications.closeAll();
                if (result.success) {
                    console.log('All notifications closed');
                    updateNotificationStatus(); // Refresh the status display
                } else {
                    alert(`Failed to close notifications: ${result.error}`);
                }
            } catch (error) {
                console.error('Failed to close notifications:', error);
                alert('Failed to close notifications. Please try again.');
            }
        }

        // Update notification status display
        async function updateNotificationStatus() {
            try {
                if (!window.electronAPI?.notifications) return;

                const result = await window.electronAPI.notifications.getInfo();
                if (result.success) {
                    const info = result.info;
                    
                    const supportElement = document.getElementById('notificationSupport');
                    const activeCountElement = document.getElementById('activeNotificationCount');
                    const unreadCountElement = document.getElementById('unreadNotificationCount');

                    if (supportElement) {
                        supportElement.textContent = info.supported ? (info.enabled ? 'Enabled' : 'Supported but disabled') : 'Not supported';
                        supportElement.className = info.supported ? (info.enabled ? 'status-success' : 'status-warning') : 'status-error';
                    }

                    if (activeCountElement) {
                        activeCountElement.textContent = info.activeCount || 0;
                    }

                    if (unreadCountElement) {
                        unreadCountElement.textContent = info.unreadCount || 0;
                    }
                }
            } catch (error) {
                console.error('Failed to update notification status:', error);
            }
        }

        // Load notification settings
        async function loadNotificationSettings() {
            try {
                if (!window.electronAPI?.notifications) return;

                const result = await window.electronAPI.notifications.getSettings();
                if (result.success) {
                    const settings = result.settings;
                    
                    // Update toggle switches
                    updateToggleFromSetting('notificationsEnabledToggle', settings.enabled);
                    updateToggleFromSetting('notificationsSoundToggle', settings.soundEnabled);
                    updateToggleFromSetting('notificationsBadgeToggle', settings.badgeEnabled);
                    updateToggleFromSetting('notificationsPrivacyToggle', settings.privacyMode);
                    
                    // Update select elements
                    const durationSelect = document.getElementById('notificationsDurationSelect');
                    if (durationSelect) durationSelect.value = settings.duration || 5000;
                    
                    const maxConcurrentSelect = document.getElementById('notificationsMaxConcurrentSelect');
                    if (maxConcurrentSelect) maxConcurrentSelect.value = settings.maxConcurrent || 5;
                    
                    // Update category settings
                    if (settings.categories) {
                        Object.keys(settings.categories).forEach(category => {
                            const categorySettings = settings.categories[category];
                            updateToggleFromSetting(`notifications${category.charAt(0).toUpperCase() + category.slice(1)}Toggle`, categorySettings.enabled);
                            updateToggleFromSetting(`notifications${category.charAt(0).toUpperCase() + category.slice(1)}SoundToggle`, categorySettings.sound);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load notification settings:', error);
            }
        }

        // Save notification settings
        async function saveNotificationSettings() {
            try {
                if (!window.electronAPI?.notifications) return;

                const settings = {
                    enabled: getToggleSetting('notificationsEnabledToggle'),
                    soundEnabled: getToggleSetting('notificationsSoundToggle'),
                    badgeEnabled: getToggleSetting('notificationsBadgeToggle'),
                    privacyMode: getToggleSetting('notificationsPrivacyToggle'),
                    duration: parseInt(document.getElementById('notificationsDurationSelect')?.value || 5000),
                    maxConcurrent: parseInt(document.getElementById('notificationsMaxConcurrentSelect')?.value || 5),
                    categories: {
                        system: {
                            enabled: getToggleSetting('notificationsSystemToggle'),
                            sound: getToggleSetting('notificationsSystemSoundToggle')
                        },
                        security: {
                            enabled: getToggleSetting('notificationsSecurityToggle'),
                            sound: getToggleSetting('notificationsSecuritySoundToggle')
                        },
                        updates: {
                            enabled: getToggleSetting('notificationsUpdatesToggle'),
                            sound: getToggleSetting('notificationsUpdatesSoundToggle')
                        },
                        chat: {
                            enabled: getToggleSetting('notificationsChatToggle'),
                            sound: getToggleSetting('notificationsChatSoundToggle')
                        },
                        downloads: {
                            enabled: getToggleSetting('notificationsDownloadsToggle'),
                            sound: getToggleSetting('notificationsDownloadsSoundToggle')
                        },
                        errors: {
                            enabled: getToggleSetting('notificationsErrorsToggle'),
                            sound: getToggleSetting('notificationsErrorsSoundToggle')
                        },
                        achievements: {
                            enabled: getToggleSetting('notificationsAchievementsToggle'),
                            sound: getToggleSetting('notificationsAchievementsSoundToggle')
                        }
                    }
                };

                const result = await window.electronAPI.notifications.updateSettings(settings);
                if (result.success) {
                    console.log('Notification settings saved');
                    updateNotificationStatus(); // Refresh the status display
                } else {
                    console.error('Failed to save notification settings:', result.error);
                }
            } catch (error) {
                console.error('Failed to save notification settings:', error);
            }
        }

        // Helper function to get toggle setting
        function getToggleSetting(toggleId) {
            const toggle = document.getElementById(toggleId);
            return toggle ? toggle.classList.contains('active') : false;
        }

        // Helper function to update toggle from setting
        function updateToggleFromSetting(toggleId, value) {
            const toggle = document.getElementById(toggleId);
            if (toggle) {
                if (value) {
                    toggle.classList.add('active');
                } else {
                    toggle.classList.remove('active');
                }
            }
        }

        // Helper functions for analytics
        function getRecentCrashes(days) {
            const cutoff = Date.now() - (days * 24 * 60 * 60 * 1000);
            return crashReports.filter(report => 
                new Date(report.timestamp).getTime() > cutoff
            ).length;
        }

        function getMostCommonCrashType() {
            if (crashReports.length === 0) return 'None';
            
            const types = {};
            crashReports.forEach(report => {
                const type = report.error?.type || 'Unknown';
                types[type] = (types[type] || 0) + 1;
            });
            
            return Object.entries(types).sort((a, b) => b[1] - a[1])[0][0];
        }

        function generateCrashList() {
            if (crashReports.length === 0) {
                return '<p class="no-data">No crash reports found</p>';
            }
            
            return crashReports.slice(-5).reverse().map(report => `
                <div class="crash-item">
                    <div class="crash-time">${new Date(report.timestamp).toLocaleString()}</div>
                    <div class="crash-type">${report.error?.type || 'Unknown Error'}</div>
                    <div class="crash-message">${(report.error?.message || '').substring(0, 100)}...</div>
                </div>
            `).join('');
        }

        // Initialize notification settings
        async function initNotificationSettings() {
            try {
                // Load notification settings
                await loadNotificationSettings();
                
                // Update notification status
                await updateNotificationStatus();
                
                // Set up periodic status updates
                setInterval(updateNotificationStatus, 30000); // Update every 30 seconds
                
                console.log('Notification settings initialized');
            } catch (error) {
                console.error('Failed to initialize notification settings:', error);
            }
        }

        // Setup event listeners for monitoring settings
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize monitoring settings
            initMonitoringSettings();
            
            // Initialize notification settings
            initNotificationSettings();
            
            // Add event listeners for monitoring toggle switches
            document.querySelectorAll('[data-setting^="monitoring."] .toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    this.classList.toggle('active');
                    const setting = this.getAttribute('data-setting');
                    onMonitoringSettingChange(this, this.classList.contains('active'));
                });
            });
            
            // Add event listeners for notification toggle switches
            document.querySelectorAll('[data-setting^="notifications."] .toggle-switch').forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    this.classList.toggle('active');
                    saveNotificationSettings(); // Auto-save notification settings
                });
            });
            
            // Add event listeners for notification select elements
            const notificationSelects = ['notificationsDurationSelect', 'notificationsMaxConcurrentSelect'];
            notificationSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.addEventListener('change', saveNotificationSettings);
                }
            });

            // Add event listeners for monitoring select elements
            document.querySelectorAll('[data-setting^="monitoring."].setting-select').forEach(select => {
                select.addEventListener('change', function() {
                    onMonitoringSettingChange(this, this.value);
                });
            });
        });

        // Listen for crash reporting events
        if (window.electronAPI?.crashReporting) {
            window.electronAPI.crashReporting.onCrashDetected((event, data) => {
                console.log('Crash detected:', data);
                // Refresh stats after crash
                setTimeout(loadMonitoringStats, 1000);
            });

            window.electronAPI.crashReporting.onReportGenerated((event, data) => {
                console.log('Crash report generated:', data);
                // Refresh stats after report generation
                setTimeout(loadMonitoringStats, 1000);
            });
        }

        // === DEEP LINK MANAGEMENT FUNCTIONS ===

        // Initialize deep link functionality
        async function initializeDeepLinkManagement() {
            try {
                await loadDeepLinkSettings();
                await loadDeepLinkStats();
                checkProtocolRegistration();
            } catch (error) {
                console.error('Failed to initialize deep link management:', error);
            }
        }

        // Load deep link settings
        async function loadDeepLinkSettings() {
            try {
                const result = await window.electronAPI.deepLink.getSettings();
                if (result.success) {
                    const settings = result.settings;
                    updateToggleFromSetting('deeplinkEnabledToggle', settings.enableLogging);
                    updateToggleFromSetting('deeplinkSecurityToggle', settings.enableSecurityValidation);
                    updateToggleFromSetting('deeplinkHistoryToggle', settings.enableHistory);
                    
                    const maxLengthInput = document.getElementById('deeplinkMaxLength');
                    if (maxLengthInput) {
                        maxLengthInput.value = settings.maxUrlLength || 2048;
                    }
                } else {
                    console.error('Failed to load deep link settings:', result.error);
                }
            } catch (error) {
                console.error('Error loading deep link settings:', error);
            }
        }

        // Save deep link settings
        async function saveDeepLinkSettings() {
            try {
                const settings = {
                    enableLogging: getToggleSetting('deeplinkEnabledToggle'),
                    enableSecurityValidation: getToggleSetting('deeplinkSecurityToggle'),
                    enableHistory: getToggleSetting('deeplinkHistoryToggle'),
                    maxUrlLength: parseInt(document.getElementById('deeplinkMaxLength').value) || 2048
                };

                const result = await window.electronAPI.deepLink.updateSettings(settings);
                if (result.success) {
                    showNotification('Deep link settings saved successfully', 'success');
                } else {
                    showNotification('Failed to save deep link settings: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error saving deep link settings:', error);
                showNotification('Error saving deep link settings', 'error');
            }
        }

        // Load deep link statistics
        async function loadDeepLinkStats() {
            try {
                const result = await window.electronAPI.deepLink.getStatistics();
                if (result.success) {
                    const stats = result.statistics;
                    
                    document.getElementById('totalDeepLinks').textContent = stats.totalLinks || 0;
                    document.getElementById('validDeepLinks').textContent = stats.validLinks || 0;
                    document.getElementById('rejectedDeepLinks').textContent = stats.rejectedLinks || 0;
                    
                    const lastActivity = stats.lastActivity ? new Date(stats.lastActivity).toLocaleString() : 'Never';
                    document.getElementById('lastDeepLinkActivity').textContent = lastActivity;
                } else {
                    console.error('Failed to load deep link statistics:', result.error);
                }
            } catch (error) {
                console.error('Error loading deep link statistics:', error);
            }
        }

        // Check protocol registration status
        async function checkProtocolRegistration() {
            try {
                // This would check if the protocol is registered
                const indicator = document.getElementById('protocolIndicator');
                const statusText = document.getElementById('protocolStatusText');
                
                if (indicator && statusText) {
                    indicator.style.color = '#28a745';
                    statusText.textContent = 'mic-browser:// protocol registered';
                }
            } catch (error) {
                console.error('Error checking protocol registration:', error);
                const indicator = document.getElementById('protocolIndicator');
                const statusText = document.getElementById('protocolStatusText');
                
                if (indicator && statusText) {
                    indicator.style.color = '#dc3545';
                    statusText.textContent = 'Protocol registration failed';
                }
            }
        }

        // Test deep link
        async function testDeepLink() {
            try {
                const testUrl = document.getElementById('deeplinkTestUrl').value.trim();
                if (!testUrl) {
                    showNotification('Please enter a test URL', 'warning');
                    return;
                }

                const result = await window.electronAPI.deepLink.handle(testUrl);
                
                const resultDiv = document.getElementById('deeplinkTestResult');
                const outputPre = document.getElementById('deeplinkTestOutput');
                
                if (resultDiv && outputPre) {
                    resultDiv.style.display = 'block';
                    outputPre.textContent = JSON.stringify(result, null, 2);
                    
                    if (result.success) {
                        showNotification('Deep link test successful', 'success');
                    } else {
                        showNotification('Deep link test failed: ' + result.error, 'error');
                    }
                }
            } catch (error) {
                console.error('Error testing deep link:', error);
                showNotification('Error testing deep link', 'error');
            }
        }

        // Generate deep link
        async function generateDeepLink() {
            try {
                // Show dialog for generating deep link
                const action = prompt('Enter action (e.g., search, chat, settings):');
                if (!action) return;

                const params = {};
                
                // Add some default parameters based on action
                switch (action) {
                    case 'search':
                        params.q = prompt('Enter search query:') || 'example';
                        break;
                    case 'chat':
                        params.room = prompt('Enter chat room:') || 'general';
                        break;
                    case 'settings':
                        params.section = prompt('Enter settings section:') || 'general';
                        break;
                    case 'open':
                        params.url = prompt('Enter URL to open:') || 'https://example.com';
                        break;
                }

                const result = await window.electronAPI.deepLink.generate(action, params);
                
                if (result.success) {
                    const testUrlInput = document.getElementById('deeplinkTestUrl');
                    if (testUrlInput) {
                        testUrlInput.value = result.url;
                    }
                    
                    // Copy to clipboard
                    navigator.clipboard.writeText(result.url).then(() => {
                        showNotification('Deep link generated and copied to clipboard', 'success');
                    }).catch(() => {
                        showNotification('Deep link generated: ' + result.url, 'info');
                    });
                } else {
                    showNotification('Failed to generate deep link: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error generating deep link:', error);
                showNotification('Error generating deep link', 'error');
            }
        }

        // Show deep link history
        async function showDeepLinkHistory() {
            try {
                const result = await window.electronAPI.deepLink.getHistory();
                if (result.success) {
                    const historyList = document.getElementById('deeplinkHistoryList');
                    if (historyList) {
                        if (result.history.length === 0) {
                            historyList.innerHTML = '<p class="no-data">No deep link history found</p>';
                        } else {
                            historyList.innerHTML = result.history.slice(0, 10).map(entry => `
                                <div class="history-item ${entry.success ? 'success' : 'failed'}">
                                    <div class="history-url">${entry.url}</div>
                                    <div class="history-time">${new Date(entry.timestamp).toLocaleString()}</div>
                                    <div class="history-action">${entry.parsedUrl?.action || 'Unknown'}</div>
                                    <div class="history-status">${entry.success ? 'Success' : 'Failed'}</div>
                                </div>
                            `).join('');
                        }
                        historyList.style.display = 'block';
                    }
                } else {
                    showNotification('Failed to load deep link history: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error loading deep link history:', error);
                showNotification('Error loading deep link history', 'error');
            }
        }

        // Clear deep link history
        async function clearDeepLinkHistory() {
            try {
                if (!confirm('Are you sure you want to clear all deep link history?')) {
                    return;
                }

                const result = await window.electronAPI.deepLink.clearHistory();
                if (result.success) {
                    showNotification('Deep link history cleared successfully', 'success');
                    await loadDeepLinkStats();
                    
                    // Hide history list
                    const historyList = document.getElementById('deeplinkHistoryList');
                    if (historyList) {
                        historyList.style.display = 'none';
                    }
                } else {
                    showNotification('Failed to clear deep link history: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error clearing deep link history:', error);
                showNotification('Error clearing deep link history', 'error');
            }
        }

        // Add security rule
        async function addSecurityRule() {
            try {
                const ruleInput = document.getElementById('securityRuleInput');
                if (!ruleInput) return;

                const pattern = ruleInput.value.trim();
                if (!pattern) {
                    showNotification('Please enter a security rule pattern', 'warning');
                    return;
                }

                const result = await window.electronAPI.deepLink.addSecurityRule(pattern);
                if (result.success) {
                    showNotification('Security rule added successfully', 'success');
                    ruleInput.value = '';
                    loadSecurityRules();
                } else {
                    showNotification('Failed to add security rule: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error adding security rule:', error);
                showNotification('Error adding security rule', 'error');
            }
        }

        // Load security rules (placeholder - would need backend support)
        function loadSecurityRules() {
            const rulesList = document.getElementById('securityRulesList');
            if (rulesList) {
                // This would load actual rules from the backend
                rulesList.innerHTML = '<p class="info-text">Security rules are active. Patterns like JavaScript:, data:, and file: are automatically blocked.</p>';
            }
        }

        // Listen for deep link events
        if (window.electronAPI?.deepLink) {
            // Set up event listeners for various deep link actions
            window.electronAPI.deepLink.onNavigateToChat((data) => {
                console.log('Deep link: Navigate to chat:', data);
                // Handle chat navigation
            });

            window.electronAPI.deepLink.onPerformSearch((data) => {
                console.log('Deep link: Perform search:', data);
                // Handle search
                if (data.query) {
                    // Trigger search functionality
                    showNotification(`Searching for: ${data.query}`, 'info');
                }
            });

            window.electronAPI.deepLink.onOpenSettings((section) => {
                console.log('Deep link: Open settings:', section);
                // Open settings tab
                if (section) {
                    switchSettingsTab(section);
                }
            });

            window.electronAPI.deepLink.onTriggerOCR((data) => {
                console.log('Deep link: Trigger OCR:', data);
                // Handle OCR trigger
                showNotification('OCR functionality triggered via deep link', 'info');
            });

            window.electronAPI.deepLink.onHandleTransfer((data) => {
                console.log('Deep link: Handle transfer:', data);
                // Handle transfer
                showNotification('Data transfer triggered via deep link', 'info');
            });

            window.electronAPI.deepLink.onHandleAuth((data) => {
                console.log('Deep link: Handle auth:', data);
                // Handle authentication
                showNotification('Authentication triggered via deep link', 'info');
            });

            window.electronAPI.deepLink.onCustomRoute((data) => {
                console.log('Deep link: Custom route:', data);
                // Handle custom routes
                showNotification(`Custom deep link route: ${data.action}`, 'info');
            });
        }

        // Initialize deep link event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for deep link toggles
            const deeplinkToggles = ['deeplinkEnabledToggle', 'deeplinkSecurityToggle', 'deeplinkHistoryToggle'];
            deeplinkToggles.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.addEventListener('click', saveDeepLinkSettings);
                }
            });

            // Add event listener for max length input
            const maxLengthInput = document.getElementById('deeplinkMaxLength');
            if (maxLengthInput) {
                maxLengthInput.addEventListener('change', saveDeepLinkSettings);
            }

            // Add event listener for security rule input
            const securityRuleInput = document.getElementById('securityRuleInput');
            if (securityRuleInput) {
                securityRuleInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addSecurityRule();
                    }
                });
            }

            // Initialize deep link management if on the deep link tab
            if (document.querySelector('.settings-tab[data-tab="deeplink"]')) {
                initializeDeepLinkManagement();
            }
        });

        // === SYSTEM TRAY MANAGEMENT FUNCTIONS ===

        // Initialize system tray functionality
        async function initializeSystemTrayManagement() {
            try {
                await loadSystemTraySettings();
                await loadSystemTrayStatistics();
                checkSystemTraySupport();
            } catch (error) {
                console.error('Failed to initialize system tray management:', error);
            }
        }

        // Load system tray settings
        async function loadSystemTraySettings() {
            try {
                const result = await window.electronAPI.systemTray.getSettings();
                if (result.success) {
                    const settings = result.settings;
                    updateToggleFromSetting('systemTrayEnabledToggle', settings.enabled);
                    updateToggleFromSetting('minimizeToTrayToggle', settings.minimizeToTray);
                    updateToggleFromSetting('closeToTrayToggle', settings.closeToTray);
                    updateToggleFromSetting('startMinimizedToggle', settings.startMinimized);
                    updateToggleFromSetting('trayNotificationsToggle', settings.showNotifications);
                    updateToggleFromSetting('quickActionsToggle', settings.enableQuickActions);
                    
                    const timeoutSelect = document.getElementById('notificationTimeoutSelect');
                    if (timeoutSelect) {
                        timeoutSelect.value = settings.notificationTimeout || 5000;
                    }
                } else {
                    console.error('Failed to load system tray settings:', result.error);
                }
            } catch (error) {
                console.error('Error loading system tray settings:', error);
            }
        }

        // Save system tray settings
        async function saveSystemTraySettings() {
            try {
                const settings = {
                    enabled: getToggleSetting('systemTrayEnabledToggle'),
                    minimizeToTray: getToggleSetting('minimizeToTrayToggle'),
                    closeToTray: getToggleSetting('closeToTrayToggle'),
                    startMinimized: getToggleSetting('startMinimizedToggle'),
                    showNotifications: getToggleSetting('trayNotificationsToggle'),
                    enableQuickActions: getToggleSetting('quickActionsToggle'),
                    notificationTimeout: parseInt(document.getElementById('notificationTimeoutSelect').value) || 5000,
                    notifications: {
                        info: document.querySelector('[data-setting="systemTray.notifications.info"]').checked,
                        warning: document.querySelector('[data-setting="systemTray.notifications.warning"]').checked,
                        error: document.querySelector('[data-setting="systemTray.notifications.error"]').checked,
                        success: document.querySelector('[data-setting="systemTray.notifications.success"]').checked
                    },
                    quickActions: {
                        newChat: document.querySelector('[data-setting="systemTray.quickActions.newChat"]').checked,
                        openOcr: document.querySelector('[data-setting="systemTray.quickActions.openOcr"]').checked,
                        openTransfer: document.querySelector('[data-setting="systemTray.quickActions.openTransfer"]').checked,
                        openSettings: document.querySelector('[data-setting="systemTray.quickActions.openSettings"]').checked,
                        viewAnalytics: document.querySelector('[data-setting="systemTray.quickActions.viewAnalytics"]').checked
                    }
                };

                const result = await window.electronAPI.systemTray.updateSettings(settings);
                if (result.success) {
                    showNotification('System tray settings saved successfully', 'success');
                } else {
                    showNotification('Failed to save system tray settings: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error saving system tray settings:', error);
                showNotification('Error saving system tray settings', 'error');
            }
        }

        // Load system tray statistics
        async function loadSystemTrayStatistics() {
            try {
                const result = await window.electronAPI.systemTray.getStatistics();
                if (result.success) {
                    const stats = result.statistics;
                    
                    document.getElementById('totalTrayActions').textContent = stats.totalActions || 0;
                    document.getElementById('trayNotificationsSent').textContent = stats.notificationsSent || 0;
                    document.getElementById('trayMinimizeCount').textContent = stats.minimizeCount || 0;
                    document.getElementById('trayRestoreCount').textContent = stats.restoreCount || 0;
                } else {
                    console.error('Failed to load system tray statistics:', result.error);
                }
            } catch (error) {
                console.error('Error loading system tray statistics:', error);
            }
        }

        // Check system tray support
        async function checkSystemTraySupport() {
            try {
                const result = await window.electronAPI.systemTray.isSupported();
                const supportStatus = document.getElementById('systemTraySupport');
                
                if (supportStatus) {
                    if (result.supported) {
                        supportStatus.innerHTML = '<span style="color: #28a745;"> System Tray Supported</span>';
                    } else {
                        supportStatus.innerHTML = '<span style="color: #dc3545;"> System Tray Not Supported</span>';
                    }
                }
            } catch (error) {
                console.error('Error checking system tray support:', error);
            }
        }

        // Test tray notification
        async function testTrayNotification() {
            try {
                const title = document.getElementById('testNotificationTitle').value || 'Test Notification';
                const message = document.getElementById('testNotificationMessage').value || 'This is a test notification';
                const type = document.getElementById('testNotificationType').value || 'info';

                const result = await window.electronAPI.systemTray.showNotification(title, message, type);
                if (result.success) {
                    showNotification('Test notification sent successfully', 'success');
                } else {
                    showNotification('Failed to send test notification: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error testing tray notification:', error);
                showNotification('Error testing tray notification', 'error');
            }
        }

        // Test tray tooltip
        async function testTrayTooltip() {
            try {
                const tooltip = 'MIC Browser Ultimate - Test Tooltip';
                const result = await window.electronAPI.systemTray.updateTooltip(tooltip);
                if (result.success) {
                    showNotification('Tray tooltip updated successfully', 'success');
                } else {
                    showNotification('Failed to update tray tooltip: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error testing tray tooltip:', error);
                showNotification('Error testing tray tooltip', 'error');
            }
        }

        // Toggle tray visibility
        async function toggleTrayVisibility() {
            try {
                // This would toggle the tray icon visibility
                showNotification('Tray visibility toggled', 'info');
            } catch (error) {
                console.error('Error toggling tray visibility:', error);
                showNotification('Error toggling tray visibility', 'error');
            }
        }

        // Refresh tray statistics
        async function refreshTrayStatistics() {
            try {
                await loadSystemTrayStatistics();
                showNotification('System tray statistics refreshed', 'success');
            } catch (error) {
                console.error('Error refreshing tray statistics:', error);
                showNotification('Error refreshing tray statistics', 'error');
            }
        }

        // Clear tray statistics
        async function clearTrayStatistics() {
            try {
                if (!confirm('Are you sure you want to clear all system tray statistics?')) {
                    return;
                }

                // This would clear the statistics in the backend
                showNotification('System tray statistics cleared', 'success');
                await loadSystemTrayStatistics();
            } catch (error) {
                console.error('Error clearing tray statistics:', error);
                showNotification('Error clearing tray statistics', 'error');
            }
        }

        // Listen for system tray events
        if (window.electronAPI?.systemTray) {
            // Set up event listeners for system tray actions
            window.electronAPI.systemTray.onQuickAction((action) => {
                console.log('System tray quick action:', action);
                
                switch (action) {
                    case 'newChat':
                        switchSidebarPanel('chatPanel');
                        break;
                    case 'openOcr':
                        showDocumentScanner();
                        break;
                    case 'openTransfer':
                        showDataTransferModal();
                        break;
                    case 'openSettings':
                        switchSidebarPanel('settingsPanel');
                        break;
                    case 'viewAnalytics':
                        switchSidebarPanel('analyticsPanel');
                        break;
                    default:
                        showNotification(`Unknown quick action: ${action}`, 'warning');
                }
            });

            window.electronAPI.systemTray.onShowStatistics(() => {
                console.log('System tray: Show statistics requested');
                switchSidebarPanel('settingsPanel');
                switchSettingsTab('systemtray');
            });
        }

        // Initialize system tray event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for system tray toggles
            const systemTrayToggles = [
                'systemTrayEnabledToggle', 'minimizeToTrayToggle', 'closeToTrayToggle', 
                'startMinimizedToggle', 'trayNotificationsToggle', 'quickActionsToggle'
            ];
            systemTrayToggles.forEach(toggleId => {
                const toggle = document.getElementById(toggleId);
                if (toggle) {
                    toggle.addEventListener('click', saveSystemTraySettings);
                }
            });

            // Add event listener for notification timeout select
            const timeoutSelect = document.getElementById('notificationTimeoutSelect');
            if (timeoutSelect) {
                timeoutSelect.addEventListener('change', saveSystemTraySettings);
            }

            // Add event listeners for checkboxes
            const checkboxes = document.querySelectorAll('[data-setting^="systemTray."]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', saveSystemTraySettings);
            });

            // Initialize system tray management if on the system tray tab
            if (document.querySelector('.settings-tab[data-tab="systemtray"]')) {
                initializeSystemTrayManagement();
            }
        });
    </script>
    </script>

    <!-- Crash Analytics Dashboard -->
    <script src="CrashAnalyticsDashboard.js"></script>

    <!-- Adaptive UI Client -->
    <script src="adaptive-ui-client.js"></script>
    
    <!-- Plugin Manager UI -->
    <script src="PluginManagerUI.js"></script>
    
    <!-- Update Notification UI -->
    <script src="UpdateNotificationUI.js"></script>
    
    <!-- Auto-Updater Demo (Development Only) -->
    <script src="demo-auto-updater.js"></script>
    
    <!-- Debug Console (Development Only) -->
    <script src="DebugConsoleManager.js"></script>
    
    <!-- Breakpoint Manager (Development Only) -->
    <script src="BreakpointManager.js"></script>
    
    <!-- Performance Monitor (Development Only) -->
    <script src="PerformanceMonitor.js"></script>
    
    <!-- Auto-Initialize Debug Systems -->
    <script src="debug-systems-init.js"></script>
</body>
</html>